<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WB-Irrigation — Логи</title>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <style>
    body{font-family:sans-serif;margin:0;background:#f4f6f8;color:#333}
    header,footer{background:#263238;color:#fff;padding:1rem;text-align:center}
    nav{background:#37474f;display:flex;justify-content:center;padding:.5rem 0}
    nav a{color:#fff;text-decoration:none;margin:0 1rem;font-weight:700;font-size:.95rem}
    nav a.active{border-bottom:2px solid #fff}
    main{padding:2rem;max-width:1200px;margin:auto}
    .filter-bar{background:#fff;padding:1rem;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:1rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
    .filter-bar label{font-size:.9rem;display:flex;align-items:center;gap:.5rem}
    .filter-bar input[type=date], .filter-bar select{padding:.4rem;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
    .filter-bar button{padding:.5rem 1rem;background:#2196f3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.9rem}
    .export-btn{background:#4caf50;color:#fff;margin-left:auto}
    table{width:100%;border-collapse:collapse;background:#fff;font-size:.9rem}
    th,td{border:1px solid #ccc;padding:.5rem;text-align:left}
    th{background:#e0e0e0}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header><h1>WB-Irrigation — Логи</h1></header>
  <nav>
    <a href="status.html">Статус</a>
    <a href="zones.html">Зоны</a>
    <a href="programs.html">Программы</a>
    <a href="logs.html" class="active">Логи</a>
    <a href="water.html">Расход</a>
  </nav>
  <main>
    <div class="filter-bar">
      <label>С: <input type="date" id="fromDate"></label>
      <label>По: <input type="date" id="toDate"></label>
      <label>Тип события: <select id="eventType">
        <option value="">Все</option>
        <option value="zone_on">zone_on</option>
        <option value="zone_off">zone_off</option>
        <option value="prog_edit">prog_edit</option>
        <option value="mqtt_error">mqtt_error</option>
      </select></label>
      <button onclick="applyFilter()">Фильтровать</button>
      <button class="export-btn" onclick="exportCSV()">Экспорт CSV</button>
    </div>
    <table>
      <thead>
        <tr><th class="nowrap">Время</th><th>Тип</th><th>Детали</th></tr>
      </thead>
      <tbody id="log-body"></tbody>
    </table>
  </main>
  <footer>Статус системы актуален на 01.05.2025 00:00</footer>
  <script>
    // Демо-страница логов: генерация записей, безопасный рендер и экспорт
    const logs = [];
    for(let i=0;i<50;i++){
      const t=new Date(Date.now()-i*60000).toISOString().replace('T',' ').split('.')[0];
      const types=['zone_on','zone_off','prog_edit','mqtt_error'];
      const type=types[i%types.length];
      const details= type==='mqtt_error'? 'lost connection': type==='zone_on'?`{"zone":${(i%48)+1},"user":"ui"}`: type==='zone_off'?`{"zone":${(i%48)+1},"reason":"timer"}`:`{"prog":${(i%5)+1},"field":"start","old":"06:00","new":"05:30"}`;
      logs.push({time:t,type,details});
    }
    // Безопасный рендер: исключаем XSS, используем textContent для деталей
    function renderLogs(list){
      const tbody=document.getElementById('log-body');
      tbody.innerHTML='';
      list.forEach(l=>{
        const tr=document.createElement('tr');
        const tdTime=document.createElement('td');
        tdTime.className='nowrap';
        tdTime.textContent=l.time;
        const tdType=document.createElement('td');
        tdType.textContent=l.type;
        const tdDetails=document.createElement('td');
        const pre=document.createElement('pre');
        pre.style.margin='0';
        pre.style.fontFamily='monospace';
        pre.textContent=String(l.details);
        tdDetails.appendChild(pre);
        tr.appendChild(tdTime);
        tr.appendChild(tdType);
        tr.appendChild(tdDetails);
        tbody.appendChild(tr);
      });
    }
    renderLogs(logs);
    function applyFilter(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      const type=document.getElementById('eventType').value;
      let filtered=logs;
      if(from) filtered=filtered.filter(l=>l.time>=from);
      if(to) filtered=filtered.filter(l=>l.time<=to+' 23:59:59');
      if(type) filtered=filtered.filter(l=>l.type===type);
      renderLogs(filtered);
    }
    // Экспорт CSV с защитой от формульной инъекции (Excel/Sheets)
    function exportCSV(){
      const sanitize=(value)=>{
        let s=String(value).replace(/"/g,'""');
        if(/^[=+\-@]/.test(s)) s="'"+s; // префикс предотвращает выполнение формул
        return s;
      };
      const rows=[["time","type","details"],...logs.map(l=>[l.time,l.type,`"${sanitize(l.details)}"`])];
      const csv=rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob),a=document.createElement('a');
      a.href=url;a.download='logs.csv';a.click();URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>