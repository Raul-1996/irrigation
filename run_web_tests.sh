#!/bin/bash

echo "üß™ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Ç–µ—Å—Ç–æ–≤ WB-Irrigation..."
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: source venv/bin/activate"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤–µ–±-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –≤–µ–±-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
pip install selenium==4.15.2 webdriver-manager==4.0.1 pytest==7.4.3 pytest-selenium==4.0.1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Chrome —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v google-chrome &> /dev/null && ! command -v chromium-browser &> /dev/null; then
    echo "‚ö†Ô∏è  Chrome –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Chrome –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-—Ç–µ—Å—Ç–æ–≤."
    echo "–ù–∞ macOS: brew install --cask google-chrome"
    echo "–ù–∞ Ubuntu: sudo apt install chromium-browser"
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Flask
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Flask..."
pkill -f "python run.py" 2>/dev/null || true
sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Ç–µ—Å—Ç—ã
echo "üöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Ç–µ—Å—Ç–æ–≤..."
echo "=================================================="

python web_tests.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ $? -eq 0 ]; then
    echo "=================================================="
    echo "‚úÖ –í—Å–µ –≤–µ–±-—Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "=================================================="
    echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ–±-—Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏"
    exit 1
fi
