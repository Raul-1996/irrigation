# Тесты WB-Irrigation

В этом каталоге находится весь тестовый набор проекта: модульные тесты (pytest), простые и реалистичные веб‑тесты, а также скрипты запуска.

## Что проверяем

- API зон, групп, программ: CRUD, последовательный полив, исключение конфликтов
- Таймер полива зоны: `watering_start_time`, авто‑стоп, обратный отсчет
- Отложенный полив (postpone/cancel), аварийная остановка/возврат
- Фото зон: загрузка/отдача/удаление
- MQTT: CRUD серверов, публикация ON/OFF, проба/сканирование топиков
- UI (веб‑тесты): навигация, старт/стоп зоны и группы, статусы и ошибки

## Структура

- `tests_pytest/` — pytest‑набор (быстрые интеграционные тесты API)
- `web_tests_*.py` — Selenium‑тесты интерфейса (простые/реалистичные)
- `run_all_tests.py` — агрегатор запуска модульных и веб‑тестов
- `setup_selenium.py` — установка/проверка Selenium и драйверов
- Различные отчеты (`TESTING_*.md`) — результаты тестовых прогонов

## Требования

- Запущен сервер WB‑Irrigation на `http://127.0.0.1:8080`
- Запущен MQTT брокер на `127.0.0.1:1883` (без авторизации по умолчанию)
- Активирована виртуальная среда: `source venv/bin/activate`

## Быстрый старт

Запустите проверку окружения и полный прогон тестов:

```bash
./start_tests.sh
```

Скрипт:
- проверит доступность веб‑сервера `/api/status`;
- проверит доступность MQTT (paho‑mqtt connect);
- запустит pytest‑набор;
- запустит интегрированный раннер `tools/tests/run_all_tests.py`;
- выведет общую сводку.

## Запуск по частям

- Pytest: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`
- Все тесты (агрегатор): `python tools/tests/run_all_tests.py`
- Простые веб‑тесты: `python tools/tests/web_tests_simple.py`
- Реалистичные веб‑тесты: `python tools/tests/web_tests_realistic.py`

## Замечания

- Реалистичные тесты требуют установленного Chrome/Chromium и совместимого драйвера. См. `tools/tests/setup_selenium.py`.
- В процессе веб‑тестов сервер должен быть запущен (см. `./start.sh`).
- Для стабильности UI‑тестов используется явная инициализация планировщика через `/api/scheduler/init` и логин админом (пароль 8888 по умолчанию).


