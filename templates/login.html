<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход — WB‑Irrigation</title>
    <style>
        :root {
            --bg: #f4f6fb;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --primary: #1976d2;
            --primary-pressed: #155fa8;
            --success: #2e7d32;
            --danger: #d32f2f;
            --ring: rgba(25,118,210,.25);
            --border: #d1d5db;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); }
        .container { max-width: 380px; margin: 9vh auto; background: var(--card); border-radius: 14px; box-shadow: 0 12px 36px rgba(0,0,0,.08); padding: 26px; }
        h1 { margin: 0 0 8px; font-size: 22px; text-align: center; font-weight: 700; }
        .subtitle { color: var(--muted); font-size: 14px; text-align: center; margin-bottom: 22px; }
        label { display: block; font-size: 14px; color: var(--text); margin: 12px 0 6px; }
        .input-group { position: relative; }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 14px 44px 14px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: box-shadow .15s ease, border-color .15s ease;
            background: #fff;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }
        .toggle-visibility {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; color: #455a64; font-size: 13px; padding: 4px 6px; border-radius: 6px;
        }
        .toggle-visibility:focus { outline: none; box-shadow: 0 0 0 3px var(--ring); }
        .caps-warning { display: none; color: #e65100; font-size: 12px; margin-top: 6px; }
        .btn { width: 100%; margin-top: 14px; padding: 12px 14px; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-pressed); }
        .btn:disabled { opacity: .7; cursor: default; }
        .btn-secondary { background: #eef2f7; color: #374151; }
        .error { color: var(--danger); font-size: 13px; margin-top: 12px; text-align: center; min-height: 1.2em; }
    </style>
    <script>
        function setLoading(isLoading) {
            const submitBtn = document.getElementById('submitBtn');
            if (!submitBtn) return;
            submitBtn.disabled = isLoading;
            if (isLoading) {
                submitBtn.dataset.prev = submitBtn.textContent;
                submitBtn.textContent = 'Вхожу…';
            } else {
                if (submitBtn.dataset.prev) submitBtn.textContent = submitBtn.dataset.prev;
            }
        }
        async function onSubmit(event) {
            event.preventDefault();
            const password = document.getElementById('password').value.trim();
            const errorEl = document.getElementById('error');
            errorEl.textContent = '';
            if (password.length < 4) {
                errorEl.textContent = 'Минимальная длина пароля — 4 символа.';
                return;
            }
            setLoading(true);
            try {
                const resp = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (resp.ok) {
                    window.location.href = '/';
                    return;
                }
                const data = await resp.json().catch(() => ({}));
                errorEl.textContent = (data && data.message) || 'Ошибка входа';
            } catch (e) {
                errorEl.textContent = 'Ошибка сети';
            } finally {
                setLoading(false);
            }
        }
        function toggleVisibility() {
            const passwordEl = document.getElementById('password');
            const toggleBtn = document.getElementById('toggleBtn');
            const isPwd = passwordEl.type === 'password';
            passwordEl.type = isPwd ? 'text' : 'password';
            toggleBtn.textContent = isPwd ? 'Скрыть' : 'Показать';
            toggleBtn.setAttribute('aria-label', isPwd ? 'Скрыть пароль' : 'Показать пароль');
            passwordEl.focus();
        }
        function handleCaps(e) {
            const capsEl = document.getElementById('caps');
            const caps = e.getModifierState && e.getModifierState('CapsLock');
            capsEl.style.display = caps ? 'block' : 'none';
        }
    </script>
    </head>
<body>
    <div class="container">
        <h1>Вход</h1>
        <div class="subtitle">WB‑Irrigation</div>
        <form onsubmit="onSubmit(event)">
            <label for="password">Пароль</label>
            <div class="input-group">
                <input id="password" name="password" type="password" placeholder="Введите пароль" autocomplete="current-password" minlength="4" required autofocus onkeyup="handleCaps(event)" />
                <button type="button" id="toggleBtn" class="toggle-visibility" aria-controls="password" aria-label="Показать пароль" onclick="toggleVisibility()">Показать</button>
            </div>
            <div id="caps" class="caps-warning">Включён Caps Lock</div>
            <button type="submit" class="btn btn-primary" id="submitBtn">Войти</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/?guest=1'">Продолжить без пароля</button>
            <div id="error" class="error" role="status" aria-live="polite"></div>
        </form>
    </div>
</body>
</html>


