{% extends "base.html" %}

{% block title %}Зоны и группы{% endblock %}
{% block page_title %}Зоны и группы{% endblock %}

{% block extra_css %}
<style>
    .zones-container {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .zones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .zones-count {
        background: var(--primary-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .bulk-actions h4 {
        margin: 0 0 0.5rem 0;
        color: #495057;
    }
    
    .bulk-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        align-items: end;
    }
    
    .bulk-form select,
    .bulk-form input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .bulk-form button {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .bulk-form button:hover {
        background: #1976d2;
    }
    
    .save-all-btn {
        background: var(--success-color) !important;
        font-weight: bold;
        padding: 0.6rem 1.2rem !important;
    }
    
    .save-all-btn:hover {
        background: #45a049 !important;
    }
    
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .zones-table th,
    .zones-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .zones-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .zones-table th:hover {
        background: #e9ecef;
    }
    
    .zones-table th.sortable::after {
        content: '↕';
        position: absolute;
        right: 0.5rem;
        opacity: 0.5;
    }
    
    .zones-table th.sort-asc::after {
        content: '↑';
        opacity: 1;
    }
    
    .zones-table th.sort-desc::after {
        content: '↓';
        opacity: 1;
    }
    
    .zone-row {
        transition: var(--transition);
    }
    
    .zone-row:hover {
        background: #f8f9fa;
    }
    
    .zone-row.modified {
        background: #fff3cd;
        border-left: 3px solid var(--warning-color);
    }
    
    .zone-icon {
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-icon:hover {
        transform: scale(1.2);
    }
    
    .zone-name {
        font-weight: 500;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
    }
    
    .zone-name:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-duration {
        font-family: 'Courier New', monospace;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
        width: 60px;
    }
    
    .zone-duration:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-group {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid var(--primary-color);
        transition: var(--transition);
    }
    
    .zone-group:focus {
        border-color: #1976d2;
        outline: none;
    }
    
    .zone-actions {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }
    
    .zone-actions button {
        padding: 0.3rem 0.6rem;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .zone-actions .edit-btn {
        background: var(--info-color);
        color: white;
    }
    
    .zone-actions .save-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .delete-btn {
        background: var(--danger-color);
        color: white;
    }
    
    .zone-actions .start-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .stop-btn {
        background: var(--warning-color);
        color: white;
    }
    
    .zone-actions button:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .zone-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Стили для фотографий */
    .zone-photo {
        position: relative;
        display: inline-block;
    }
    
    .zone-photo img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        object-fit: cover;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo img:hover {
        transform: scale(1.1);
        border-color: var(--primary-color);
    }
    
    .zone-photo .no-photo {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #6c757d;
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo .no-photo:hover {
        border-color: var(--primary-color);
        background: #e3f2fd;
        color: var(--primary-color);
    }
    
    .photo-upload-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-upload-btn:hover {
        background: #1976d2;
    }
    
    .photo-delete-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-delete-btn:hover {
        background: #d32f2f;
    }
    
    .photo-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .photo-modal-content {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    
    .photo-modal img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .photo-modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .photo-modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .photo-modal-actions .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .photo-modal-actions .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .photo-modal-actions button:hover {
        opacity: 0.8;
    }
    
    .groups-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .groups-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 240px));
        gap: 0.6rem;
        justify-content: start;
    }
    
    .group-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.6rem;
        border: 1px solid #e9ecef;
        transition: var(--transition);
        max-width: 280px;
        min-height: 110px;
    }
    
    .group-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }
    
    /* Delete cross button */
    .group-card .delete-btn {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #fff;
        color: #b71c1c;
        border: 1px solid #e0e0e0;
        border-radius: 50%;
        font-size: 14px;
        line-height: 14px;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .group-card .delete-btn:hover {
        color: #fff;
        background: #d32f2f;
        border-color: #b71c1c;
    }
    
    .group-card h4 {
        margin: 0 0 0.4rem 0;
        color: #333 !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }
    
    .group-name {
        font-weight: 600;
    }
    
    .group-zone-count {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }
    
    .group-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .group-edit-btn {
        background: var(--info-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .group-edit-btn:hover {
        background: #1976d2;
    }
    
    .zones-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .zone-status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        transition: background-color 0.3s ease;
    }
    
    .zone-status-indicator.active {
        background-color: #4caf50;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
    }
    
    .zone-status-indicator.inactive {
        background-color: #ccc;
    }
    
    /* Модальные окна */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
    }
    
    .close {
        color: #aaa;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .form-group label {
        font-weight: 500;
        color: #495057;
    }
    
    .form-group input,
    .form-group select {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }
    
    .modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .modal-actions button:hover {
        opacity: 0.8;
    }
    
    /* Адаптивность */
    @media (max-width: 768px) {
        .zones-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .bulk-form {
            grid-template-columns: 1fr;
        }
        
        .zones-table {
            font-size: 0.8rem;
        }
        
        .zones-table th,
        .zones-table td {
            padding: 0.3rem;
        }
        
        .zone-actions {
            flex-direction: column;
        }
        
        .groups-grid {
            grid-template-columns: 1fr;
        }
    }

    .zone-selection {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .zone-selection button {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }
    
    #selected-count {
        font-size: 0.9rem;
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .zone-checkbox {
        margin-right: 0.5rem;
        transform: scale(1.2);
    }
    
    .icon-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .icon-dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 8px;
        padding: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .icon-dropdown-content.show {
        display: block;
    }
    
    .icon-option {
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .icon-option:hover {
        background-color: #f8f9fa;
    }
    
    .icon-option.selected {
        background-color: var(--primary-color);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Секция групп -->
<div class="groups-section">
    <div class="groups-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h3 style="margin:0;">Группы зон</h3>
        <div class="groups-actions" style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-success" onclick="showAddGroupModal()">
                ➕ Добавить группу
            </button>
        </div>
    </div>
    <div class="groups-grid" id="groups-grid" style="margin-top:8px;">
        <!-- Группы будут загружены динамически -->
    </div>
</div>

<!-- Секция зон -->
<div class="zones-container">
    <div class="zones-header">
        <h3>🌿 Зоны полива (<span id="zones-count">0</span>)</h3>
        <div class="zones-actions">
            <button class="group-edit-btn" onclick="exportZonesCSV()">📤 Экспорт CSV</button>
            <button class="group-edit-btn" onclick="importZonesCSV()">📥 Импорт CSV</button>
            <button class="group-edit-btn" onclick="showZoneModal()">➕ Добавить зону</button>
        </div>
    </div>
    
    <!-- Массовые действия -->
    <div class="bulk-actions">
        <h4>⚡ Массовые действия</h4>
        <div class="bulk-form">
            <div class="form-group">
                <label>Выбрать зоны:</label>
                <div class="zone-selection">
                    <button type="button" onclick="selectAllZones()" class="btn-secondary">Выбрать все</button>
                    <button type="button" onclick="deselectAllZones()" class="btn-secondary">Снять выбор</button>
                    <span id="selected-count">Выбрано: 0 зон</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Действие:</label>
                <select id="bulkAction" onchange="updateBulkForm()">
                    <option value="">Выберите действие...</option>
                    <option value="group">Изменить группу</option>
                    <option value="icon">Изменить иконку</option>
                    <option value="duration">Изменить время</option>
                    <option value="delete">Удалить зоны</option>
                    <option value="mqtt">Сменить MQTT сервер</option>
                    <option value="delphoto">Удалить фото</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkGroupSelect" style="display: none;">
                <label>Новая группа:</label>
                <select id="bulkGroup">
                    <!-- Группы будут загружены динамически -->
                </select>
            </div>
            
            <div class="form-group" id="bulkIconSelect" style="display: none;">
                <label>Новая иконка:</label>
                <select id="bulkIcon">
                    <option value="🌿">🌿 Трава</option>
                    <option value="🌳">🌳 Дерево</option>
                    <option value="🌺">🌺 Цветок</option>
                    <option value="🌻">🌻 Подсолнух</option>
                    <option value="🌹">🌹 Роза</option>
                    <option value="🌸">🌸 Сакура</option>
                    <option value="🌼">🌼 Ромашка</option>
                    <option value="🌷">🌷 Тюльпан</option>
                    <option value="🌱">🌱 Росток</option>
                    <option value="🌲">🌲 Ель</option>
                    <option value="🌴">🌴 Пальма</option>
                    <option value="🌵">🌵 Кактус</option>
                    <option value="🍀">🍀 Клевер</option>
                    <option value="🌾">🌾 Пшеница</option>
                    <option value="🌽">🌽 Кукуруза</option>
                    <option value="🥕">🥕 Морковь</option>
                    <option value="🍅">🍅 Помидор</option>
                    <option value="🥬">🥬 Салат</option>
                    <option value="🧱">🧱 Кирпич</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkDurationSelect" style="display: none;">
                <label>Новое время (мин):</label>
                <input type="number" id="bulkDuration" min="1" max="120" value="10">
            </div>
            
            <div class="form-group" id="bulkMqttSelect" style="display: none;">
                <label>MQTT сервер:</label>
                <select id="bulkMqtt"></select>
            </div>
            
            <button onclick="applyBulkAction()" class="save-all-btn">💾 Применить к выбранным</button>
        </div>
    </div>
    
    <!-- Таблица зон -->
    <table class="zones-table" id="zones-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th class="sortable" onclick="sortTable(0)">№ Зоны</th>
                <th class="sortable" onclick="sortTable(1)">🎯 Иконка</th>
                <th class="sortable" onclick="sortTable(2)">📝 Название</th>
                <th class="sortable" onclick="sortTable(3)">⏱️ Время</th>
                <th class="sortable" onclick="sortTable(4)">🏷️ Группа</th>
                <th class="sortable" onclick="sortTable(5)">📡 MQTT Topic</th>
                <th>🖧 MQTT Server</th>
                <th>📸 Фото</th>
                <th>⚡ Действия</th>
            </tr>
        </thead>
        <tbody id="zones-table-body">
            <!-- Зоны будут загружены динамически -->
        </tbody>
    </table>
</div>

<!-- Блок настроек перенесён в самый низ страницы, под списком зон -->
<div class="zones-container" style="margin-top:12px;">
  <h4 style="color:#333;">Настройки полива</h4>
  <div style="color:#333;">
    <label for="early-off-seconds" style="color:#333;">За сколько секунд до конца таймера отключать зону:</label>
    <input id="early-off-seconds" type="number" min="0" max="15" step="1" value="3" style="width:80px; margin: 0 8px; color:#333;" />
    <button class="save-all-btn" onclick="saveEarlyOff()">Сохранить</button>
    <div class="muted" style="color:#333;">Допустимо: 0–15 секунд. Выключение выполняется заранее, запуск следующей зоны остаётся по расписанию.</div>
  </div>
  <hr style="margin:12px 0;">
  <div style="color:#333;">
    <h5 style="margin:0 0 6px 0;">Датчик дождя (глобально)</h5>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label><input type="checkbox" id="rain-enabled"> Использовать датчик дождя</label>
      <label>Тип контактов:
        <select id="rain-type">
          <option value="NO">NO (нормально разомкнут)</option>
          <option value="NC">NC (нормально замкнут)</option>
        </select>
      </label>
      <label>MQTT сервер:
        <select id="rain-server"></select>
      </label>
      <label>MQTT топик:
        <input id="rain-topic" placeholder="/devices/wb-mr6cv3_101/controls/Input 1" style="min-width:280px;">
      </label>
      <button class="save-all-btn" onclick="saveRainConfig()">Сохранить датчик дождя</button>
    </div>
    <div class="muted">Значения: true/false. При дожде полив групп, где датчик разрешён, будет остановлен и отложен до конца дня.</div>
  </div>
  <hr style="margin:12px 0;">
  <div style="color:#333;">
    <h5 style="margin:0 0 6px 0;">Датчики среды</h5>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <label><input type="checkbox" id="env-temp-enabled"> Использовать датчик температуры</label>
      <label>MQTT сервер:
        <select id="env-temp-server"></select>
      </label>
      <label>Топик температуры:
        <input id="env-temp-topic" placeholder="/devices/wb-msw-v4_107/controls/Temperature" style="min-width:280px;">
      </label>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px;">
      <label><input type="checkbox" id="env-hum-enabled"> Использовать датчик влажности</label>
      <label>MQTT сервер:
        <select id="env-hum-server"></select>
      </label>
      <label>Топик влажности:
        <input id="env-hum-topic" placeholder="/devices/wb-msw-v4_107/controls/Humidity" style="min-width:280px;">
      </label>
      <button class="save-all-btn" onclick="saveEnvConfig()">Сохранить датчики среды</button>
    </div>
    <div class="muted">Значения округляются до целого (арифметически). Если датчик включен, но нет данных, в статусе будет «нет данных». Если датчик отключён — блоки скрываются на статусе.</div>
  </div>
</div>

<!-- Модальные окна -->
<div id="zoneModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Добавить зону</div>
            <span class="close" onclick="closeZoneModal()">&times;</span>
        </div>
        <form class="modal-form" id="zoneForm">
            <div class="form-group">
                <label>Название зоны:</label>
                <input type="text" id="zoneName" required>
            </div>
            <div class="form-group">
                <label>Иконка:</label>
                <select id="zoneIcon">
                    <option value="🌿">🌿 Трава</option>
                    <option value="🌳">🌳 Дерево</option>
                    <option value="🌺">🌺 Цветок</option>
                    <option value="🌻">🌻 Подсолнух</option>
                    <option value="🌹">🌹 Роза</option>
                    <option value="🌸">🌸 Сакура</option>
                    <option value="🌼">🌼 Ромашка</option>
                    <option value="🌷">🌷 Тюльпан</option>
                    <option value="🌱">🌱 Росток</option>
                    <option value="🌲">🌲 Ель</option>
                    <option value="🌴">🌴 Пальма</option>
                    <option value="🌵">🌵 Кактус</option>
                    <option value="🍀">🍀 Клевер</option>
                    <option value="🌾">🌾 Пшеница</option>
                    <option value="🌽">🌽 Кукуруза</option>
                    <option value="🥕">🥕 Морковь</option>
                    <option value="🍅">🍅 Помидор</option>
                    <option value="🥬">🥬 Салат</option>
                    <option value="🧱">🧱 Кирпич</option>
                </select>
            </div>
            <div class="form-group">
                <label>Время полива (мин):</label>
                <input type="number" id="zoneDuration" min="1" max="120" value="10" required>
            </div>
            <div class="form-group">
                <label>Группа:</label>
                <select id="zoneGroup" required>
                    <!-- Группы будут загружены динамически -->
                </select>
            </div>
            <div class="form-group">
                <label>MQTT Topic:</label>
                <input type="text" id="zoneTopic" placeholder="zone/1" required>
                <small>Топик для управления реле зоны (например: zone/1, relay/zone1)</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeZoneModal()">Отмена</button>
                <button type="submit" class="btn-primary">Добавить</button>
            </div>
        </form>
    </div>
</div>

<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Редактировать группу</div>
            <span class="close" onclick="closeGroupModal()">&times;</span>
        </div>
        <form class="modal-form" id="groupForm">
            <div class="form-group">
                <label>Название группы:</label>
                <input type="text" id="groupName" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeGroupModal()">Отмена</button>
                <button type="submit" class="btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модалка добавления группы -->
<div id="addGroupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Добавить группу</div>
      <span class="close" onclick="closeAddGroupModal()">&times;</span>
    </div>
    <form class="modal-form" id="addGroupForm">
      <div class="form-group">
        <label>Название группы:</label>
        <input type="text" id="newGroupName" placeholder="Новая группа" required>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeAddGroupModal()">Отмена</button>
        <button type="submit" class="btn-primary">Создать</button>
      </div>
    </form>
  </div>
 </div>

<!-- Модальное окно конфликтов -->
<div id="conflictModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">⚠️ Конфликт программ полива</div>
            <span class="close" onclick="closeConflictModal()">&times;</span>
        </div>
        <div id="conflictContent" style="max-height: 50vh; overflow: auto; color: #333;"></div>
        <div class="modal-actions">
            <button type="button" class="btn-primary" onclick="closeConflictModal()">Понятно</button>
        </div>
    </div>
 </div>

<!-- Модальное окно для просмотра фотографий -->
<div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
        <h3>Фотография зоны</h3>
        <img id="photoModalImg" src="" alt="Фото зоны">
        <div class="photo-modal-actions">
            <button type="button" class="btn-primary" onclick="closePhotoModal()">Закрыть</button>
        </div>
    </div>
</div>

<!-- Скрытый input для загрузки файлов -->
<input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">

{% endblock %}

{% block extra_js %}
<script>
    let zonesData = [];
    let groupsData = [];
    let modifiedZones = new Set();
    let modifiedGroups = new Set(); // Новый набор для отслеживания модифицированных групп
    let editingGroupId = null;
    let sortColumn = -1;
    let sortDirection = 'asc';
    
    // Загрузка данных
    async function loadData() {
        try {
            const [zonesRes, groupsRes, mqttRes, rainRes, envRes] = await Promise.all([
                api.get('/api/zones'),
                api.get('/api/groups'),
                api.get('/api/mqtt/servers'),
                api.get('/api/rain'),
                api.get('/api/env')
            ]);
            zonesData = zonesRes;
            groupsData = groupsRes;
            window.mqttServers = (mqttRes && mqttRes.servers) ? mqttRes.servers : [];
            window.rainConfig = (rainRes && rainRes.config) ? rainRes.config : {enabled:false, type:'NO', topic:'', server_id:null};
            window.envConfig = (envRes && envRes.config) ? envRes.config : { temp:{enabled:false, topic:'', server_id:null}, hum:{enabled:false, topic:'', server_id:null} };
            
            renderZonesTable();
            renderGroupsGrid();
            loadGroupSelectors();
            updateZonesCount();
            await loadEarlyOff();
            initRainUi();
            initEnvUi();
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            showNotification('Ошибка загрузки данных', 'error');
        }
    }
    
    // Рендеринг таблицы зон
    function renderZonesTable() {
        const tbody = document.getElementById('zones-table-body');
        tbody.innerHTML = '';
        
        zonesData.forEach(zone => {
            const row = document.createElement('tr');
            row.className = 'zone-row';
            row.dataset.zoneId = zone.id;
            
            row.innerHTML = `
                <td><input type="checkbox" class="zone-checkbox" value="${zone.id}" onchange="updateSelectedCount()"></td>
                <td style="color: #333 !important;">
                    <span class="zone-status-indicator ${zone.state === 'on' ? 'active' : 'inactive'}"></span>
                    ${zone.id}
                </td>
                <td>
                    <div class="icon-dropdown">
                        <span class="zone-icon" onclick="toggleIconDropdown(${zone.id})">${zone.icon}</span>
                        <div class="icon-dropdown-content" id="icon-dropdown-${zone.id}">
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌿')">🌿 Трава</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌳')">🌳 Дерево</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌺')">🌺 Цветок</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌻')">🌻 Подсолнух</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌹')">🌹 Роза</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌸')">🌸 Сакура</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌼')">🌼 Ромашка</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌷')">🌷 Тюльпан</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌱')">🌱 Росток</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌲')">🌲 Ель</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌴')">🌴 Пальма</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌵')">🌵 Кактус</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🍀')">🍀 Клевер</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌾')">🌾 Пшеница</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌽')">🌽 Кукуруза</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🥕')">🥕 Морковь</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🍅')">🍅 Помидор</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🥬')">🥬 Салат</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🧱')">🧱 Кирпич</div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="text" class="zone-name" value="${zone.name}" 
                           onchange="updateZone(${zone.id}, 'name', this.value)">
                </td>
                <td>
                    <input type="number" class="zone-duration" value="${zone.duration}" 
                           min="1" max="120" onchange="updateZone(${zone.id}, 'duration', this.value)">
                </td>
                <td>
                    <select class="zone-group" onchange="updateZone(${zone.id}, 'group_id', this.value)">
                        ${groupsData.map(group => 
                            (group.id === 999 ? `<option value="999" ${zone.group_id == 999 ? 'selected' : ''}>БЕЗ ПОЛИВА</option>` :
                            `<option value="${group.id}" ${zone.group_id == group.id ? 'selected' : ''}>${group.name}</option>`)
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input type="text" class="zone-topic" value="${zone.topic || ''}" 
                           placeholder="zone/1" onchange="updateZone(${zone.id}, 'topic', this.value)">
                </td>
                <td>
                    <select class="zone-mqtt" onchange="updateZone(${zone.id}, 'mqtt_server_id', this.value)">
                        ${window.mqttServers.map(s => `<option value="${s.id}" ${String(zone.mqtt_server_id||'')===String(s.id)?'selected':''}>${s.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <div class="zone-photo">
                        ${zone.photo_path ? 
                            `<img src="/api/zones/${zone.id}/photo" alt="Фото зоны ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')">` :
                            `<div class="no-photo" onclick="uploadPhoto(${zone.id})">📷</div>`
                        }
                        ${zone.photo_path ? 
                            `<div style="display:flex; gap:.3rem; margin-top:.2rem;">
                                <button class="photo-delete-btn" onclick="deletePhoto(${zone.id})">Удалить</button>
                                <button class="photo-upload-btn" onclick="rotatePhoto(${zone.id}, 90)">⟳ 90°</button>
                                <button class="photo-upload-btn" onclick="rotatePhoto(${zone.id}, -90)">⟲ -90°</button>
                            </div>` :
                            `<button class="photo-upload-btn" onclick="uploadPhoto(${zone.id})">Загрузить</button>`
                        }
                    </div>
                </td>
                <td>
                    <div class="zone-actions">
                        <button class="save-btn" onclick="saveZone(${zone.id})" disabled>💾</button>
                        <button class="start-btn" onclick="toggleZone(${zone.id})">${zone.state === 'on' ? '⏹️' : '▶️'}</button>
                        <button class="delete-btn" onclick="deleteZone(${zone.id})">🗑️</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        updateSelectedCount();
    }
    
    // Рендеринг сетки групп
    function renderGroupsGrid() {
        const container = document.getElementById('groups-grid');
        container.innerHTML = '';
        
        groupsData
            .filter(group => group.id !== 999)
            .forEach(group => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.dataset.groupId = group.id;
            card.style.position = 'relative';
            card.innerHTML = `
                <button class="delete-btn" title="Удалить группу" onclick="deleteGroup(${group.id})">✖</button>
                <div style="padding:10px 10px 6px 10px;">
                    <input type="text" class="group-name" value="${group.name}" 
                           oninput="autoSaveGroupName(${group.id}, this.value)"
                           placeholder="Название группы"
                           style="width: calc(100% - 0px); display:block;">
                </div>
                <div style="padding:0 10px 6px 10px; color:#333;">Зон: ${group.zone_count || 0}</div>
                <div style="padding:0 10px 10px 10px;">
                    <label style="display:flex; gap:8px; align-items:center; color:#222;">
                        <input type="checkbox" class="group-use-rain" ${group.use_rain_sensor ? 'checked' : ''} onchange="toggleGroupUseRain(${group.id}, this.checked)">
                        Использовать датчик дождя?
                    </label>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function markGroupModified(groupId) {
        modifiedGroups.add(groupId);
    }

    function updateSaveAllButton() {}
    
    // Загрузка селекторов групп
    function loadGroupSelectors() {
        const selectors = ['bulkGroup', 'zoneGroup'];
        selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                selector.innerHTML = groupsData.map(group => {
                    if (selectorId === 'bulkGroup' && group.id === 999) return '';
                    return `<option value="${group.id}">${group.id===999?'БЕЗ ПОЛИВА':group.name}</option>`;
                }).join('');
            }
        });
        // MQTT servers for bulk
        const bulkMqtt = document.getElementById('bulkMqtt');
        if (bulkMqtt) {
            bulkMqtt.innerHTML = (window.mqttServers||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        }
        // Rain server selector
        const rs = document.getElementById('rain-server');
        if (rs) {
            rs.innerHTML = (window.mqttServers||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        }
        // Env servers
        const ets = document.getElementById('env-temp-server');
        if (ets) ets.innerHTML = (window.mqttServers||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        const ehs = document.getElementById('env-hum-server');
        if (ehs) ehs.innerHTML = (window.mqttServers||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    }
    
    // Обновление счетчика зон
    function updateZonesCount() {
        document.getElementById('zones-count').textContent = zonesData.length;
    }

    // Автосохранение имени группы
    let _saveTimers = {};
    function autoSaveGroupName(groupId, value) {
        markGroupModified(groupId);
        if (_saveTimers[groupId]) clearTimeout(_saveTimers[groupId]);
        _saveTimers[groupId] = setTimeout(async () => {
            try {
                const ok = await api.put(`/api/groups/${groupId}`, { name: value });
                if (ok && ok.success) {
                    const gi = groupsData.findIndex(g=>g.id===groupId);
                    if (gi>=0) groupsData[gi].name = value;
                } else {
                    showNotification('Не удалось сохранить имя группы', 'error');
                }
            } catch (e) {
                showNotification('Ошибка сохранения группы', 'error');
            }
        }, 400);
    }

    function initRainUi() {
        try {
            const cfg = window.rainConfig || {enabled:false, type:'NO', topic:'', server_id:null};
            document.getElementById('rain-enabled').checked = !!cfg.enabled;
            document.getElementById('rain-type').value = (cfg.type==='NC'?'NC':'NO');
            document.getElementById('rain-topic').value = cfg.topic || '';
            const rs = document.getElementById('rain-server');
            if (rs && cfg.server_id) rs.value = String(cfg.server_id);
        } catch {}
    }

    async function saveRainConfig() {
        try {
            const enabled = document.getElementById('rain-enabled').checked;
            const type = document.getElementById('rain-type').value;
            const topic = document.getElementById('rain-topic').value;
            const rs = document.getElementById('rain-server');
            const server_id = rs && rs.value ? parseInt(rs.value) : null;
            // Клиентская валидация
            const rainTopicInput = document.getElementById('rain-topic');
            rainTopicInput.style.border = '';
            if (enabled && !String(topic).trim()) {
                rainTopicInput.style.border = '2px solid #f44336';
                showNotification('Укажите MQTT-топик для датчика дождя', 'error');
                return;
            }
            const resp = await fetch('/api/rain', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled, type, topic, server_id})});
            const data = await resp.json();
            if (data && data.success) {
                showNotification('Конфигурация датчика дождя сохранена', 'success');
            } else {
                showNotification('Не удалось сохранить конфигурацию', 'error');
            }
        } catch (e) {
            showNotification('Ошибка сохранения конфигурации', 'error');
        }
    }

    function initEnvUi() {
        try {
            const cfg = window.envConfig || { temp:{enabled:false}, hum:{enabled:false} };
            document.getElementById('env-temp-enabled').checked = !!(cfg.temp && cfg.temp.enabled);
            document.getElementById('env-temp-topic').value = (cfg.temp && cfg.temp.topic) || '';
            if (cfg.temp && cfg.temp.server_id) document.getElementById('env-temp-server').value = String(cfg.temp.server_id);
            document.getElementById('env-hum-enabled').checked = !!(cfg.hum && cfg.hum.enabled);
            document.getElementById('env-hum-topic').value = (cfg.hum && cfg.hum.topic) || '';
            if (cfg.hum && cfg.hum.server_id) document.getElementById('env-hum-server').value = String(cfg.hum.server_id);
        } catch {}
    }

    async function saveEnvConfig() {
        try {
            const temp = {
                enabled: document.getElementById('env-temp-enabled').checked,
                server_id: (document.getElementById('env-temp-server').value || '') ? parseInt(document.getElementById('env-temp-server').value) : null,
                topic: document.getElementById('env-temp-topic').value,
            };
            const hum = {
                enabled: document.getElementById('env-hum-enabled').checked,
                server_id: (document.getElementById('env-hum-server').value || '') ? parseInt(document.getElementById('env-hum-server').value) : null,
                topic: document.getElementById('env-hum-topic').value,
            };
            // Клиентская валидация
            const tempTopicInput = document.getElementById('env-temp-topic');
            const humTopicInput = document.getElementById('env-hum-topic');
            tempTopicInput.style.border = '';
            humTopicInput.style.border = '';
            if (temp.enabled && !String(temp.topic).trim()) {
                tempTopicInput.style.border = '2px solid #f44336';
                showNotification('Укажите MQTT-топик для датчика температуры', 'error');
                return;
            }
            if (hum.enabled && !String(hum.topic).trim()) {
                humTopicInput.style.border = '2px solid #f44336';
                showNotification('Укажите MQTT-топик для датчика влажности', 'error');
                return;
            }
            const resp = await fetch('/api/env', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ temp, hum })});
            const data = await resp.json();
            if (data && data.success) {
                showNotification('Настройки датчиков среды сохранены', 'success');
            } else {
                // Подсветим оба поля, если есть ошибки
                if (data && data.errors) {
                    if (data.errors.temp_topic) {
                        tempTopicInput.style.border = '2px solid #f44336';
                    }
                    if (data.errors.hum_topic) {
                        humTopicInput.style.border = '2px solid #f44336';
                    }
                    const msg = [data.errors.temp_topic, data.errors.hum_topic].filter(Boolean).join('. ');
                    showNotification(msg || 'Не удалось сохранить настройки датчиков', 'error');
                } else {
                    showNotification('Не удалось сохранить настройки датчиков', 'error');
                }
            }
        } catch (e) {
            showNotification('Ошибка сохранения настроек датчиков', 'error');
        }
    }

    async function toggleGroupUseRain(groupId, enabled) {
        try {
            const ok = await api.put(`/api/groups/${groupId}`, { name: groupsData.find(g=>g.id===groupId).name, use_rain_sensor: !!enabled });
            if (ok) {
                const gi = groupsData.findIndex(g=>g.id===groupId);
                if (gi>=0) groupsData[gi].use_rain_sensor = !!enabled;
                showNotification('Настройка датчика дождя для группы сохранена', 'success');
            }
        } catch (e) {
            showNotification('Ошибка сохранения настройки группы', 'error');
        }
    }
    
    // Обновление зоны (отметка как измененной)
    function updateZone(zoneId, field, value) {
        const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
        if (row) {
            row.classList.add('modified');
            modifiedZones.add(zoneId);
            
            // Активируем кнопку сохранения
            const saveBtn = row.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }
    }
    
    // Сохранение зоны
    async function saveZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) return;
            
            const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
            const nameInput = row.querySelector('.zone-name');
            const durationInput = row.querySelector('.zone-duration');
            const groupSelect = row.querySelector('.zone-group');
            const topicInput = row.querySelector('.zone-topic');
            const mqttSelect = row.querySelector('.zone-mqtt');
            
            const updatedZone = {
                ...zone,
                name: nameInput.value,
                duration: parseInt(durationInput.value),
                group_id: parseInt(groupSelect.value)
            };
            if (topicInput) {
                updatedZone.topic = topicInput.value;
            }
            if (mqttSelect) {
                const val = mqttSelect.value;
                updatedZone.mqtt_server_id = val === '' ? null : parseInt(val);
            }

            // 1) Перед сохранением проверяем конфликты по программам (bulk API)
            try {
                const r = await fetch('/api/zones/check-duration-conflicts-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ changes: [{ zone_id: zoneId, new_duration: updatedZone.duration }] })
                });
                const result = await r.json();
                const zres = result && result.results && result.results[String(zoneId)];
                if (zres && zres.has_conflicts) {
                    showDurationConflictModal(zres.conflicts);
                    showNotification('Обнаружены конфликты программ. Изменение не сохранено.', 'warning');
                    return; // блокируем сохранение
                }
            } catch (err) {
                console.error('Ошибка проверки конфликтов:', err);
            }
            
            const success = await api.put(`/api/zones/${zoneId}`, updatedZone);
            if (success) {
                // Обновляем данные в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex] = { ...zonesData[zoneIndex], ...updatedZone };
                }
                
                // Убираем модификацию только для этой зоны
                row.classList.remove('modified');
                modifiedZones.delete(zoneId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('Зона обновлена', 'success');
                
                // Обновляем только сетку групп, если нужно
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('Ошибка сохранения зоны:', error);
            showNotification('Ошибка сохранения зоны', 'error');
        }
    }
    
    // Удаление зоны
    async function deleteZone(zoneId) {
        if (!confirm(`Удалить зону ${zoneId}?`)) return;
        
        try {
            const success = await api.delete(`/api/zones/${zoneId}`);
            if (success) {
                // Удаляем зону из локального массива
                zonesData = zonesData.filter(z => z.id !== zoneId);
                modifiedZones.delete(zoneId);
                
                showNotification('Зона удалена', 'success');
                
                // Обновляем отображение
                renderZonesTable();
                renderGroupsGrid();
                updateZonesCount();
            }
        } catch (error) {
            console.error('Ошибка удаления зоны:', error);
            showNotification('Ошибка удаления зоны', 'error');
        }
    }

    // Показать модалку конфликтов длительности зоны
    function showDurationConflictModal(conflicts) {
        const modal = document.getElementById('conflictModal');
        const content = document.getElementById('conflictContent');
        if (!Array.isArray(conflicts) || conflicts.length === 0) {
            content.innerHTML = '<p>Конфликты не обнаружены.</p>';
        } else {
            const items = conflicts.map(c => {
                const start = toTimeString(c.overlap_start);
                const end = toTimeString(c.overlap_end);
                const groups = (c.common_groups || []).join(', ');
                const zones = (c.common_zones || []).join(', ');
                return `<li style="margin-bottom: .5rem;">
                    <div><strong>${c.checked_program_name}</strong> (${c.checked_program_time}) ↔ <strong>${c.other_program_name}</strong> (${c.other_program_time})</div>
                    <div>Пересечение: ${start} - ${end}</div>
                    ${zones ? `<div>Зоны: ${zones}</div>` : ''}
                    ${groups ? `<div>Группы: ${groups}</div>` : ''}
                </li>`;
            }).join('');
            content.innerHTML = `<p>Изменение длительности приведет к пересечению программ. Изменение не будет сохранено. Измените время зоны или расписание программ.</p><ul>${items}</ul>`;
        }
        modal.style.display = 'block';
    }

    function closeConflictModal() {
        const modal = document.getElementById('conflictModal');
        modal.style.display = 'none';
    }

    function toTimeString(totalMinutes) {
        const h = Math.floor(totalMinutes / 60) % 24;
        const m = totalMinutes % 60;
        return `${(''+h).padStart(2,'0')}:${(''+m).padStart(2,'0')}`;
    }
    
    // Запуск зоны
    async function startZone(zoneId) {
        try {
            // Проверяем, не запущена ли уже зона в той же группе
            const currentZone = zonesData.find(z => z.id === zoneId);
            if (!currentZone) {
                showNotification('Зона не найдена', 'error');
                return;
            }
            
            const activeZoneInGroup = zonesData.find(z => 
                z.group_id === currentZone.group_id && 
                z.id !== zoneId && 
                z.state === 'on'
            );
            
            if (activeZoneInGroup) {
                showNotification(`В группе уже запущена зона ${activeZoneInGroup.id}. Остановите её перед запуском новой зоны.`, 'warning');
                return;
            }
            
            // MQTT: публикуем '1' и ждём подтверждения через zones-sse
            const response = await api.post(`/api/zones/${zoneId}/mqtt/start`);
            
            if (response.success) {
                showNotification(`Зона ${zoneId} запущена`, 'success');
                
                // Обновляем статус зоны в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'on';
                }
                
                // Обновляем отображение
                renderZonesTable();
                
                // Обновляем статус на странице статуса
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('Ошибка запуска зоны:', error);
            showNotification('Ошибка запуска зоны', 'error');
        }
    }
    
    // Остановка зоны
    async function stopZone(zoneId) {
        try {
            const response = await api.post(`/api/zones/${zoneId}/mqtt/stop`);
            
            if (response.success) {
                showNotification(`Зона ${zoneId} остановлена`, 'success');
                
                // Обновляем статус зоны в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'off';
                }
                
                // Обновляем отображение
                renderZonesTable();
                
                // Обновляем статус на странице статуса
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('Ошибка остановки зоны:', error);
            showNotification('Ошибка остановки зоны', 'error');
        }
    }
    
    // Переключатель пуск/стоп одной кнопкой (как на странице статус)
    async function toggleZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) {
                showNotification('Зона не найдена', 'error');
                return;
            }
            if (zone.state === 'on') {
                await stopZone(zoneId);
            } else {
                await startZone(zoneId);
            }
        } catch (e) {
            showNotification('Ошибка переключения зоны', 'error');
        }
    }
    
    // Изменение иконки зоны
    function changeZoneIcon(zoneId) {
        const icons = ['🌿', '🌳', '🌺', '🌻', '🌹', '🌸', '🌼', '🌷', '🌱', '🌲', '🌴', '🌵', '🍀', '🌾', '🌽', '🥕', '🍅', '🥬', '🧱'];
        const currentIcon = zonesData.find(z => z.id === zoneId)?.icon || '🌿';
        const currentIndex = icons.indexOf(currentIcon);
        const nextIndex = (currentIndex + 1) % icons.length;
        const newIcon = icons[nextIndex];
        
        updateZone(zoneId, 'icon', newIcon);
        const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
        if (iconElement) {
            iconElement.textContent = newIcon;
        }
    }
    
    // Массовые действия
    function updateBulkForm() {
        const action = document.getElementById('bulkAction').value;
        document.getElementById('bulkGroupSelect').style.display = action === 'group' ? 'block' : 'none';
        document.getElementById('bulkIconSelect').style.display = action === 'icon' ? 'block' : 'none';
        document.getElementById('bulkDurationSelect').style.display = action === 'duration' ? 'block' : 'none';
        const mqttSel = document.getElementById('bulkMqttSelect'); if (mqttSel) mqttSel.style.display = action === 'mqtt' ? 'block' : 'none';
    }
    
    async function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        if (!action) {
            showNotification('Выберите действие', 'warning');
            return;
        }
        
        const selectedZones = Array.from(document.querySelectorAll('.zone-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selectedZones.length === 0) {
            showNotification('Выберите зоны для изменения', 'warning');
            return;
        }
        
        try {
            let value = null;
            switch (action) {
                case 'group':
                    value = parseInt(document.getElementById('bulkGroup').value);
                    break;
                case 'icon':
                    value = document.getElementById('bulkIcon').value;
                    break;
                case 'duration':
                    value = parseInt(document.getElementById('bulkDuration').value);
                    break;
                case 'mqtt':
                    value = parseInt(document.getElementById('bulkMqtt').value);
                    break;
            }
            
            // Применяем изменения ко всем выбранным зонам
            for (const zoneId of selectedZones) {
                const zone = zonesData.find(z => z.id === zoneId);
                if (zone) {
                    if (action === 'delete') {
                        await api.delete(`/api/zones/${zoneId}`);
                        continue;
                    }
                    if (action === 'delphoto') {
                        await api.delete(`/api/zones/${zoneId}/photo`);
                        continue;
                    }
                    
                    const updatedZone = { ...zone };
                    switch (action) {
                        case 'group':
                            updatedZone.group_id = parseInt(value);
                            break;
                        case 'icon':
                            updatedZone.icon = value;
                            break;
                        case 'duration':
                            // Проверка конфликтов как и раньше
                            try {
                                const conflict = await api.post('/api/zones/check-duration-conflicts', { zone_id: zoneId, new_duration: parseInt(value) });
                                if (conflict && conflict.has_conflicts) {
                                    showNotification(`Конфликт с программами для зоны ${zoneId}. Изменение пропущено`, 'warning');
                                    continue;
                                }
                            } catch (err) {
                                console.error('Ошибка проверки конфликтов (bulk):', err);
                            }
                            updatedZone.duration = parseInt(value);
                            break;
                        case 'mqtt':
                            updatedZone.mqtt_server_id = parseInt(value);
                            break;
                    }
                    await api.put(`/api/zones/${zoneId}`, updatedZone);
                }
            }
            
            showNotification(`Изменения применены к ${selectedZones.length} зонам`, 'success');
            await loadData();
            
        } catch (error) {
            console.error('Ошибка массового действия:', error);
            showNotification('Ошибка применения изменений', 'error');
        }
    }
    
    // Сортировка таблицы
    function sortTable(columnIndex) {
        if (sortColumn === columnIndex) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columnIndex;
            sortDirection = 'asc';
        }
        
        // Обновляем заголовки
        document.querySelectorAll('.zones-table th').forEach((th, index) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (index === columnIndex) {
                th.classList.add(`sort-${sortDirection}`);
            }
        });
        
        // Сортируем данные
        zonesData.sort((a, b) => {
            let aVal, bVal;
            
            switch (columnIndex) {
                case 0: // № Зоны
                    aVal = a.id;
                    bVal = b.id;
                    break;
                case 1: // Иконка
                    aVal = a.icon;
                    bVal = b.icon;
                    break;
                case 2: // Название
                    aVal = a.name;
                    bVal = b.name;
                    break;
                case 3: // Время
                    aVal = a.duration;
                    bVal = b.duration;
                    break;
                case 4: // Группа
                    aVal = groupsData.find(g => g.id === a.group_id)?.name || '';
                    bVal = groupsData.find(g => g.id === b.group_id)?.name || '';
                    break;
                default:
                    return 0;
            }
            
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        renderZonesTable();
    }
    
    // Модальные окна для зон и групп
    function showZoneModal() {
        document.getElementById('zoneModal').style.display = 'block';
    }
    
    function closeZoneModal() {
        document.getElementById('zoneModal').style.display = 'none';
        document.getElementById('zoneForm').reset();
    }
    
    function editGroup(groupId, groupName) {
        editingGroupId = groupId;
        document.getElementById('groupName').value = groupName;
        document.getElementById('groupModal').style.display = 'block';
    }
    
    function closeGroupModal() {
        document.getElementById('groupModal').style.display = 'none';
        editingGroupId = null;
    }
    
    function createGroup() {
        editingGroupId = null;
        document.getElementById('groupName').value = '';
        document.getElementById('groupModal').style.display = 'block';
    }

    function showAddGroupModal() { document.getElementById('addGroupModal').style.display = 'block'; }
    function closeAddGroupModal() { document.getElementById('addGroupModal').style.display = 'none'; document.getElementById('addGroupForm').reset(); }
    
    // Обработчики форм
    document.getElementById('zoneForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const zoneData = {
            name: document.getElementById('zoneName').value,
            icon: document.getElementById('zoneIcon').value,
            duration: parseInt(document.getElementById('zoneDuration').value),
            group_id: parseInt(document.getElementById('zoneGroup').value),
            topic: document.getElementById('zoneTopic').value,
            mqtt_server_id: (window.mqttServers||[]).length === 1 ? ((window.mqttServers[0] && window.mqttServers[0].id) || null) : undefined
        };
        
        try {
            const success = await api.post('/api/zones', zoneData);
            if (success) {
                showNotification('Зона создана', 'success');
                closeZoneModal();
                await loadData();
            }
        } catch (error) {
            console.error('Ошибка создания зоны:', error);
            showNotification('Ошибка создания зоны', 'error');
        }
    });
    
    document.getElementById('groupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const groupName = document.getElementById('groupName').value;
        
        try {
            if (editingGroupId) {
                const success = await api.put(`/api/groups/${editingGroupId}`, { name: groupName });
                if (success) {
                    showNotification('Группа обновлена', 'success');
                }
            } else {
                const success = await api.post('/api/groups', { name: groupName });
                if (success) {
                    showNotification('Группа создана', 'success');
                }
            }
            
            closeGroupModal();
            await loadData();
        } catch (error) {
            console.error('Ошибка сохранения группы:', error);
            showNotification('Ошибка сохранения группы', 'error');
        }
    });

    document.getElementById('addGroupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('newGroupName').value || 'Новая группа';
        try {
            const res = await api.post('/api/groups', { name });
            if (res && (res.id || res.success)) {
                showNotification('Группа создана', 'success');
                closeAddGroupModal();
                await loadData();
            }
        } catch (err) {
            showNotification('Ошибка создания группы', 'error');
        }
    });
    
    // Закрытие модальных окон при клике вне их
    window.onclick = function(event) {
        const modals = ['zoneModal', 'groupModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        // Подпишемся на поток статусов зон через SSE
        try {
            const es = new EventSource('/api/mqtt/zones-sse');
            es.onmessage = (ev)=>{
                try{
                    const data = JSON.parse(ev.data);
                    const idx = zonesData.findIndex(z=>z.id===data.zone_id);
                    if (idx>=0){
                        zonesData[idx].state = data.state;
                        const row = document.querySelector(`tr[data-zone-id="${data.zone_id}"]`);
                        if (row){
                            const btn = row.querySelector('.start-btn');
                            if (btn){ btn.textContent = zonesData[idx].state==='on'?'⏹️':'▶️'; }
                        }
                    }
                }catch(e){}
            };
        } catch (e) {}
    });

    // Функции для работы с чекбоксами
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateSelectedCount();
    }
    
    function selectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        document.getElementById('selectAll').checked = true;
        updateSelectedCount();
    }
    
    function deselectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.zone-checkbox:checked');
        document.getElementById('selected-count').textContent = `Выбрано: ${checkboxes.length} зон`;
    }
    
    // Функции для работы с выпадающим списком иконок
    function toggleIconDropdown(zoneId) {
        const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
        const allDropdowns = document.querySelectorAll('.icon-dropdown-content');
        
        // Закрываем все другие выпадающие списки
        allDropdowns.forEach(d => {
            if (d !== dropdown) {
                d.classList.remove('show');
            }
        });
        
        dropdown.classList.toggle('show');
    }
    
    function selectIcon(zoneId, icon) {
        const zone = zonesData.find(z => z.id === zoneId);
        if (zone) {
            zone.icon = icon;
            updateZone(zoneId, 'icon', icon);
            
            // Обновляем отображение иконки
            const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
            if (iconElement) {
                iconElement.textContent = icon;
            }
            
            // Закрываем выпадающий список
            const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
            dropdown.classList.remove('show');
        }
    }
    
    // Закрытие выпадающих списков при клике вне их
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.icon-dropdown')) {
            const dropdowns = document.querySelectorAll('.icon-dropdown-content');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });
    
    // Функции для работы с фотографиями
    let currentPhotoZoneId = null;
    
    function uploadPhoto(zoneId) {
        currentPhotoZoneId = zoneId;
        document.getElementById('photoInput').click();
    }
    
    async function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file || !currentPhotoZoneId) return;
        
        if (!file.type.startsWith('image/')) {
            showNotification('Пожалуйста, выберите изображение', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showNotification('Размер файла не должен превышать 5MB', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('photo', file);
        
        try {
            showNotification('Загрузка фотографии...', 'info');
            
            const response = await fetch(`/api/zones/${currentPhotoZoneId}/photo`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                showNotification('Фотография успешно загружена', 'success');
                await loadData(); // Перезагружаем данные
            } else {
                const error = await response.json();
                showNotification(error.message || 'Ошибка загрузки фотографии', 'error');
            }
        } catch (error) {
            console.error('Ошибка загрузки фотографии:', error);
            showNotification('Ошибка загрузки фотографии', 'error');
        }
        
        // Очищаем input
        event.target.value = '';
        currentPhotoZoneId = null;
    }
    
    async function deletePhoto(zoneId) {
        if (!confirm('Вы уверены, что хотите удалить фотографию этой зоны?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/zones/${zoneId}/photo`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Фотография удалена', 'success');
                await loadData(); // Перезагружаем данные
            } else {
                const error = await response.json();
                showNotification(error.message || 'Ошибка удаления фотографии', 'error');
            }
        } catch (error) {
            console.error('Ошибка удаления фотографии:', error);
            showNotification('Ошибка удаления фотографии', 'error');
        }
    }

    async function rotatePhoto(zoneId, angle){
        try{
            const r = await fetch(`/api/zones/${zoneId}/photo/rotate`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({angle})});
            const j = await r.json();
            if (j && j.success){
                showNotification('Фото повернуто', 'success');
                await loadData();
            } else {
                showNotification((j && j.message)||'Не удалось повернуть фото', 'error');
            }
        }catch(e){ showNotification('Ошибка поворота фото', 'error'); }
    }
    
    function showPhotoModal(photoUrl) {
        const modal = document.getElementById('photoModal');
        const img = document.getElementById('photoModalImg');
        img.src = photoUrl;
        modal.style.display = 'flex';
    }
    
    function closePhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.style.display = 'none';
    }
    
    // Закрытие модального окна фотографии при клике вне его
    document.getElementById('photoModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closePhotoModal();
        }
    });

    async function saveGroup(groupId) {
        try {
            const group = groupsData.find(g => g.id === groupId);
            if (!group) return;
            
            const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
            const nameInput = row.querySelector('.group-name');
            
            const updatedGroup = {
                ...group,
                name: nameInput.value
            };
            
            const success = await api.put(`/api/groups/${groupId}`, updatedGroup);
            if (success) {
                // Обновляем данные в локальном массиве
                const groupIndex = groupsData.findIndex(g => g.id === groupId);
                if (groupIndex !== -1) {
                    groupsData[groupIndex] = { ...groupsData[groupIndex], ...updatedGroup };
                }
                
                // Убираем модификацию только для этой группы
                row.classList.remove('modified');
                modifiedGroups.delete(groupId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('Группа обновлена', 'success');
                
                // Обновляем только сетку групп
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('Ошибка сохранения группы:', error);
            showNotification('Ошибка сохранения группы', 'error');
        }
    }

    async function saveAllGroups() {
        try {
            if (modifiedGroups.size === 0) {
                showNotification('Нет изменений для сохранения', 'info');
                return;
            }

            showNotification('Сохранение всех изменений...', 'info');
            
            // Сохраняем все измененные группы
            const savePromises = Array.from(modifiedGroups).map(groupId => {
                const group = groupsData.find(g => g.id === groupId);
                if (!group) return Promise.resolve();
                
                const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                const nameInput = row.querySelector('.group-name');
                
                const updatedGroup = {
                    ...group,
                    name: nameInput.value
                };
                
                return api.put(`/api/groups/${groupId}`, updatedGroup);
            });
            
            const results = await Promise.all(savePromises);
            const successCount = results.filter(result => result).length;
            
            if (successCount === modifiedGroups.size) {
                // Обновляем все данные в локальном массиве
                modifiedGroups.forEach(groupId => {
                    const group = groupsData.find(g => g.id === groupId);
                    if (group) {
                        const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                        const nameInput = row.querySelector('.group-name');
                        
                        const groupIndex = groupsData.findIndex(g => g.id === groupId);
                        if (groupIndex !== -1) {
                            groupsData[groupIndex].name = nameInput.value;
                        }
                        
                        // Убираем модификацию
                        row.classList.remove('modified');
                        row.querySelector('.save-btn').disabled = true;
                    }
                });
                
                modifiedGroups.clear();
                showNotification(`Сохранено ${successCount} групп`, 'success');
                
                // Обновляем сетку групп
                renderGroupsGrid();
            } else {
                showNotification('Ошибка сохранения некоторых групп', 'error');
            }
        } catch (error) {
            console.error('Ошибка массового сохранения групп:', error);
            showNotification('Ошибка сохранения групп', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm(`Удалить группу ${groupsData.find(g => g.id === groupId)?.name || groupId}?`)) {
            return;
        }

        try {
            const resp = await fetch(`/api/groups/${groupId}`, { method: 'DELETE' });
            if (resp.status === 204) {
                showNotification('Группа удалена', 'success');
                groupsData = groupsData.filter(g => g.id !== groupId);
                modifiedGroups.delete(groupId);
                renderGroupsGrid();
                await loadData(); // Перезагружаем все данные, чтобы обновить счетчик зон
            } else {
                const error = await resp.json().catch(() => ({}));
                showNotification(error.message || 'Ошибка удаления группы', 'error');
            }
        } catch (error) {
            console.error('Ошибка удаления группы:', error);
            showNotification('Ошибка удаления группы', 'error');
        }
    }
    
    // Экспорт зон в CSV
    function exportZonesCSV() {
        if (zonesData.length === 0) {
            // Создаем шаблон, если зон нет
            const template = [
                ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic', 'mqtt_server_id'],
                ['1', 'Зона 1', '🌿', '10', '1', 'off', '/devices/wb-mr6cv3_101/controls/K1', '1'],
                ['2', 'Зона 2', '🌳', '15', '1', 'off', '/devices/wb-mr6cv3_101/controls/K2', '1']
            ];
            
            const csv = template.map(row => row.join(',')).join('\n');
            downloadCSV(csv, 'zones_template.csv');
            showNotification('Создан шаблон CSV файла', 'info');
            return;
        }
        
        // Экспортируем существующие зоны
        const headers = ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic', 'mqtt_server_id'];
        const csvData = [
            headers,
            ...zonesData.map(zone => [
                zone.id,
                zone.name,
                zone.icon,
                zone.duration,
                zone.group_id,
                zone.state,
                zone.topic || '',
                (zone.mqtt_server_id==null?'':zone.mqtt_server_id)
            ])
        ];
        
        const csv = csvData.map(row => row.join(',')).join('\n');
        downloadCSV(csv, `zones_export_${new Date().toISOString().slice(0, 10)}.csv`);
        showNotification(`Экспортировано ${zonesData.length} зон`, 'success');
    }
    
    // Импорт зон из CSV
    function importZonesCSV() {
        document.getElementById('csvFileInput').click();
    }
    
    // Обработка импорта CSV файла
    async function handleCSVImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h=>h.trim());
            
            // Проверяем заголовки
            // Для импорта обязательно только поле id. Остальные — опциональны
            if (!headers.includes('id')) {
                showNotification('Неверный формат файла. Должен быть столбец id', 'error');
                return;
            }
            
            const zonesToImport = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const get = (key) => {
                    const idx = headers.indexOf(key);
                    return idx >= 0 ? (values[idx] ?? '').trim() : '';
                };
                const idStr = get('id');
                if (!idStr) continue;
                const zone = { id: parseInt(idStr,10) };
                const name = get('name'); if (name) zone.name = name;
                const icon = get('icon'); if (icon) zone.icon = icon;
                const dur = get('duration'); if (dur) zone.duration = parseInt(dur,10);
                const gid = get('group_id'); if (gid) zone.group_id = parseInt(gid,10);
                const state = get('state'); if (state) zone.state = state;
                const topic = get('topic'); if (topic) zone.topic = topic;
                const mqtt = get('mqtt_server_id'); if (mqtt) zone.mqtt_server_id = parseInt(mqtt,10);
                zonesToImport.push(zone);
            }
            
            if (zonesToImport.length === 0) {
                showNotification('Файл не содержит данных для импорта', 'warning');
                return;
            }
            
            if (confirm(`Импортировать ${zonesToImport.length} зон?`)) {
                await importZones(zonesToImport);
            }
            
        } catch (error) {
            console.error('Ошибка импорта CSV:', error);
            showNotification('Ошибка чтения CSV файла', 'error');
        }
        
        // Очищаем input
        event.target.value = '';
    }
    
    // Импорт зон в базу данных
    async function importZones(zonesToImport) {
        try {
            showNotification('Импорт зон...', 'info');
            
            // Отправляем одним запросом
            const payload = { zones: zonesToImport };
            const resp = await fetch('/api/zones/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const j = await resp.json();
            
            // Перезагружаем данные
            await loadData();
            if (j && j.success) {
                showNotification(`Импорт: создано ${j.created}, обновлено ${j.updated}, ошибок ${j.failed}`, 'success');
            } else {
                showNotification('Импорт завершился с ошибкой', 'error');
            }
            
        } catch (error) {
            console.error('Ошибка импорта зон:', error);
            showNotification('Ошибка импорта зон', 'error');
        }
    }
    
    // Функция для скачивания CSV файла
    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // === Early OFF seconds setting ===
    async function loadEarlyOff() {
        try {
            const r = await fetch('/api/settings/early-off');
            const j = await r.json();
            const el = document.getElementById('early-off-seconds');
            if (el && j && typeof j.seconds === 'number') {
                el.value = String(j.seconds);
            }
        } catch (e) {}
    }
    async function saveEarlyOff() {
        const el = document.getElementById('early-off-seconds');
        if (!el) return;
        let v = parseInt(el.value, 10);
        if (isNaN(v)) v = 3;
        if (v < 0 || v > 15) { showNotification('Допустимо только 0–15 секунд', 'warning'); return; }
        try {
            const r = await fetch('/api/settings/early-off', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({seconds: v})});
            const j = await r.json();
            if (!(j && j.success)) showNotification(j && j.message ? j.message : 'Не удалось сохранить настройку', 'error');
            else showNotification('Настройка сохранена', 'success');
        } catch (e) { showNotification('Ошибка сохранения', 'error'); }
    }
</script>

<!-- Скрытый input для импорта CSV -->
<input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

{% endblock %}

