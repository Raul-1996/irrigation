{% extends "base.html" %}

{% block title %}Зоны и группы{% endblock %}
{% block page_title %}Зоны и группы{% endblock %}

{% block extra_css %}
<style>
    .zones-container {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .zones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .zones-count {
        background: var(--primary-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .bulk-actions h4 {
        margin: 0 0 0.5rem 0;
        color: #495057;
    }
    
    .bulk-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        align-items: end;
    }
    
    .bulk-form select,
    .bulk-form input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .bulk-form button {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .bulk-form button:hover {
        background: #1976d2;
    }
    
    .save-all-btn {
        background: var(--success-color) !important;
        font-weight: bold;
        padding: 0.6rem 1.2rem !important;
    }
    
    .save-all-btn:hover {
        background: #45a049 !important;
    }
    
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .zones-table th,
    .zones-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .zones-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .zones-table th:hover {
        background: #e9ecef;
    }
    
    .zones-table th.sortable::after {
        content: '↕';
        position: absolute;
        right: 0.5rem;
        opacity: 0.5;
    }
    
    .zones-table th.sort-asc::after {
        content: '↑';
        opacity: 1;
    }
    
    .zones-table th.sort-desc::after {
        content: '↓';
        opacity: 1;
    }
    
    .zone-row {
        transition: var(--transition);
    }
    
    .zone-row:hover {
        background: #f8f9fa;
    }
    
    .zone-row.modified {
        background: #fff3cd;
        border-left: 3px solid var(--warning-color);
    }
    
    .zone-icon {
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-icon:hover {
        transform: scale(1.2);
    }
    
    .zone-name {
        font-weight: 500;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
    }
    
    .zone-name:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-duration {
        font-family: 'Courier New', monospace;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
        width: 60px;
    }
    
    .zone-duration:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-group {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid var(--primary-color);
        transition: var(--transition);
    }
    
    .zone-group:focus {
        border-color: #1976d2;
        outline: none;
    }
    
    .zone-actions {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }
    
    .zone-actions button {
        padding: 0.3rem 0.6rem;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .zone-actions .edit-btn {
        background: var(--info-color);
        color: white;
    }
    
    .zone-actions .save-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .delete-btn {
        background: var(--danger-color);
        color: white;
    }
    
    .zone-actions .start-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .stop-btn {
        background: var(--warning-color);
        color: white;
    }
    
    .zone-actions button:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .zone-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Стили для фотографий */
    .zone-photo {
        position: relative;
        display: inline-block;
    }
    
    .zone-photo img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        object-fit: cover;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo img:hover {
        transform: scale(1.1);
        border-color: var(--primary-color);
    }
    
    .zone-photo .no-photo {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #6c757d;
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo .no-photo:hover {
        border-color: var(--primary-color);
        background: #e3f2fd;
        color: var(--primary-color);
    }
    
    .photo-upload-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-upload-btn:hover {
        background: #1976d2;
    }
    
    .photo-delete-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-delete-btn:hover {
        background: #d32f2f;
    }
    
    .photo-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .photo-modal-content {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    
    .photo-modal img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .photo-modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .photo-modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .photo-modal-actions .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .photo-modal-actions .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .photo-modal-actions button:hover {
        opacity: 0.8;
    }
    
    .groups-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .groups-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 260px));
        gap: 0.8rem;
        justify-content: start;
    }
    
    .group-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.8rem;
        border: 1px solid #e9ecef;
        transition: var(--transition);
        max-width: 320px;
    }
    
    .group-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .group-card h4 {
        margin: 0 0 0.4rem 0;
        color: #333 !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }
    
    .group-name {
        font-weight: 600;
    }
    
    .group-zone-count {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }
    
    .group-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .group-edit-btn {
        background: var(--info-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .group-edit-btn:hover {
        background: #1976d2;
    }
    
    .zones-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .zone-status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        transition: background-color 0.3s ease;
    }
    
    .zone-status-indicator.active {
        background-color: #4caf50;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
    }
    
    .zone-status-indicator.inactive {
        background-color: #ccc;
    }
    
    /* Модальные окна */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
    }
    
    .close {
        color: #aaa;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .form-group label {
        font-weight: 500;
        color: #495057;
    }
    
    .form-group input,
    .form-group select {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }
    
    .modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .modal-actions button:hover {
        opacity: 0.8;
    }
    
    /* Адаптивность */
    @media (max-width: 768px) {
        .zones-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .bulk-form {
            grid-template-columns: 1fr;
        }
        
        .zones-table {
            font-size: 0.8rem;
        }
        
        .zones-table th,
        .zones-table td {
            padding: 0.3rem;
        }
        
        .zone-actions {
            flex-direction: column;
        }
        
        .groups-grid {
            grid-template-columns: 1fr;
        }
    }

    .zone-selection {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .zone-selection button {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }
    
    #selected-count {
        font-size: 0.9rem;
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .zone-checkbox {
        margin-right: 0.5rem;
        transform: scale(1.2);
    }
    
    .icon-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .icon-dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 8px;
        padding: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .icon-dropdown-content.show {
        display: block;
    }
    
    .icon-option {
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .icon-option:hover {
        background-color: #f8f9fa;
    }
    
    .icon-option.selected {
        background-color: var(--primary-color);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Секция групп -->
<div class="groups-section">
    <div class="groups-header">
        <h3>Группы зон</h3>
        <div class="groups-actions">
            <button class="btn btn-primary" onclick="saveAllGroups()" id="saveAllGroupsBtn" disabled>
                💾 Сохранить все группы
            </button>
            <button class="btn btn-success" onclick="showAddGroupModal()">
                ➕ Добавить группу
            </button>
        </div>
    </div>
    <div class="groups-grid" id="groups-grid">
        <!-- Группы будут загружены динамически -->
    </div>
</div>

<!-- Секция зон -->
<div class="zones-container">
    <div class="zones-header">
        <h3>🌿 Зоны полива (<span id="zones-count">0</span>)</h3>
        <div class="zones-actions">
            <button class="group-edit-btn" onclick="exportZonesCSV()">📤 Экспорт CSV</button>
            <button class="group-edit-btn" onclick="importZonesCSV()">📥 Импорт CSV</button>
            <button class="group-edit-btn" onclick="showZoneModal()">➕ Добавить зону</button>
        </div>
    </div>
    
    <!-- Массовые действия -->
    <div class="bulk-actions">
        <h4>⚡ Массовые действия</h4>
        <div class="bulk-form">
            <div class="form-group">
                <label>Выбрать зоны:</label>
                <div class="zone-selection">
                    <button type="button" onclick="selectAllZones()" class="btn-secondary">Выбрать все</button>
                    <button type="button" onclick="deselectAllZones()" class="btn-secondary">Снять выбор</button>
                    <span id="selected-count">Выбрано: 0 зон</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Действие:</label>
                <select id="bulkAction" onchange="updateBulkForm()">
                    <option value="">Выберите действие...</option>
                    <option value="group">Изменить группу</option>
                    <option value="icon">Изменить иконку</option>
                    <option value="duration">Изменить время</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkGroupSelect" style="display: none;">
                <label>Новая группа:</label>
                <select id="bulkGroup">
                    <!-- Группы будут загружены динамически -->
                </select>
            </div>
            
            <div class="form-group" id="bulkIconSelect" style="display: none;">
                <label>Новая иконка:</label>
                <select id="bulkIcon">
                    <option value="🌿">🌿 Трава</option>
                    <option value="🌳">🌳 Дерево</option>
                    <option value="🌺">🌺 Цветок</option>
                    <option value="🌻">🌻 Подсолнух</option>
                    <option value="🌹">🌹 Роза</option>
                    <option value="🌸">🌸 Сакура</option>
                    <option value="🌼">🌼 Ромашка</option>
                    <option value="🌷">🌷 Тюльпан</option>
                    <option value="🌱">🌱 Росток</option>
                    <option value="🌲">🌲 Ель</option>
                    <option value="🌴">🌴 Пальма</option>
                    <option value="🌵">🌵 Кактус</option>
                    <option value="🍀">🍀 Клевер</option>
                    <option value="🌾">🌾 Пшеница</option>
                    <option value="🌽">🌽 Кукуруза</option>
                    <option value="🥕">🥕 Морковь</option>
                    <option value="🍅">🍅 Помидор</option>
                    <option value="🥬">🥬 Салат</option>
                    <option value="🧱">🧱 Кирпич</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkDurationSelect" style="display: none;">
                <label>Новое время (мин):</label>
                <input type="number" id="bulkDuration" min="1" max="120" value="10">
            </div>
            
            <button onclick="applyBulkAction()" class="save-all-btn">💾 Применить к выбранным</button>
        </div>
    </div>
    
    <!-- Таблица зон -->
    <table class="zones-table" id="zones-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th class="sortable" onclick="sortTable(0)">№ Зоны</th>
                <th class="sortable" onclick="sortTable(1)">🎯 Иконка</th>
                <th class="sortable" onclick="sortTable(2)">📝 Название</th>
                <th class="sortable" onclick="sortTable(3)">⏱️ Время</th>
                <th class="sortable" onclick="sortTable(4)">🏷️ Группа</th>
                <th class="sortable" onclick="sortTable(5)">📡 MQTT Topic</th>
                <th>🖧 MQTT Server</th>
                <th>📸 Фото</th>
                <th>⚡ Действия</th>
            </tr>
        </thead>
        <tbody id="zones-table-body">
            <!-- Зоны будут загружены динамически -->
        </tbody>
    </table>
</div>

<!-- Модальные окна -->
<div id="zoneModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Добавить зону</div>
            <span class="close" onclick="closeZoneModal()">&times;</span>
        </div>
        <form class="modal-form" id="zoneForm">
            <div class="form-group">
                <label>Название зоны:</label>
                <input type="text" id="zoneName" required>
            </div>
            <div class="form-group">
                <label>Иконка:</label>
                <select id="zoneIcon">
                    <option value="🌿">🌿 Трава</option>
                    <option value="🌳">🌳 Дерево</option>
                    <option value="🌺">🌺 Цветок</option>
                    <option value="🌻">🌻 Подсолнух</option>
                    <option value="🌹">🌹 Роза</option>
                    <option value="🌸">🌸 Сакура</option>
                    <option value="🌼">🌼 Ромашка</option>
                    <option value="🌷">🌷 Тюльпан</option>
                    <option value="🌱">🌱 Росток</option>
                    <option value="🌲">🌲 Ель</option>
                    <option value="🌴">🌴 Пальма</option>
                    <option value="🌵">🌵 Кактус</option>
                    <option value="🍀">🍀 Клевер</option>
                    <option value="🌾">🌾 Пшеница</option>
                    <option value="🌽">🌽 Кукуруза</option>
                    <option value="🥕">🥕 Морковь</option>
                    <option value="🍅">🍅 Помидор</option>
                    <option value="🥬">🥬 Салат</option>
                    <option value="🧱">🧱 Кирпич</option>
                </select>
            </div>
            <div class="form-group">
                <label>Время полива (мин):</label>
                <input type="number" id="zoneDuration" min="1" max="120" value="10" required>
            </div>
            <div class="form-group">
                <label>Группа:</label>
                <select id="zoneGroup" required>
                    <!-- Группы будут загружены динамически -->
                </select>
            </div>
            <div class="form-group">
                <label>MQTT Topic:</label>
                <input type="text" id="zoneTopic" placeholder="zone/1" required>
                <small>Топик для управления реле зоны (например: zone/1, relay/zone1)</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeZoneModal()">Отмена</button>
                <button type="submit" class="btn-primary">Добавить</button>
            </div>
        </form>
    </div>
</div>

<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Редактировать группу</div>
            <span class="close" onclick="closeGroupModal()">&times;</span>
        </div>
        <form class="modal-form" id="groupForm">
            <div class="form-group">
                <label>Название группы:</label>
                <input type="text" id="groupName" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeGroupModal()">Отмена</button>
                <button type="submit" class="btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модалка добавления группы -->
<div id="addGroupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Добавить группу</div>
      <span class="close" onclick="closeAddGroupModal()">&times;</span>
    </div>
    <form class="modal-form" id="addGroupForm">
      <div class="form-group">
        <label>Название группы:</label>
        <input type="text" id="newGroupName" placeholder="Новая группа" required>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeAddGroupModal()">Отмена</button>
        <button type="submit" class="btn-primary">Создать</button>
      </div>
    </form>
  </div>
 </div>

<!-- Модальное окно конфликтов -->
<div id="conflictModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">⚠️ Конфликт программ полива</div>
            <span class="close" onclick="closeConflictModal()">&times;</span>
        </div>
        <div id="conflictContent" style="max-height: 50vh; overflow: auto; color: #333;"></div>
        <div class="modal-actions">
            <button type="button" class="btn-primary" onclick="closeConflictModal()">Понятно</button>
        </div>
    </div>
 </div>

<!-- Модальное окно для просмотра фотографий -->
<div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
        <h3>Фотография зоны</h3>
        <img id="photoModalImg" src="" alt="Фото зоны">
        <div class="photo-modal-actions">
            <button type="button" class="btn-primary" onclick="closePhotoModal()">Закрыть</button>
        </div>
    </div>
</div>

<!-- Скрытый input для загрузки файлов -->
<input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">

{% endblock %}

{% block extra_js %}
<script>
    let zonesData = [];
    let groupsData = [];
    let modifiedZones = new Set();
    let modifiedGroups = new Set(); // Новый набор для отслеживания модифицированных групп
    let editingGroupId = null;
    let sortColumn = -1;
    let sortDirection = 'asc';
    
    // Загрузка данных
    async function loadData() {
        try {
            const [zonesRes, groupsRes, mqttRes] = await Promise.all([
                api.get('/api/zones'),
                api.get('/api/groups'),
                api.get('/api/mqtt/servers')
            ]);
            zonesData = zonesRes;
            groupsData = groupsRes;
            window.mqttServers = (mqttRes && mqttRes.servers) ? mqttRes.servers : [];
            
            renderZonesTable();
            renderGroupsGrid();
            loadGroupSelectors();
            updateZonesCount();
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            showNotification('Ошибка загрузки данных', 'error');
        }
    }
    
    // Рендеринг таблицы зон
    function renderZonesTable() {
        const tbody = document.getElementById('zones-table-body');
        tbody.innerHTML = '';
        
        zonesData.forEach(zone => {
            const row = document.createElement('tr');
            row.className = 'zone-row';
            row.dataset.zoneId = zone.id;
            
            row.innerHTML = `
                <td><input type="checkbox" class="zone-checkbox" value="${zone.id}" onchange="updateSelectedCount()"></td>
                <td style="color: #333 !important;">
                    <span class="zone-status-indicator ${zone.state === 'on' ? 'active' : 'inactive'}"></span>
                    ${zone.id}
                </td>
                <td>
                    <div class="icon-dropdown">
                        <span class="zone-icon" onclick="toggleIconDropdown(${zone.id})">${zone.icon}</span>
                        <div class="icon-dropdown-content" id="icon-dropdown-${zone.id}">
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌿')">🌿 Трава</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌳')">🌳 Дерево</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌺')">🌺 Цветок</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌻')">🌻 Подсолнух</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌹')">🌹 Роза</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌸')">🌸 Сакура</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌼')">🌼 Ромашка</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌷')">🌷 Тюльпан</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌱')">🌱 Росток</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌲')">🌲 Ель</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌴')">🌴 Пальма</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌵')">🌵 Кактус</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🍀')">🍀 Клевер</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌾')">🌾 Пшеница</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🌽')">🌽 Кукуруза</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🥕')">🥕 Морковь</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🍅')">🍅 Помидор</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🥬')">🥬 Салат</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, '🧱')">🧱 Кирпич</div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="text" class="zone-name" value="${zone.name}" 
                           onchange="updateZone(${zone.id}, 'name', this.value)">
                </td>
                <td>
                    <input type="number" class="zone-duration" value="${zone.duration}" 
                           min="1" max="120" onchange="updateZone(${zone.id}, 'duration', this.value)">
                </td>
                <td>
                    <select class="zone-group" onchange="updateZone(${zone.id}, 'group_id', this.value)">
                        ${groupsData.map(group => 
                            `<option value="${group.id}" ${zone.group_id == group.id ? 'selected' : ''}>
                                ${group.name}
                            </option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input type="text" class="zone-topic" value="${zone.topic || ''}" 
                           placeholder="zone/1" onchange="updateZone(${zone.id}, 'topic', this.value)">
                </td>
                <td>
                    <select class="zone-mqtt" onchange="updateZone(${zone.id}, 'mqtt_server_id', this.value)">
                        ${window.mqttServers.map(s => `<option value="${s.id}" ${String(zone.mqtt_server_id||'')===String(s.id)?'selected':''}>${s.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <div class="zone-photo">
                        ${zone.photo_path ? 
                            `<img src="/api/zones/${zone.id}/photo" alt="Фото зоны ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')">` :
                            `<div class="no-photo" onclick="uploadPhoto(${zone.id})">📷</div>`
                        }
                        ${zone.photo_path ? 
                            `<button class="photo-delete-btn" onclick="deletePhoto(${zone.id})">Удалить</button>` :
                            `<button class="photo-upload-btn" onclick="uploadPhoto(${zone.id})">Загрузить</button>`
                        }
                    </div>
                </td>
                <td>
                    <div class="zone-actions">
                        <button class="save-btn" onclick="saveZone(${zone.id})" disabled>💾</button>
                        <button class="start-btn" onclick="toggleZone(${zone.id})">${zone.state === 'on' ? '⏹️' : '▶️'}</button>
                        <button class="delete-btn" onclick="deleteZone(${zone.id})">🗑️</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        updateSelectedCount();
    }
    
    // Рендеринг сетки групп
    function renderGroupsGrid() {
        const container = document.getElementById('groups-grid');
        container.innerHTML = '';
        
        groupsData
            .filter(group => group.id !== 999) // скрываем БЕЗ ПОЛИВА
            .forEach(group => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.dataset.groupId = group.id;
            card.innerHTML = `
                <h4>
                    <input type="text" class="group-name" value="${group.name}" 
                           onchange="markGroupModified(${group.id})" 
                           placeholder="Название группы">
                </h4>
                <p style="color: #333 !important;">Зон: ${group.zone_count || 0}</p>
                <div class="group-actions">
                    <button class="save-btn" onclick="saveGroup(${group.id})" disabled>Сохранить</button>
                    <button class="delete-btn" onclick="deleteGroup(${group.id})">Удалить</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function markGroupModified(groupId) {
        modifiedGroups.add(groupId);
        const row = document.querySelector(`[data-group-id="${groupId}"]`);
        if (row) {
            row.classList.add('modified');
            const saveBtn = row.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }
        
        // Обновляем состояние кнопки "Сохранить все"
        updateSaveAllButton();
    }

    function updateSaveAllButton() {
        const saveAllBtn = document.getElementById('saveAllGroupsBtn');
        if (saveAllBtn) {
            saveAllBtn.disabled = modifiedGroups.size === 0;
        }
    }
    
    // Загрузка селекторов групп
    function loadGroupSelectors() {
        const selectors = ['bulkGroup', 'zoneGroup'];
        selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                selector.innerHTML = groupsData.map(group => 
                    `<option value="${group.id}">${group.name}</option>`
                ).join('');
            }
        });
    }
    
    // Обновление счетчика зон
    function updateZonesCount() {
        document.getElementById('zones-count').textContent = zonesData.length;
    }
    
    // Обновление зоны (отметка как измененной)
    function updateZone(zoneId, field, value) {
        const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
        if (row) {
            row.classList.add('modified');
            modifiedZones.add(zoneId);
            
            // Активируем кнопку сохранения
            const saveBtn = row.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }
    }
    
    // Сохранение зоны
    async function saveZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) return;
            
            const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
            const nameInput = row.querySelector('.zone-name');
            const durationInput = row.querySelector('.zone-duration');
            const groupSelect = row.querySelector('.zone-group');
            const topicInput = row.querySelector('.zone-topic');
            const mqttSelect = row.querySelector('.zone-mqtt');
            
            const updatedZone = {
                ...zone,
                name: nameInput.value,
                duration: parseInt(durationInput.value),
                group_id: parseInt(groupSelect.value)
            };
            if (topicInput) {
                updatedZone.topic = topicInput.value;
            }
            if (mqttSelect) {
                const val = mqttSelect.value;
                updatedZone.mqtt_server_id = val === '' ? null : parseInt(val);
            }

            // 1) Перед сохранением проверяем конфликты по программам
            try {
                const check = await fetch('/api/zones/check-duration-conflicts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zone_id: zoneId, new_duration: updatedZone.duration })
                });
                const result = await check.json();
                if (result && result.has_conflicts) {
                    showDurationConflictModal(result.conflicts);
                    showNotification('Обнаружены конфликты программ. Изменение не сохранено.', 'warning');
                    return; // блокируем сохранение
                }
            } catch (err) {
                console.error('Ошибка проверки конфликтов:', err);
            }
            
            const success = await api.put(`/api/zones/${zoneId}`, updatedZone);
            if (success) {
                // Обновляем данные в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex] = { ...zonesData[zoneIndex], ...updatedZone };
                }
                
                // Убираем модификацию только для этой зоны
                row.classList.remove('modified');
                modifiedZones.delete(zoneId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('Зона обновлена', 'success');
                
                // Обновляем только сетку групп, если нужно
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('Ошибка сохранения зоны:', error);
            showNotification('Ошибка сохранения зоны', 'error');
        }
    }
    
    // Удаление зоны
    async function deleteZone(zoneId) {
        if (!confirm(`Удалить зону ${zoneId}?`)) return;
        
        try {
            const success = await api.delete(`/api/zones/${zoneId}`);
            if (success) {
                // Удаляем зону из локального массива
                zonesData = zonesData.filter(z => z.id !== zoneId);
                modifiedZones.delete(zoneId);
                
                showNotification('Зона удалена', 'success');
                
                // Обновляем отображение
                renderZonesTable();
                renderGroupsGrid();
                updateZonesCount();
            }
        } catch (error) {
            console.error('Ошибка удаления зоны:', error);
            showNotification('Ошибка удаления зоны', 'error');
        }
    }

    // Показать модалку конфликтов длительности зоны
    function showDurationConflictModal(conflicts) {
        const modal = document.getElementById('conflictModal');
        const content = document.getElementById('conflictContent');
        if (!Array.isArray(conflicts) || conflicts.length === 0) {
            content.innerHTML = '<p>Конфликты не обнаружены.</p>';
        } else {
            const items = conflicts.map(c => {
                const start = toTimeString(c.overlap_start);
                const end = toTimeString(c.overlap_end);
                const groups = (c.common_groups || []).join(', ');
                const zones = (c.common_zones || []).join(', ');
                return `<li style="margin-bottom: .5rem;">
                    <div><strong>${c.checked_program_name}</strong> (${c.checked_program_time}) ↔ <strong>${c.other_program_name}</strong> (${c.other_program_time})</div>
                    <div>Пересечение: ${start} - ${end}</div>
                    ${zones ? `<div>Зоны: ${zones}</div>` : ''}
                    ${groups ? `<div>Группы: ${groups}</div>` : ''}
                </li>`;
            }).join('');
            content.innerHTML = `<p>Изменение длительности приведет к пересечению программ. Изменение не будет сохранено. Измените время зоны или расписание программ.</p><ul>${items}</ul>`;
        }
        modal.style.display = 'block';
    }

    function closeConflictModal() {
        const modal = document.getElementById('conflictModal');
        modal.style.display = 'none';
    }

    function toTimeString(totalMinutes) {
        const h = Math.floor(totalMinutes / 60) % 24;
        const m = totalMinutes % 60;
        return `${(''+h).padStart(2,'0')}:${(''+m).padStart(2,'0')}`;
    }
    
    // Запуск зоны
    async function startZone(zoneId) {
        try {
            // Проверяем, не запущена ли уже зона в той же группе
            const currentZone = zonesData.find(z => z.id === zoneId);
            if (!currentZone) {
                showNotification('Зона не найдена', 'error');
                return;
            }
            
            const activeZoneInGroup = zonesData.find(z => 
                z.group_id === currentZone.group_id && 
                z.id !== zoneId && 
                z.state === 'on'
            );
            
            if (activeZoneInGroup) {
                showNotification(`В группе уже запущена зона ${activeZoneInGroup.id}. Остановите её перед запуском новой зоны.`, 'warning');
                return;
            }
            
            const response = await api.post(`/api/zones/${zoneId}/start`);
            
            if (response.success) {
                showNotification(`Зона ${zoneId} запущена`, 'success');
                
                // Обновляем статус зоны в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'on';
                }
                
                // Обновляем отображение
                renderZonesTable();
                
                // Обновляем статус на странице статуса
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('Ошибка запуска зоны:', error);
            showNotification('Ошибка запуска зоны', 'error');
        }
    }
    
    // Остановка зоны
    async function stopZone(zoneId) {
        try {
            const response = await api.post(`/api/zones/${zoneId}/stop`);
            
            if (response.success) {
                showNotification(`Зона ${zoneId} остановлена`, 'success');
                
                // Обновляем статус зоны в локальном массиве
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'off';
                }
                
                // Обновляем отображение
                renderZonesTable();
                
                // Обновляем статус на странице статуса
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('Ошибка остановки зоны:', error);
            showNotification('Ошибка остановки зоны', 'error');
        }
    }
    
    // Переключатель пуск/стоп одной кнопкой (как на странице статус)
    async function toggleZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) {
                showNotification('Зона не найдена', 'error');
                return;
            }
            if (zone.state === 'on') {
                await stopZone(zoneId);
            } else {
                await startZone(zoneId);
            }
        } catch (e) {
            showNotification('Ошибка переключения зоны', 'error');
        }
    }
    
    // Изменение иконки зоны
    function changeZoneIcon(zoneId) {
        const icons = ['🌿', '🌳', '🌺', '🌻', '🌹', '🌸', '🌼', '🌷', '🌱', '🌲', '🌴', '🌵', '🍀', '🌾', '🌽', '🥕', '🍅', '🥬', '🧱'];
        const currentIcon = zonesData.find(z => z.id === zoneId)?.icon || '🌿';
        const currentIndex = icons.indexOf(currentIcon);
        const nextIndex = (currentIndex + 1) % icons.length;
        const newIcon = icons[nextIndex];
        
        updateZone(zoneId, 'icon', newIcon);
        const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
        if (iconElement) {
            iconElement.textContent = newIcon;
        }
    }
    
    // Массовые действия
    function updateBulkForm() {
        const action = document.getElementById('bulkAction').value;
        document.getElementById('bulkGroupSelect').style.display = action === 'group' ? 'block' : 'none';
        document.getElementById('bulkIconSelect').style.display = action === 'icon' ? 'block' : 'none';
        document.getElementById('bulkDurationSelect').style.display = action === 'duration' ? 'block' : 'none';
    }
    
    async function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        if (!action) {
            showNotification('Выберите действие', 'warning');
            return;
        }
        
        const selectedZones = Array.from(document.querySelectorAll('.zone-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selectedZones.length === 0) {
            showNotification('Выберите зоны для изменения', 'warning');
            return;
        }
        
        try {
            let value;
            switch (action) {
                case 'group':
                    value = parseInt(document.getElementById('bulkGroup').value);
                    break;
                case 'icon':
                    value = document.getElementById('bulkIcon').value;
                    break;
                case 'duration':
                    value = parseInt(document.getElementById('bulkDuration').value);
                    break;
            }
            
            // Применяем изменения ко всем выбранным зонам
            for (const zoneId of selectedZones) {
                const zone = zonesData.find(z => z.id === zoneId);
                if (zone) {
                    const updatedZone = { ...zone };
                    switch (action) {
                        case 'group':
                            updatedZone.group_id = value;
                            break;
                        case 'icon':
                            updatedZone.icon = value;
                            break;
                        case 'duration':
                            // Перед массовым сохранением проверяем конфликты
                            try {
                                const check = await fetch('/api/zones/check-duration-conflicts', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ zone_id: zoneId, new_duration: parseInt(value) })
                                });
                                const result = await check.json();
                                if (result && result.has_conflicts) {
                                    showDurationConflictModal(result.conflicts);
                                    showNotification(`Конфликт для зоны ${zoneId}. Изменение пропущено.`, 'warning');
                                    continue; // пропускаем сохранение этой зоны
                                }
                            } catch (err) {
                                console.error('Ошибка проверки конфликтов (bulk):', err);
                            }
                            updatedZone.duration = parseInt(value);
                            break;
                    }
                    
                    await api.put(`/api/zones/${zoneId}`, updatedZone);
                }
            }
            
            showNotification(`Изменения применены к ${selectedZones.length} зонам`, 'success');
            await loadData();
            
        } catch (error) {
            console.error('Ошибка массового действия:', error);
            showNotification('Ошибка применения изменений', 'error');
        }
    }
    
    // Сортировка таблицы
    function sortTable(columnIndex) {
        if (sortColumn === columnIndex) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columnIndex;
            sortDirection = 'asc';
        }
        
        // Обновляем заголовки
        document.querySelectorAll('.zones-table th').forEach((th, index) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (index === columnIndex) {
                th.classList.add(`sort-${sortDirection}`);
            }
        });
        
        // Сортируем данные
        zonesData.sort((a, b) => {
            let aVal, bVal;
            
            switch (columnIndex) {
                case 0: // № Зоны
                    aVal = a.id;
                    bVal = b.id;
                    break;
                case 1: // Иконка
                    aVal = a.icon;
                    bVal = b.icon;
                    break;
                case 2: // Название
                    aVal = a.name;
                    bVal = b.name;
                    break;
                case 3: // Время
                    aVal = a.duration;
                    bVal = b.duration;
                    break;
                case 4: // Группа
                    aVal = groupsData.find(g => g.id === a.group_id)?.name || '';
                    bVal = groupsData.find(g => g.id === b.group_id)?.name || '';
                    break;
                default:
                    return 0;
            }
            
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        renderZonesTable();
    }
    
    // Модальные окна для зон и групп
    function showZoneModal() {
        document.getElementById('zoneModal').style.display = 'block';
    }
    
    function closeZoneModal() {
        document.getElementById('zoneModal').style.display = 'none';
        document.getElementById('zoneForm').reset();
    }
    
    function editGroup(groupId, groupName) {
        editingGroupId = groupId;
        document.getElementById('groupName').value = groupName;
        document.getElementById('groupModal').style.display = 'block';
    }
    
    function closeGroupModal() {
        document.getElementById('groupModal').style.display = 'none';
        editingGroupId = null;
    }
    
    function createGroup() {
        editingGroupId = null;
        document.getElementById('groupName').value = '';
        document.getElementById('groupModal').style.display = 'block';
    }

    function showAddGroupModal() { document.getElementById('addGroupModal').style.display = 'block'; }
    function closeAddGroupModal() { document.getElementById('addGroupModal').style.display = 'none'; document.getElementById('addGroupForm').reset(); }
    
    // Обработчики форм
    document.getElementById('zoneForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const zoneData = {
            name: document.getElementById('zoneName').value,
            icon: document.getElementById('zoneIcon').value,
            duration: parseInt(document.getElementById('zoneDuration').value),
            group_id: parseInt(document.getElementById('zoneGroup').value),
            topic: document.getElementById('zoneTopic').value,
            mqtt_server_id: (window.mqttServers||[]).length === 1 ? ((window.mqttServers[0] && window.mqttServers[0].id) || null) : undefined
        };
        
        try {
            const success = await api.post('/api/zones', zoneData);
            if (success) {
                showNotification('Зона создана', 'success');
                closeZoneModal();
                await loadData();
            }
        } catch (error) {
            console.error('Ошибка создания зоны:', error);
            showNotification('Ошибка создания зоны', 'error');
        }
    });
    
    document.getElementById('groupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const groupName = document.getElementById('groupName').value;
        
        try {
            if (editingGroupId) {
                const success = await api.put(`/api/groups/${editingGroupId}`, { name: groupName });
                if (success) {
                    showNotification('Группа обновлена', 'success');
                }
            } else {
                const success = await api.post('/api/groups', { name: groupName });
                if (success) {
                    showNotification('Группа создана', 'success');
                }
            }
            
            closeGroupModal();
            await loadData();
        } catch (error) {
            console.error('Ошибка сохранения группы:', error);
            showNotification('Ошибка сохранения группы', 'error');
        }
    });

    document.getElementById('addGroupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('newGroupName').value || 'Новая группа';
        try {
            const res = await api.post('/api/groups', { name });
            if (res && (res.id || res.success)) {
                showNotification('Группа создана', 'success');
                closeAddGroupModal();
                await loadData();
            }
        } catch (err) {
            showNotification('Ошибка создания группы', 'error');
        }
    });
    
    // Закрытие модальных окон при клике вне их
    window.onclick = function(event) {
        const modals = ['zoneModal', 'groupModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // Функции для работы с чекбоксами
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateSelectedCount();
    }
    
    function selectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        document.getElementById('selectAll').checked = true;
        updateSelectedCount();
    }
    
    function deselectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.zone-checkbox:checked');
        document.getElementById('selected-count').textContent = `Выбрано: ${checkboxes.length} зон`;
    }
    
    // Функции для работы с выпадающим списком иконок
    function toggleIconDropdown(zoneId) {
        const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
        const allDropdowns = document.querySelectorAll('.icon-dropdown-content');
        
        // Закрываем все другие выпадающие списки
        allDropdowns.forEach(d => {
            if (d !== dropdown) {
                d.classList.remove('show');
            }
        });
        
        dropdown.classList.toggle('show');
    }
    
    function selectIcon(zoneId, icon) {
        const zone = zonesData.find(z => z.id === zoneId);
        if (zone) {
            zone.icon = icon;
            updateZone(zoneId, 'icon', icon);
            
            // Обновляем отображение иконки
            const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
            if (iconElement) {
                iconElement.textContent = icon;
            }
            
            // Закрываем выпадающий список
            const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
            dropdown.classList.remove('show');
        }
    }
    
    // Закрытие выпадающих списков при клике вне их
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.icon-dropdown')) {
            const dropdowns = document.querySelectorAll('.icon-dropdown-content');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });
    
    // Функции для работы с фотографиями
    let currentPhotoZoneId = null;
    
    function uploadPhoto(zoneId) {
        currentPhotoZoneId = zoneId;
        document.getElementById('photoInput').click();
    }
    
    async function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file || !currentPhotoZoneId) return;
        
        if (!file.type.startsWith('image/')) {
            showNotification('Пожалуйста, выберите изображение', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showNotification('Размер файла не должен превышать 5MB', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('photo', file);
        
        try {
            showNotification('Загрузка фотографии...', 'info');
            
            const response = await fetch(`/api/zones/${currentPhotoZoneId}/photo`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                showNotification('Фотография успешно загружена', 'success');
                await loadData(); // Перезагружаем данные
            } else {
                const error = await response.json();
                showNotification(error.message || 'Ошибка загрузки фотографии', 'error');
            }
        } catch (error) {
            console.error('Ошибка загрузки фотографии:', error);
            showNotification('Ошибка загрузки фотографии', 'error');
        }
        
        // Очищаем input
        event.target.value = '';
        currentPhotoZoneId = null;
    }
    
    async function deletePhoto(zoneId) {
        if (!confirm('Вы уверены, что хотите удалить фотографию этой зоны?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/zones/${zoneId}/photo`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Фотография удалена', 'success');
                await loadData(); // Перезагружаем данные
            } else {
                const error = await response.json();
                showNotification(error.message || 'Ошибка удаления фотографии', 'error');
            }
        } catch (error) {
            console.error('Ошибка удаления фотографии:', error);
            showNotification('Ошибка удаления фотографии', 'error');
        }
    }
    
    function showPhotoModal(photoUrl) {
        const modal = document.getElementById('photoModal');
        const img = document.getElementById('photoModalImg');
        img.src = photoUrl;
        modal.style.display = 'flex';
    }
    
    function closePhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.style.display = 'none';
    }
    
    // Закрытие модального окна фотографии при клике вне его
    document.getElementById('photoModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closePhotoModal();
        }
    });

    async function saveGroup(groupId) {
        try {
            const group = groupsData.find(g => g.id === groupId);
            if (!group) return;
            
            const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
            const nameInput = row.querySelector('.group-name');
            
            const updatedGroup = {
                ...group,
                name: nameInput.value
            };
            
            const success = await api.put(`/api/groups/${groupId}`, updatedGroup);
            if (success) {
                // Обновляем данные в локальном массиве
                const groupIndex = groupsData.findIndex(g => g.id === groupId);
                if (groupIndex !== -1) {
                    groupsData[groupIndex] = { ...groupsData[groupIndex], ...updatedGroup };
                }
                
                // Убираем модификацию только для этой группы
                row.classList.remove('modified');
                modifiedGroups.delete(groupId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('Группа обновлена', 'success');
                
                // Обновляем только сетку групп
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('Ошибка сохранения группы:', error);
            showNotification('Ошибка сохранения группы', 'error');
        }
    }

    async function saveAllGroups() {
        try {
            if (modifiedGroups.size === 0) {
                showNotification('Нет изменений для сохранения', 'info');
                return;
            }

            showNotification('Сохранение всех изменений...', 'info');
            
            // Сохраняем все измененные группы
            const savePromises = Array.from(modifiedGroups).map(groupId => {
                const group = groupsData.find(g => g.id === groupId);
                if (!group) return Promise.resolve();
                
                const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                const nameInput = row.querySelector('.group-name');
                
                const updatedGroup = {
                    ...group,
                    name: nameInput.value
                };
                
                return api.put(`/api/groups/${groupId}`, updatedGroup);
            });
            
            const results = await Promise.all(savePromises);
            const successCount = results.filter(result => result).length;
            
            if (successCount === modifiedGroups.size) {
                // Обновляем все данные в локальном массиве
                modifiedGroups.forEach(groupId => {
                    const group = groupsData.find(g => g.id === groupId);
                    if (group) {
                        const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                        const nameInput = row.querySelector('.group-name');
                        
                        const groupIndex = groupsData.findIndex(g => g.id === groupId);
                        if (groupIndex !== -1) {
                            groupsData[groupIndex].name = nameInput.value;
                        }
                        
                        // Убираем модификацию
                        row.classList.remove('modified');
                        row.querySelector('.save-btn').disabled = true;
                    }
                });
                
                modifiedGroups.clear();
                showNotification(`Сохранено ${successCount} групп`, 'success');
                
                // Обновляем сетку групп
                renderGroupsGrid();
            } else {
                showNotification('Ошибка сохранения некоторых групп', 'error');
            }
        } catch (error) {
            console.error('Ошибка массового сохранения групп:', error);
            showNotification('Ошибка сохранения групп', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm(`Удалить группу ${groupsData.find(g => g.id === groupId)?.name || groupId}?`)) {
            return;
        }

        try {
            const resp = await fetch(`/api/groups/${groupId}`, { method: 'DELETE' });
            if (resp.status === 204) {
                showNotification('Группа удалена', 'success');
                groupsData = groupsData.filter(g => g.id !== groupId);
                modifiedGroups.delete(groupId);
                renderGroupsGrid();
                await loadData(); // Перезагружаем все данные, чтобы обновить счетчик зон
            } else {
                const error = await resp.json().catch(() => ({}));
                showNotification(error.message || 'Ошибка удаления группы', 'error');
            }
        } catch (error) {
            console.error('Ошибка удаления группы:', error);
            showNotification('Ошибка удаления группы', 'error');
        }
    }
    
    // Экспорт зон в CSV
    function exportZonesCSV() {
        if (zonesData.length === 0) {
            // Создаем шаблон, если зон нет
            const template = [
                ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic'],
                ['1', 'Зона 1', '🌿', '10', '1', 'off', 'zone/1'],
                ['2', 'Зона 2', '🌳', '15', '1', 'off', 'zone/2'],
                ['3', 'Зона 3', '🌺', '20', '2', 'off', 'zone/3'],
                ['4', 'Зона 4', '🌻', '12', '2', 'off', 'zone/4'],
                ['5', 'Зона 5', '🌹', '18', '3', 'off', 'zone/5']
            ];
            
            const csv = template.map(row => row.join(',')).join('\n');
            downloadCSV(csv, 'zones_template.csv');
            showNotification('Создан шаблон CSV файла', 'info');
            return;
        }
        
        // Экспортируем существующие зоны
        const headers = ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic'];
        const csvData = [
            headers,
            ...zonesData.map(zone => [
                zone.id,
                zone.name,
                zone.icon,
                zone.duration,
                zone.group_id,
                zone.state,
                zone.topic || ''
            ])
        ];
        
        const csv = csvData.map(row => row.join(',')).join('\n');
        downloadCSV(csv, `zones_export_${new Date().toISOString().slice(0, 10)}.csv`);
        showNotification(`Экспортировано ${zonesData.length} зон`, 'success');
    }
    
    // Импорт зон из CSV
    function importZonesCSV() {
        document.getElementById('csvFileInput').click();
    }
    
    // Обработка импорта CSV файла
    async function handleCSVImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',');
            
            // Проверяем заголовки
            const requiredHeaders = ['id', 'name', 'icon', 'duration', 'group_id'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            
            if (missingHeaders.length > 0) {
                showNotification(`Неверный формат файла. Отсутствуют заголовки: ${missingHeaders.join(', ')}`, 'error');
                return;
            }
            
            const zonesToImport = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const zone = {
                    id: parseInt(values[0]),
                    name: values[1],
                    icon: values[2],
                    duration: parseInt(values[3]),
                    group_id: parseInt(values[4]),
                    state: values[5] || 'off',
                    topic: values[6] || ''
                };
                zonesToImport.push(zone);
            }
            
            if (zonesToImport.length === 0) {
                showNotification('Файл не содержит данных для импорта', 'warning');
                return;
            }
            
            if (confirm(`Импортировать ${zonesToImport.length} зон?`)) {
                await importZones(zonesToImport);
            }
            
        } catch (error) {
            console.error('Ошибка импорта CSV:', error);
            showNotification('Ошибка чтения CSV файла', 'error');
        }
        
        // Очищаем input
        event.target.value = '';
    }
    
    // Импорт зон в базу данных
    async function importZones(zonesToImport) {
        try {
            showNotification('Импорт зон...', 'info');
            
            for (const zone of zonesToImport) {
                try {
                    if (zone.id) {
                        // Обновляем существующую зону
                        await api.put(`/api/zones/${zone.id}`, zone);
                    } else {
                        // Создаем новую зону
                        await api.post('/api/zones', zone);
                    }
                } catch (error) {
                    console.error(`Ошибка импорта зоны ${zone.id}:`, error);
                }
            }
            
            // Перезагружаем данные
            await loadData();
            showNotification(`Импортировано ${zonesToImport.length} зон`, 'success');
            
        } catch (error) {
            console.error('Ошибка импорта зон:', error);
            showNotification('Ошибка импорта зон', 'error');
        }
    }
    
    // Функция для скачивания CSV файла
    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

<!-- Скрытый input для импорта CSV -->
<input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

{% endblock %}

