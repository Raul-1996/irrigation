{% extends "base.html" %}

{% block title %}–ó–æ–Ω—ã –∏ –≥—Ä—É–ø–ø—ã{% endblock %}
{% block page_title %}–ó–æ–Ω—ã –∏ –≥—Ä—É–ø–ø—ã{% endblock %}

{% block extra_css %}
<style>
    .zones-container {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .zones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .zones-count {
        background: var(--primary-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .bulk-actions h4 {
        margin: 0 0 0.5rem 0;
        color: #495057;
    }
    
    .bulk-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        align-items: end;
    }
    
    .bulk-form select,
    .bulk-form input {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .bulk-form button {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .bulk-form button:hover {
        background: #1976d2;
    }
    
    .save-all-btn {
        background: var(--success-color) !important;
        font-weight: bold;
        padding: 0.6rem 1.2rem !important;
    }
    
    .save-all-btn:hover {
        background: #45a049 !important;
    }
    
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .zones-table th,
    .zones-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .zones-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .zones-table th:hover {
        background: #e9ecef;
    }
    
    .zones-table th.sortable::after {
        content: '‚Üï';
        position: absolute;
        right: 0.5rem;
        opacity: 0.5;
    }
    
    .zones-table th.sort-asc::after {
        content: '‚Üë';
        opacity: 1;
    }
    
    .zones-table th.sort-desc::after {
        content: '‚Üì';
        opacity: 1;
    }
    
    .zone-row {
        transition: var(--transition);
    }
    
    .zone-row:hover {
        background: #f8f9fa;
    }
    
    .zone-row.modified {
        background: #fff3cd;
        border-left: 3px solid var(--warning-color);
    }
    
    .zone-icon {
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-icon:hover {
        transform: scale(1.2);
    }
    
    .zone-name {
        font-weight: 500;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
    }
    
    .zone-name:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-duration {
        font-family: 'Courier New', monospace;
        color: #495057;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.2rem;
        border-radius: 3px;
        transition: var(--transition);
        width: 60px;
    }
    
    .zone-duration:focus {
        border-color: var(--primary-color);
        background: white;
        outline: none;
    }
    
    .zone-group {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid var(--primary-color);
        transition: var(--transition);
    }
    
    .zone-group:focus {
        border-color: #1976d2;
        outline: none;
    }
    
    .zone-actions {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }
    
    .zone-actions button {
        padding: 0.3rem 0.6rem;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .zone-actions .edit-btn {
        background: var(--info-color);
        color: white;
    }
    
    .zone-actions .save-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .delete-btn {
        background: var(--danger-color);
        color: white;
    }
    
    .zone-actions .start-btn {
        background: var(--success-color);
        color: white;
    }
    
    .zone-actions .stop-btn {
        background: var(--warning-color);
        color: white;
    }
    
    .zone-actions button:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .zone-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
    .zone-photo {
        position: relative;
        display: inline-block;
    }
    
    .zone-photo img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        object-fit: cover;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo img:hover {
        transform: scale(1.1);
        border-color: var(--primary-color);
    }
    
    .zone-photo .no-photo {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #6c757d;
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .zone-photo .no-photo:hover {
        border-color: var(--primary-color);
        background: #e3f2fd;
        color: var(--primary-color);
    }
    
    .photo-upload-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-upload-btn:hover {
        background: #1976d2;
    }
    
    .photo-delete-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        cursor: pointer;
        margin-top: 0.2rem;
        transition: var(--transition);
    }
    
    .photo-delete-btn:hover {
        background: #d32f2f;
    }
    
    .photo-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .photo-modal-content {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    
    .photo-modal img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .photo-modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .photo-modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .photo-modal-actions .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .photo-modal-actions .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .photo-modal-actions button:hover {
        opacity: 0.8;
    }
    
    .groups-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .groups-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 260px));
        gap: 0.8rem;
        justify-content: start;
    }
    
    .group-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.8rem;
        border: 1px solid #e9ecef;
        transition: var(--transition);
        max-width: 320px;
    }
    
    .group-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .group-card h4 {
        margin: 0 0 0.4rem 0;
        color: #333 !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }
    
    .group-name {
        font-weight: 600;
    }
    
    .group-zone-count {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }
    
    .group-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .group-edit-btn {
        background: var(--info-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
    }
    
    .group-edit-btn:hover {
        background: #1976d2;
    }
    
    .zones-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .zone-status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        transition: background-color 0.3s ease;
    }
    
    .zone-status-indicator.active {
        background-color: #4caf50;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
    }
    
    .zone-status-indicator.inactive {
        background-color: #ccc;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
    }
    
    .close {
        color: #aaa;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .form-group label {
        font-weight: 500;
        color: #495057;
    }
    
    .form-group input,
    .form-group select {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }
    
    .modal-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: white;
    }
    
    .modal-actions button:hover {
        opacity: 0.8;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .zones-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .bulk-form {
            grid-template-columns: 1fr;
        }
        
        .zones-table {
            font-size: 0.8rem;
        }
        
        .zones-table th,
        .zones-table td {
            padding: 0.3rem;
        }
        
        .zone-actions {
            flex-direction: column;
        }
        
        .groups-grid {
            grid-template-columns: 1fr;
        }
    }

    .zone-selection {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .zone-selection button {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }
    
    #selected-count {
        font-size: 0.9rem;
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .zone-checkbox {
        margin-right: 0.5rem;
        transform: scale(1.2);
    }
    
    .icon-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .icon-dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 8px;
        padding: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .icon-dropdown-content.show {
        display: block;
    }
    
    .icon-option {
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .icon-option:hover {
        background-color: #f8f9fa;
    }
    
    .icon-option.selected {
        background-color: var(--primary-color);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- –°–µ–∫—Ü–∏—è –≥—Ä—É–ø–ø -->
<div class="groups-section">
    <div class="groups-header">
        <h3>–ì—Ä—É–ø–ø—ã –∑–æ–Ω</h3>
        <div class="groups-actions">
            <button class="btn btn-primary" onclick="saveAllGroups()" id="saveAllGroupsBtn" disabled>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã
            </button>
            <button class="btn btn-success" onclick="showAddGroupModal()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
            </button>
        </div>
    </div>
    <div class="groups-grid" id="groups-grid">
        <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</div>

<!-- –°–µ–∫—Ü–∏—è –∑–æ–Ω -->
<div class="zones-container">
    <div class="zones-header">
        <h3>üåø –ó–æ–Ω—ã –ø–æ–ª–∏–≤–∞ (<span id="zones-count">0</span>)</h3>
        <div class="zones-actions">
            <button class="group-edit-btn" onclick="exportZonesCSV()">üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button class="group-edit-btn" onclick="importZonesCSV()">üì• –ò–º–ø–æ—Ä—Ç CSV</button>
            <button class="group-edit-btn" onclick="showZoneModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É</button>
        </div>
    </div>
    
    <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="bulk-actions">
        <h4>‚ö° –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
        <div class="bulk-form">
            <div class="form-group">
                <label>–í—ã–±—Ä–∞—Ç—å –∑–æ–Ω—ã:</label>
                <div class="zone-selection">
                    <button type="button" onclick="selectAllZones()" class="btn-secondary">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button type="button" onclick="deselectAllZones()" class="btn-secondary">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                    <span id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0 –∑–æ–Ω</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>–î–µ–π—Å—Ç–≤–∏–µ:</label>
                <select id="bulkAction" onchange="updateBulkForm()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ...</option>
                    <option value="group">–ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É</option>
                    <option value="icon">–ò–∑–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫—É</option>
                    <option value="duration">–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkGroupSelect" style="display: none;">
                <label>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞:</label>
                <select id="bulkGroup">
                    <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
            
            <div class="form-group" id="bulkIconSelect" style="display: none;">
                <label>–ù–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞:</label>
                <select id="bulkIcon">
                    <option value="üåø">üåø –¢—Ä–∞–≤–∞</option>
                    <option value="üå≥">üå≥ –î–µ—Ä–µ–≤–æ</option>
                    <option value="üå∫">üå∫ –¶–≤–µ—Ç–æ–∫</option>
                    <option value="üåª">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö</option>
                    <option value="üåπ">üåπ –†–æ–∑–∞</option>
                    <option value="üå∏">üå∏ –°–∞–∫—É—Ä–∞</option>
                    <option value="üåº">üåº –†–æ–º–∞—à–∫–∞</option>
                    <option value="üå∑">üå∑ –¢—é–ª—å–ø–∞–Ω</option>
                    <option value="üå±">üå± –†–æ—Å—Ç–æ–∫</option>
                    <option value="üå≤">üå≤ –ï–ª—å</option>
                    <option value="üå¥">üå¥ –ü–∞–ª—å–º–∞</option>
                    <option value="üåµ">üåµ –ö–∞–∫—Ç—É—Å</option>
                    <option value="üçÄ">üçÄ –ö–ª–µ–≤–µ—Ä</option>
                    <option value="üåæ">üåæ –ü—à–µ–Ω–∏—Ü–∞</option>
                    <option value="üåΩ">üåΩ –ö—É–∫—É—Ä—É–∑–∞</option>
                    <option value="ü•ï">ü•ï –ú–æ—Ä–∫–æ–≤—å</option>
                    <option value="üçÖ">üçÖ –ü–æ–º–∏–¥–æ—Ä</option>
                    <option value="ü•¨">ü•¨ –°–∞–ª–∞—Ç</option>
                    <option value="üß±">üß± –ö–∏—Ä–ø–∏—á</option>
                </select>
            </div>
            
            <div class="form-group" id="bulkDurationSelect" style="display: none;">
                <label>–ù–æ–≤–æ–µ –≤—Ä–µ–º—è (–º–∏–Ω):</label>
                <input type="number" id="bulkDuration" min="1" max="120" value="10">
            </div>
            
            <button onclick="applyBulkAction()" class="save-all-btn">üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º</button>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–æ–Ω -->
    <table class="zones-table" id="zones-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th class="sortable" onclick="sortTable(0)">‚Ññ –ó–æ–Ω—ã</th>
                <th class="sortable" onclick="sortTable(1)">üéØ –ò–∫–æ–Ω–∫–∞</th>
                <th class="sortable" onclick="sortTable(2)">üìù –ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th class="sortable" onclick="sortTable(3)">‚è±Ô∏è –í—Ä–µ–º—è</th>
                <th class="sortable" onclick="sortTable(4)">üè∑Ô∏è –ì—Ä—É–ø–ø–∞</th>
                <th class="sortable" onclick="sortTable(5)">üì° MQTT Topic</th>
                <th>üñß MQTT Server</th>
                <th>üì∏ –§–æ—Ç–æ</th>
                <th>‚ö° –î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="zones-table-body">
            <!-- –ó–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="zoneModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É</div>
            <span class="close" onclick="closeZoneModal()">&times;</span>
        </div>
        <form class="modal-form" id="zoneForm">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã:</label>
                <input type="text" id="zoneName" required>
            </div>
            <div class="form-group">
                <label>–ò–∫–æ–Ω–∫–∞:</label>
                <select id="zoneIcon">
                    <option value="üåø">üåø –¢—Ä–∞–≤–∞</option>
                    <option value="üå≥">üå≥ –î–µ—Ä–µ–≤–æ</option>
                    <option value="üå∫">üå∫ –¶–≤–µ—Ç–æ–∫</option>
                    <option value="üåª">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö</option>
                    <option value="üåπ">üåπ –†–æ–∑–∞</option>
                    <option value="üå∏">üå∏ –°–∞–∫—É—Ä–∞</option>
                    <option value="üåº">üåº –†–æ–º–∞—à–∫–∞</option>
                    <option value="üå∑">üå∑ –¢—é–ª—å–ø–∞–Ω</option>
                    <option value="üå±">üå± –†–æ—Å—Ç–æ–∫</option>
                    <option value="üå≤">üå≤ –ï–ª—å</option>
                    <option value="üå¥">üå¥ –ü–∞–ª—å–º–∞</option>
                    <option value="üåµ">üåµ –ö–∞–∫—Ç—É—Å</option>
                    <option value="üçÄ">üçÄ –ö–ª–µ–≤–µ—Ä</option>
                    <option value="üåæ">üåæ –ü—à–µ–Ω–∏—Ü–∞</option>
                    <option value="üåΩ">üåΩ –ö—É–∫—É—Ä—É–∑–∞</option>
                    <option value="ü•ï">ü•ï –ú–æ—Ä–∫–æ–≤—å</option>
                    <option value="üçÖ">üçÖ –ü–æ–º–∏–¥–æ—Ä</option>
                    <option value="ü•¨">ü•¨ –°–∞–ª–∞—Ç</option>
                    <option value="üß±">üß± –ö–∏—Ä–ø–∏—á</option>
                </select>
            </div>
            <div class="form-group">
                <label>–í—Ä–µ–º—è –ø–æ–ª–∏–≤–∞ (–º–∏–Ω):</label>
                <input type="number" id="zoneDuration" min="1" max="120" value="10" required>
            </div>
            <div class="form-group">
                <label>–ì—Ä—É–ø–ø–∞:</label>
                <select id="zoneGroup" required>
                    <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
            <div class="form-group">
                <label>MQTT Topic:</label>
                <input type="text" id="zoneTopic" placeholder="zone/1" required>
                <small>–¢–æ–ø–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–µ –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: zone/1, relay/zone1)</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeZoneModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <span class="close" onclick="closeGroupModal()">&times;</span>
        </div>
        <form class="modal-form" id="groupForm">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                <input type="text" id="groupName" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeGroupModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
<div id="addGroupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</div>
      <span class="close" onclick="closeAddGroupModal()">&times;</span>
    </div>
    <form class="modal-form" id="addGroupForm">
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
        <input type="text" id="newGroupName" placeholder="–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞" required>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeAddGroupModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </form>
  </div>
 </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ -->
<div id="conflictModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–æ–≥—Ä–∞–º–º –ø–æ–ª–∏–≤–∞</div>
            <span class="close" onclick="closeConflictModal()">&times;</span>
        </div>
        <div id="conflictContent" style="max-height: 50vh; overflow: auto; color: #333;"></div>
        <div class="modal-actions">
            <button type="button" class="btn-primary" onclick="closeConflictModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>
 </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
        <h3>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∑–æ–Ω—ã</h3>
        <img id="photoModalImg" src="" alt="–§–æ—Ç–æ –∑–æ–Ω—ã">
        <div class="photo-modal-actions">
            <button type="button" class="btn-primary" onclick="closePhotoModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
<input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">

{% endblock %}

{% block extra_js %}
<script>
    let zonesData = [];
    let groupsData = [];
    let modifiedZones = new Set();
    let modifiedGroups = new Set(); // –ù–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
    let editingGroupId = null;
    let sortColumn = -1;
    let sortDirection = 'asc';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
        try {
            const [zonesRes, groupsRes, mqttRes] = await Promise.all([
                api.get('/api/zones'),
                api.get('/api/groups'),
                api.get('/api/mqtt/servers')
            ]);
            zonesData = zonesRes;
            groupsData = groupsRes;
            window.mqttServers = (mqttRes && mqttRes.servers) ? mqttRes.servers : [];
            
            renderZonesTable();
            renderGroupsGrid();
            loadGroupSelectors();
            updateZonesCount();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        }
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –∑–æ–Ω
    function renderZonesTable() {
        const tbody = document.getElementById('zones-table-body');
        tbody.innerHTML = '';
        
        zonesData.forEach(zone => {
            const row = document.createElement('tr');
            row.className = 'zone-row';
            row.dataset.zoneId = zone.id;
            
            row.innerHTML = `
                <td><input type="checkbox" class="zone-checkbox" value="${zone.id}" onchange="updateSelectedCount()"></td>
                <td style="color: #333 !important;">
                    <span class="zone-status-indicator ${zone.state === 'on' ? 'active' : 'inactive'}"></span>
                    ${zone.id}
                </td>
                <td>
                    <div class="icon-dropdown">
                        <span class="zone-icon" onclick="toggleIconDropdown(${zone.id})">${zone.icon}</span>
                        <div class="icon-dropdown-content" id="icon-dropdown-${zone.id}">
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåø')">üåø –¢—Ä–∞–≤–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå≥')">üå≥ –î–µ—Ä–µ–≤–æ</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå∫')">üå∫ –¶–≤–µ—Ç–æ–∫</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåª')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåπ')">üåπ –†–æ–∑–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå∏')">üå∏ –°–∞–∫—É—Ä–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåº')">üåº –†–æ–º–∞—à–∫–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå∑')">üå∑ –¢—é–ª—å–ø–∞–Ω</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå±')">üå± –†–æ—Å—Ç–æ–∫</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå≤')">üå≤ –ï–ª—å</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üå¥')">üå¥ –ü–∞–ª—å–º–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåµ')">üåµ –ö–∞–∫—Ç—É—Å</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üçÄ')">üçÄ –ö–ª–µ–≤–µ—Ä</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåæ')">üåæ –ü—à–µ–Ω–∏—Ü–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üåΩ')">üåΩ –ö—É–∫—É—Ä—É–∑–∞</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'ü•ï')">ü•ï –ú–æ—Ä–∫–æ–≤—å</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üçÖ')">üçÖ –ü–æ–º–∏–¥–æ—Ä</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'ü•¨')">ü•¨ –°–∞–ª–∞—Ç</div>
                            <div class="icon-option" onclick="selectIcon(${zone.id}, 'üß±')">üß± –ö–∏—Ä–ø–∏—á</div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="text" class="zone-name" value="${zone.name}" 
                           onchange="updateZone(${zone.id}, 'name', this.value)">
                </td>
                <td>
                    <input type="number" class="zone-duration" value="${zone.duration}" 
                           min="1" max="120" onchange="updateZone(${zone.id}, 'duration', this.value)">
                </td>
                <td>
                    <select class="zone-group" onchange="updateZone(${zone.id}, 'group_id', this.value)">
                        ${groupsData.map(group => 
                            `<option value="${group.id}" ${zone.group_id == group.id ? 'selected' : ''}>
                                ${group.name}
                            </option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input type="text" class="zone-topic" value="${zone.topic || ''}" 
                           placeholder="zone/1" onchange="updateZone(${zone.id}, 'topic', this.value)">
                </td>
                <td>
                    <select class="zone-mqtt" onchange="updateZone(${zone.id}, 'mqtt_server_id', this.value)">
                        ${window.mqttServers.map(s => `<option value="${s.id}" ${String(zone.mqtt_server_id||'')===String(s.id)?'selected':''}>${s.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <div class="zone-photo">
                        ${zone.photo_path ? 
                            `<img src="/api/zones/${zone.id}/photo" alt="–§–æ—Ç–æ –∑–æ–Ω—ã ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')">` :
                            `<div class="no-photo" onclick="uploadPhoto(${zone.id})">üì∑</div>`
                        }
                        ${zone.photo_path ? 
                            `<button class="photo-delete-btn" onclick="deletePhoto(${zone.id})">–£–¥–∞–ª–∏—Ç—å</button>` :
                            `<button class="photo-upload-btn" onclick="uploadPhoto(${zone.id})">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>`
                        }
                    </div>
                </td>
                <td>
                    <div class="zone-actions">
                        <button class="save-btn" onclick="saveZone(${zone.id})" disabled>üíæ</button>
                        <button class="start-btn" onclick="toggleZone(${zone.id})">${zone.state === 'on' ? '‚èπÔ∏è' : '‚ñ∂Ô∏è'}</button>
                        <button class="delete-btn" onclick="deleteZone(${zone.id})">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        updateSelectedCount();
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–µ—Ç–∫–∏ –≥—Ä—É–ø–ø
    function renderGroupsGrid() {
        const container = document.getElementById('groups-grid');
        container.innerHTML = '';
        
        groupsData
            .filter(group => group.id !== 999) // —Å–∫—Ä—ã–≤–∞–µ–º –ë–ï–ó –ü–û–õ–ò–í–ê
            .forEach(group => {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.dataset.groupId = group.id;
            card.innerHTML = `
                <h4>
                    <input type="text" class="group-name" value="${group.name}" 
                           onchange="markGroupModified(${group.id})" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </h4>
                <p style="color: #333 !important;">–ó–æ–Ω: ${group.zone_count || 0}</p>
                <div class="group-actions">
                    <button class="save-btn" onclick="saveGroup(${group.id})" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="delete-btn" onclick="deleteGroup(${group.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function markGroupModified(groupId) {
        modifiedGroups.add(groupId);
        const row = document.querySelector(`[data-group-id="${groupId}"]`);
        if (row) {
            row.classList.add('modified');
            const saveBtn = row.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ"
        updateSaveAllButton();
    }

    function updateSaveAllButton() {
        const saveAllBtn = document.getElementById('saveAllGroupsBtn');
        if (saveAllBtn) {
            saveAllBtn.disabled = modifiedGroups.size === 0;
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –≥—Ä—É–ø–ø
    function loadGroupSelectors() {
        const selectors = ['bulkGroup', 'zoneGroup'];
        selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                selector.innerHTML = groupsData.map(group => 
                    `<option value="${group.id}">${group.name}</option>`
                ).join('');
            }
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∑–æ–Ω
    function updateZonesCount() {
        document.getElementById('zones-count').textContent = zonesData.length;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–æ–Ω—ã (–æ—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–π)
    function updateZone(zoneId, field, value) {
        const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
        if (row) {
            row.classList.add('modified');
            modifiedZones.add(zoneId);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = row.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–æ–Ω—ã
    async function saveZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) return;
            
            const row = document.querySelector(`tr[data-zone-id="${zoneId}"]`);
            const nameInput = row.querySelector('.zone-name');
            const durationInput = row.querySelector('.zone-duration');
            const groupSelect = row.querySelector('.zone-group');
            const topicInput = row.querySelector('.zone-topic');
            const mqttSelect = row.querySelector('.zone-mqtt');
            
            const updatedZone = {
                ...zone,
                name: nameInput.value,
                duration: parseInt(durationInput.value),
                group_id: parseInt(groupSelect.value)
            };
            if (topicInput) {
                updatedZone.topic = topicInput.value;
            }
            if (mqttSelect) {
                const val = mqttSelect.value;
                updatedZone.mqtt_server_id = val === '' ? null : parseInt(val);
            }

            // 1) –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º
            try {
                const check = await fetch('/api/zones/check-duration-conflicts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zone_id: zoneId, new_duration: updatedZone.duration })
                });
                const result = await check.json();
                if (result && result.has_conflicts) {
                    showDurationConflictModal(result.conflicts);
                    showNotification('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.', 'warning');
                    return; // –±–ª–æ–∫–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:', err);
            }
            
            const success = await api.put(`/api/zones/${zoneId}`, updatedZone);
            if (success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex] = { ...zonesData[zoneIndex], ...updatedZone };
                }
                
                // –£–±–∏—Ä–∞–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –∑–æ–Ω—ã
                row.classList.remove('modified');
                modifiedZones.delete(zoneId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('–ó–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ç–∫—É –≥—Ä—É–ø–ø, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã', 'error');
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã
    async function deleteZone(zoneId) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É ${zoneId}?`)) return;
        
        try {
            const success = await api.delete(`/api/zones/${zoneId}`);
            if (success) {
                // –£–¥–∞–ª—è–µ–º –∑–æ–Ω—É –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
                zonesData = zonesData.filter(z => z.id !== zoneId);
                modifiedZones.delete(zoneId);
                
                showNotification('–ó–æ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                renderZonesTable();
                renderGroupsGrid();
                updateZonesCount();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã', 'error');
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–æ–Ω—ã
    function showDurationConflictModal(conflicts) {
        const modal = document.getElementById('conflictModal');
        const content = document.getElementById('conflictContent');
        if (!Array.isArray(conflicts) || conflicts.length === 0) {
            content.innerHTML = '<p>–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.</p>';
        } else {
            const items = conflicts.map(c => {
                const start = toTimeString(c.overlap_start);
                const end = toTimeString(c.overlap_end);
                const groups = (c.common_groups || []).join(', ');
                const zones = (c.common_zones || []).join(', ');
                return `<li style="margin-bottom: .5rem;">
                    <div><strong>${c.checked_program_name}</strong> (${c.checked_program_time}) ‚Üî <strong>${c.other_program_name}</strong> (${c.other_program_time})</div>
                    <div>–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: ${start} - ${end}</div>
                    ${zones ? `<div>–ó–æ–Ω—ã: ${zones}</div>` : ''}
                    ${groups ? `<div>–ì—Ä—É–ø–ø—ã: ${groups}</div>` : ''}
                </li>`;
            }).join('');
            content.innerHTML = `<p>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—é –ø—Ä–æ–≥—Ä–∞–º–º. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä–µ–º—è –∑–æ–Ω—ã –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º.</p><ul>${items}</ul>`;
        }
        modal.style.display = 'block';
    }

    function closeConflictModal() {
        const modal = document.getElementById('conflictModal');
        modal.style.display = 'none';
    }

    function toTimeString(totalMinutes) {
        const h = Math.floor(totalMinutes / 60) % 24;
        const m = totalMinutes % 60;
        return `${(''+h).padStart(2,'0')}:${(''+m).padStart(2,'0')}`;
    }
    
    // –ó–∞–ø—É—Å–∫ –∑–æ–Ω—ã
    async function startZone(zoneId) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ –ª–∏ —É–∂–µ –∑–æ–Ω–∞ –≤ —Ç–æ–π –∂–µ –≥—Ä—É–ø–ø–µ
            const currentZone = zonesData.find(z => z.id === zoneId);
            if (!currentZone) {
                showNotification('–ó–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            
            const activeZoneInGroup = zonesData.find(z => 
                z.group_id === currentZone.group_id && 
                z.id !== zoneId && 
                z.state === 'on'
            );
            
            if (activeZoneInGroup) {
                showNotification(`–í –≥—Ä—É–ø–ø–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞ –∑–æ–Ω–∞ ${activeZoneInGroup.id}. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–π –∑–æ–Ω—ã.`, 'warning');
                return;
            }
            
            const response = await api.post(`/api/zones/${zoneId}/start`);
            
            if (response.success) {
                showNotification(`–ó–æ–Ω–∞ ${zoneId} –∑–∞–ø—É—â–µ–Ω–∞`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–æ–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'on';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                renderZonesTable();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ç–∞—Ç—É—Å–∞
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–æ–Ω—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–æ–Ω—ã', 'error');
        }
    }
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–æ–Ω—ã
    async function stopZone(zoneId) {
        try {
            const response = await api.post(`/api/zones/${zoneId}/stop`);
            
            if (response.success) {
                showNotification(`–ó–æ–Ω–∞ ${zoneId} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–æ–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                const zoneIndex = zonesData.findIndex(z => z.id === zoneId);
                if (zoneIndex !== -1) {
                    zonesData[zoneIndex].state = 'off';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                renderZonesTable();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ç–∞—Ç—É—Å–∞
                if (window.location.pathname === '/') {
                    loadStatusData();
                }
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–æ–Ω—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–æ–Ω—ã', 'error');
        }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø—É—Å–∫/—Å—Ç–æ–ø –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ç–∞—Ç—É—Å)
    async function toggleZone(zoneId) {
        try {
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) {
                showNotification('–ó–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            if (zone.state === 'on') {
                await stopZone(zoneId);
            } else {
                await startZone(zoneId);
            }
        } catch (e) {
            showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–æ–Ω—ã', 'error');
        }
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∑–æ–Ω—ã
    function changeZoneIcon(zoneId) {
        const icons = ['üåø', 'üå≥', 'üå∫', 'üåª', 'üåπ', 'üå∏', 'üåº', 'üå∑', 'üå±', 'üå≤', 'üå¥', 'üåµ', 'üçÄ', 'üåæ', 'üåΩ', 'ü•ï', 'üçÖ', 'ü•¨', 'üß±'];
        const currentIcon = zonesData.find(z => z.id === zoneId)?.icon || 'üåø';
        const currentIndex = icons.indexOf(currentIcon);
        const nextIndex = (currentIndex + 1) % icons.length;
        const newIcon = icons[nextIndex];
        
        updateZone(zoneId, 'icon', newIcon);
        const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
        if (iconElement) {
            iconElement.textContent = newIcon;
        }
    }
    
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    function updateBulkForm() {
        const action = document.getElementById('bulkAction').value;
        document.getElementById('bulkGroupSelect').style.display = action === 'group' ? 'block' : 'none';
        document.getElementById('bulkIconSelect').style.display = action === 'icon' ? 'block' : 'none';
        document.getElementById('bulkDurationSelect').style.display = action === 'duration' ? 'block' : 'none';
    }
    
    async function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        if (!action) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', 'warning');
            return;
        }
        
        const selectedZones = Array.from(document.querySelectorAll('.zone-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selectedZones.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è', 'warning');
            return;
        }
        
        try {
            let value;
            switch (action) {
                case 'group':
                    value = parseInt(document.getElementById('bulkGroup').value);
                    break;
                case 'icon':
                    value = document.getElementById('bulkIcon').value;
                    break;
                case 'duration':
                    value = parseInt(document.getElementById('bulkDuration').value);
                    break;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ –≤—Å–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∑–æ–Ω–∞–º
            for (const zoneId of selectedZones) {
                const zone = zonesData.find(z => z.id === zoneId);
                if (zone) {
                    const updatedZone = { ...zone };
                    switch (action) {
                        case 'group':
                            updatedZone.group_id = value;
                            break;
                        case 'icon':
                            updatedZone.icon = value;
                            break;
                        case 'duration':
                            // –ü–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
                            try {
                                const check = await fetch('/api/zones/check-duration-conflicts', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ zone_id: zoneId, new_duration: parseInt(value) })
                                });
                                const result = await check.json();
                                if (result && result.has_conflicts) {
                                    showDurationConflictModal(result.conflicts);
                                    showNotification(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–ª—è –∑–æ–Ω—ã ${zoneId}. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ.`, 'warning');
                                    continue; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç—Ç–æ–π –∑–æ–Ω—ã
                                }
                            } catch (err) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (bulk):', err);
                            }
                            updatedZone.duration = parseInt(value);
                            break;
                    }
                    
                    await api.put(`/api/zones/${zoneId}`, updatedZone);
                }
            }
            
            showNotification(`–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ ${selectedZones.length} –∑–æ–Ω–∞–º`, 'success');
            await loadData();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'error');
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function sortTable(columnIndex) {
        if (sortColumn === columnIndex) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columnIndex;
            sortDirection = 'asc';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        document.querySelectorAll('.zones-table th').forEach((th, index) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (index === columnIndex) {
                th.classList.add(`sort-${sortDirection}`);
            }
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        zonesData.sort((a, b) => {
            let aVal, bVal;
            
            switch (columnIndex) {
                case 0: // ‚Ññ –ó–æ–Ω—ã
                    aVal = a.id;
                    bVal = b.id;
                    break;
                case 1: // –ò–∫–æ–Ω–∫–∞
                    aVal = a.icon;
                    bVal = b.icon;
                    break;
                case 2: // –ù–∞–∑–≤–∞–Ω–∏–µ
                    aVal = a.name;
                    bVal = b.name;
                    break;
                case 3: // –í—Ä–µ–º—è
                    aVal = a.duration;
                    bVal = b.duration;
                    break;
                case 4: // –ì—Ä—É–ø–ø–∞
                    aVal = groupsData.find(g => g.id === a.group_id)?.name || '';
                    bVal = groupsData.find(g => g.id === b.group_id)?.name || '';
                    break;
                default:
                    return 0;
            }
            
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        renderZonesTable();
    }
    
    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∑–æ–Ω –∏ –≥—Ä—É–ø–ø
    function showZoneModal() {
        document.getElementById('zoneModal').style.display = 'block';
    }
    
    function closeZoneModal() {
        document.getElementById('zoneModal').style.display = 'none';
        document.getElementById('zoneForm').reset();
    }
    
    function editGroup(groupId, groupName) {
        editingGroupId = groupId;
        document.getElementById('groupName').value = groupName;
        document.getElementById('groupModal').style.display = 'block';
    }
    
    function closeGroupModal() {
        document.getElementById('groupModal').style.display = 'none';
        editingGroupId = null;
    }
    
    function createGroup() {
        editingGroupId = null;
        document.getElementById('groupName').value = '';
        document.getElementById('groupModal').style.display = 'block';
    }

    function showAddGroupModal() { document.getElementById('addGroupModal').style.display = 'block'; }
    function closeAddGroupModal() { document.getElementById('addGroupModal').style.display = 'none'; document.getElementById('addGroupForm').reset(); }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
    document.getElementById('zoneForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const zoneData = {
            name: document.getElementById('zoneName').value,
            icon: document.getElementById('zoneIcon').value,
            duration: parseInt(document.getElementById('zoneDuration').value),
            group_id: parseInt(document.getElementById('zoneGroup').value),
            topic: document.getElementById('zoneTopic').value,
            mqtt_server_id: (window.mqttServers||[]).length === 1 ? ((window.mqttServers[0] && window.mqttServers[0].id) || null) : undefined
        };
        
        try {
            const success = await api.post('/api/zones', zoneData);
            if (success) {
                showNotification('–ó–æ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                closeZoneModal();
                await loadData();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã', 'error');
        }
    });
    
    document.getElementById('groupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const groupName = document.getElementById('groupName').value;
        
        try {
            if (editingGroupId) {
                const success = await api.put(`/api/groups/${editingGroupId}`, { name: groupName });
                if (success) {
                    showNotification('–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                }
            } else {
                const success = await api.post('/api/groups', { name: groupName });
                if (success) {
                    showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                }
            }
            
            closeGroupModal();
            await loadData();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
        }
    });

    document.getElementById('addGroupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('newGroupName').value || '–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞';
        try {
            const res = await api.post('/api/groups', { name });
            if (res && (res.id || res.success)) {
                showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                closeAddGroupModal();
                await loadData();
            }
        } catch (err) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    window.onclick = function(event) {
        const modals = ['zoneModal', 'groupModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateSelectedCount();
    }
    
    function selectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        document.getElementById('selectAll').checked = true;
        updateSelectedCount();
    }
    
    function deselectAllZones() {
        const checkboxes = document.querySelectorAll('.zone-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.zone-checkbox:checked');
        document.getElementById('selected-count').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${checkboxes.length} –∑–æ–Ω`;
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º –∏–∫–æ–Ω–æ–∫
    function toggleIconDropdown(zoneId) {
        const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
        const allDropdowns = document.querySelectorAll('.icon-dropdown-content');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        allDropdowns.forEach(d => {
            if (d !== dropdown) {
                d.classList.remove('show');
            }
        });
        
        dropdown.classList.toggle('show');
    }
    
    function selectIcon(zoneId, icon) {
        const zone = zonesData.find(z => z.id === zoneId);
        if (zone) {
            zone.icon = icon;
            updateZone(zoneId, 'icon', icon);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
            const iconElement = document.querySelector(`tr[data-zone-id="${zoneId}"] .zone-icon`);
            if (iconElement) {
                iconElement.textContent = icon;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            const dropdown = document.getElementById(`icon-dropdown-${zoneId}`);
            dropdown.classList.remove('show');
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.icon-dropdown')) {
            const dropdowns = document.querySelectorAll('.icon-dropdown-content');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
    let currentPhotoZoneId = null;
    
    function uploadPhoto(zoneId) {
        currentPhotoZoneId = zoneId;
        document.getElementById('photoInput').click();
    }
    
    async function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file || !currentPhotoZoneId) return;
        
        if (!file.type.startsWith('image/')) {
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showNotification('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('photo', file);
        
        try {
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...', 'info');
            
            const response = await fetch(`/api/zones/${currentPhotoZoneId}/photo`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                showNotification('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                await loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            } else {
                const error = await response.json();
                showNotification(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'error');
        }
        
        // –û—á–∏—â–∞–µ–º input
        event.target.value = '';
        currentPhotoZoneId = null;
    }
    
    async function deletePhoto(zoneId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —ç—Ç–æ–π –∑–æ–Ω—ã?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/zones/${zoneId}/photo`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                await loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            } else {
                const error = await response.json();
                showNotification(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', 'error');
        }
    }
    
    function showPhotoModal(photoUrl) {
        const modal = document.getElementById('photoModal');
        const img = document.getElementById('photoModalImg');
        img.src = photoUrl;
        modal.style.display = 'flex';
    }
    
    function closePhotoModal() {
        const modal = document.getElementById('photoModal');
        modal.style.display = 'none';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('photoModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closePhotoModal();
        }
    });

    async function saveGroup(groupId) {
        try {
            const group = groupsData.find(g => g.id === groupId);
            if (!group) return;
            
            const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
            const nameInput = row.querySelector('.group-name');
            
            const updatedGroup = {
                ...group,
                name: nameInput.value
            };
            
            const success = await api.put(`/api/groups/${groupId}`, updatedGroup);
            if (success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                const groupIndex = groupsData.findIndex(g => g.id === groupId);
                if (groupIndex !== -1) {
                    groupsData[groupIndex] = { ...groupsData[groupIndex], ...updatedGroup };
                }
                
                // –£–±–∏—Ä–∞–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                row.classList.remove('modified');
                modifiedGroups.delete(groupId);
                row.querySelector('.save-btn').disabled = true;
                showNotification('–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ç–∫—É –≥—Ä—É–ø–ø
                renderGroupsGrid();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
        }
    }

    async function saveAllGroups() {
        try {
            if (modifiedGroups.size === 0) {
                showNotification('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'info');
                return;
            }

            showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'info');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã
            const savePromises = Array.from(modifiedGroups).map(groupId => {
                const group = groupsData.find(g => g.id === groupId);
                if (!group) return Promise.resolve();
                
                const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                const nameInput = row.querySelector('.group-name');
                
                const updatedGroup = {
                    ...group,
                    name: nameInput.value
                };
                
                return api.put(`/api/groups/${groupId}`, updatedGroup);
            });
            
            const results = await Promise.all(savePromises);
            const successCount = results.filter(result => result).length;
            
            if (successCount === modifiedGroups.size) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                modifiedGroups.forEach(groupId => {
                    const group = groupsData.find(g => g.id === groupId);
                    if (group) {
                        const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
                        const nameInput = row.querySelector('.group-name');
                        
                        const groupIndex = groupsData.findIndex(g => g.id === groupId);
                        if (groupIndex !== -1) {
                            groupsData[groupIndex].name = nameInput.value;
                        }
                        
                        // –£–±–∏—Ä–∞–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é
                        row.classList.remove('modified');
                        row.querySelector('.save-btn').disabled = true;
                    }
                });
                
                modifiedGroups.clear();
                showNotification(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${successCount} –≥—Ä—É–ø–ø`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É –≥—Ä—É–ø–ø
                renderGroupsGrid();
            } else {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≥—Ä—É–ø–ø', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ${groupsData.find(g => g.id === groupId)?.name || groupId}?`)) {
            return;
        }

        try {
            const resp = await fetch(`/api/groups/${groupId}`, { method: 'DELETE' });
            if (resp.status === 204) {
                showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                groupsData = groupsData.filter(g => g.id !== groupId);
                modifiedGroups.delete(groupId);
                renderGroupsGrid();
                await loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∑–æ–Ω
            } else {
                const error = await resp.json().catch(() => ({}));
                showNotification(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
        }
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –∑–æ–Ω –≤ CSV
    function exportZonesCSV() {
        if (zonesData.length === 0) {
            // –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω, –µ—Å–ª–∏ –∑–æ–Ω –Ω–µ—Ç
            const template = [
                ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic'],
                ['1', '–ó–æ–Ω–∞ 1', 'üåø', '10', '1', 'off', 'zone/1'],
                ['2', '–ó–æ–Ω–∞ 2', 'üå≥', '15', '1', 'off', 'zone/2'],
                ['3', '–ó–æ–Ω–∞ 3', 'üå∫', '20', '2', 'off', 'zone/3'],
                ['4', '–ó–æ–Ω–∞ 4', 'üåª', '12', '2', 'off', 'zone/4'],
                ['5', '–ó–æ–Ω–∞ 5', 'üåπ', '18', '3', 'off', 'zone/5']
            ];
            
            const csv = template.map(row => row.join(',')).join('\n');
            downloadCSV(csv, 'zones_template.csv');
            showNotification('–°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω CSV —Ñ–∞–π–ª–∞', 'info');
            return;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–æ–Ω—ã
        const headers = ['id', 'name', 'icon', 'duration', 'group_id', 'state', 'topic'];
        const csvData = [
            headers,
            ...zonesData.map(zone => [
                zone.id,
                zone.name,
                zone.icon,
                zone.duration,
                zone.group_id,
                zone.state,
                zone.topic || ''
            ])
        ];
        
        const csv = csvData.map(row => row.join(',')).join('\n');
        downloadCSV(csv, `zones_export_${new Date().toISOString().slice(0, 10)}.csv`);
        showNotification(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${zonesData.length} –∑–æ–Ω`, 'success');
    }
    
    // –ò–º–ø–æ—Ä—Ç –∑–æ–Ω –∏–∑ CSV
    function importZonesCSV() {
        document.getElementById('csvFileInput').click();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV —Ñ–∞–π–ª–∞
    async function handleCSVImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const requiredHeaders = ['id', 'name', 'icon', 'duration', 'group_id'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            
            if (missingHeaders.length > 0) {
                showNotification(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏: ${missingHeaders.join(', ')}`, 'error');
                return;
            }
            
            const zonesToImport = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const zone = {
                    id: parseInt(values[0]),
                    name: values[1],
                    icon: values[2],
                    duration: parseInt(values[3]),
                    group_id: parseInt(values[4]),
                    state: values[5] || 'off',
                    topic: values[6] || ''
                };
                zonesToImport.push(zone);
            }
            
            if (zonesToImport.length === 0) {
                showNotification('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            if (confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${zonesToImport.length} –∑–æ–Ω?`)) {
                await importZones(zonesToImport);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV:', error);
            showNotification('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV —Ñ–∞–π–ª–∞', 'error');
        }
        
        // –û—á–∏—â–∞–µ–º input
        event.target.value = '';
    }
    
    // –ò–º–ø–æ—Ä—Ç –∑–æ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    async function importZones(zonesToImport) {
        try {
            showNotification('–ò–º–ø–æ—Ä—Ç –∑–æ–Ω...', 'info');
            
            for (const zone of zonesToImport) {
                try {
                    if (zone.id) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–æ–Ω—É
                        await api.put(`/api/zones/${zone.id}`, zone);
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–æ–Ω—É
                        await api.post('/api/zones', zone);
                    }
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∑–æ–Ω—ã ${zone.id}:`, error);
                }
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadData();
            showNotification(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${zonesToImport.length} –∑–æ–Ω`, 'success');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∑–æ–Ω:', error);
            showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∑–æ–Ω', 'error');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV —Ñ–∞–π–ª–∞
    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ CSV -->
<input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

{% endblock %}

