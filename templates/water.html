{% extends "base.html" %}

{% block title %}–†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã{% endblock %}
{% block page_title %}–†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã{% endblock %}

{% block extra_css %}
<style>
    .water-container {
        background: white;
        border-radius: 8px;
        padding: 0.8rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 0.8rem;
    }
    
    .water-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .group-selector {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .group-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 20px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }
    
    .group-btn.active {
        background: var(--primary-color);
        color: white;
    }
    
    .group-btn:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .water-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
        margin-bottom: 0.8rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), #1976d2);
        color: white;
        padding: 0.8rem;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 0.8rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 0.8rem;
        height: 350px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ª–µ–≥–µ–Ω–¥—ã */
        overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #495057;
    }
    
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .zones-table th,
    .zones-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #eee;
        color: #333 !important;
    }
    
    .zones-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .usage-bar {
        background: #e9ecef;
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        position: relative;
    }
    
    .usage-fill {
        background: linear-gradient(90deg, var(--primary-color), #1976d2);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .usage-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .no-data {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        font-style: italic;
    }
    
    @media (max-width: 768px) {
        .water-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .group-selector {
            justify-content: center;
        }
        
        .water-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="water-container">
    <div class="water-header">
        <h3>üíß –†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã –ø–æ –≥—Ä—É–ø–ø–∞–º</h3>
        <div class="group-selector" id="groupSelector">
            <!-- –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <div class="water-stats" id="waterStats">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</div>

<div class="chart-container">
    <div class="chart-title">üìä –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–∞ –≤–æ–¥—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
    <canvas id="waterChart" width="400" height="200"></canvas>
</div>

<div class="water-container">
    <div class="chart-title">üåø –†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã –ø–æ –∑–æ–Ω–∞–º</div>
    <table class="zones-table" id="zonesTable">
        <thead>
            <tr>
                <th>–ó–æ–Ω–∞</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–†–∞—Å—Ö–æ–¥ (–ª)</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                <th>–ì—Ä–∞—Ñ–∏–∫</th>
            </tr>
        </thead>
        <tbody id="zonesTableBody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let waterData = {};
    let currentGroup = null;
    let waterChart = null;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–æ–¥–µ
    async function loadWaterData() {
        try {
            waterData = await api.get('/api/water');
            renderGroupSelector();
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const firstGroup = Object.keys(waterData)[0];
            if (firstGroup) {
                selectGroup(firstGroup);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –≤–æ–¥–µ:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –≤–æ–¥–µ', 'error');
        }
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –≥—Ä—É–ø–ø
    function renderGroupSelector() {
        const selector = document.getElementById('groupSelector');
        selector.innerHTML = '';
        
        Object.keys(waterData).forEach(groupId => {
            const group = waterData[groupId];
            const button = document.createElement('button');
            button.className = 'group-btn';
            button.textContent = group.group_name;
            button.onclick = () => selectGroup(groupId);
            selector.appendChild(button);
        });
    }
    
    // –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
    function selectGroup(groupId) {
        currentGroup = groupId;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.group-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
        const activeBtn = document.querySelector(`[onclick="selectGroup('${groupId}')"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        renderWaterStats();
        renderWaterChart();
        renderZonesTable();
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderWaterStats() {
        if (!currentGroup || !waterData[currentGroup]) return;
        
        const group = waterData[currentGroup];
        const stats = document.getElementById('waterStats');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
        const totalLiters = group.data?.total_liters || 0;
        const zoneCount = Object.keys(group.data?.zone_usage || {}).length;
        const avgDaily = Math.round(totalLiters / 7);
        const avgPerZone = zoneCount > 0 ? Math.round(totalLiters / zoneCount) : 0;
        
        stats.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${totalLiters.toLocaleString()}</div>
                <div class="stat-label">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ (–ª)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${avgDaily}</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å (–ª)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${zoneCount}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–æ–Ω</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${avgPerZone}</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –∑–æ–Ω—É (–ª)</div>
            </div>
        `;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–∞
    function renderWaterChart() {
        if (!currentGroup || !waterData[currentGroup]) return;
        
        const group = waterData[currentGroup];
        const ctx = document.getElementById('waterChart').getContext('2d');
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
        if (waterChart) {
            waterChart.destroy();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const dailyUsage = group.data?.daily_usage || [];
        const labels = dailyUsage.length > 0 ? 
            dailyUsage.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            }).reverse() : 
            ['08.08', '09.08', '10.08', '11.08', '12.08', '13.08', '14.08'];
        
        const data = dailyUsage.length > 0 ? 
            dailyUsage.map(item => item.liters).reverse() : 
            [0, 0, 0, 0, 0, 0, 0];
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: `–†–∞—Å—Ö–æ–¥ –≤–æ–¥—ã - ${group.group_name}`,
                data: data,
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        };
        
        waterChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: data.length > 0 && Math.max(...data) > 0 ? Math.max(...data) * 1.2 : 100, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Å—å Y
                        title: {
                            display: true,
                            text: '–õ–∏—Ç—Ä—ã'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–î–∞—Ç–∞'
                        },
                        ticks: {
                            maxRotation: 0, // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç –ø–æ–¥–ø–∏—Å–µ–π
                            padding: 5
                        }
                    }
                },
                layout: {
                    padding: {
                        bottom: 20 // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã
                    }
                }
            }
        });
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –∑–æ–Ω
    function renderZonesTable() {
        if (!currentGroup || !waterData[currentGroup]) return;
        
        const group = waterData[currentGroup];
        const tbody = document.getElementById('zonesTableBody');
        tbody.innerHTML = '';
        
        // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        const maxUsage = Math.max(...Object.values(group.data.zone_usage).map(zone => zone.liters));
        
        Object.entries(group.data.zone_usage).forEach(([zoneId, zone]) => {
            const percentage = maxUsage > 0 ? (zone.liters / maxUsage) * 100 : 0;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${zoneId}</td>
                <td>${zone.name}</td>
                <td>${zone.liters} –ª</td>
                <td>${zone.last_used}</td>
                <td style="width: 200px;">
                    <div class="usage-bar">
                        <div class="usage-fill" style="width: ${percentage}%"></div>
                        <div class="usage-text">${zone.liters} –ª</div>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        loadWaterData();
    });
</script>
{% endblock %}
