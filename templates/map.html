{% extends "base.html" %}

{% block title %}Карта зон{% endblock %}
{% block page_title %}Карта зон{% endblock %}

{% block extra_css %}
<style>
  .map-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .map-list { display:flex; flex-direction: column; gap: 1rem; }
  .map-item { position: relative; }
  .map-actions { position:absolute; top:.5rem; right:.5rem; display:flex; gap:.3rem; }
  .btn-danger { background:#f44336; color:#fff; }
  .btn-delete-circle { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; line-height:1; }
  .map-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }
  .upload-area {
    margin-top: 1rem;
    display: flex;
    gap: .5rem;
    align-items: center;
  }
  .upload-area input[type=file] { display: none; }
  .btn { padding: .5rem 1rem; border: none; border-radius: 5px; cursor: pointer; }
  .btn-primary { background: var(--primary-color); color: white; }
  .hint { color: #666; font-size: .9rem; }
  .placeholder { text-align: center; color: #666; padding: 2rem 1rem; border: 2px dashed #ccc; border-radius: 8px; }
  .placeholder strong { display:block; margin-bottom:.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="map-card">
  <div id="map-container" class="map-list"></div>
  <div class="upload-area">
    <label for="mapFile" class="btn btn-primary">Загрузить карту</label>
    <input id="mapFile" type="file" accept="image/*" />
    <span class="hint">Поддерживаются изображения JPG, PNG, GIF, WEBP.</span>
  </div>
  <div id="uploadStatus" class="hint"></div>
 </div>
{% endblock %}

{% block extra_js %}
<script>
async function loadMap() {
  try {
    const res = await api.get('/api/map');
    const container = document.getElementById('map-container');
    container.innerHTML = '';
    const items = (res && res.items) || [];
    if (!items.length) {
      container.innerHTML = '<div class="placeholder"><strong>Карта не загружена</strong><span>Загрузите изображение с визуализацией зон.</span></div>';
      return;
    }
    const canManage = Boolean(window.AUTH_ROLE === 'admin');
    items.forEach(it => {
      const wrap = document.createElement('div');
      wrap.className = 'map-item';
      const img = document.createElement('img');
      img.src = '/static/' + it.path + '?t=' + Date.now();
      img.alt = it.name;
      img.className = 'map-image';
      wrap.appendChild(img);
      if (canManage) {
        const actions = document.createElement('div');
        actions.className = 'map-actions';
        const del = document.createElement('button');
        del.className = 'btn btn-danger btn-delete-circle';
        del.title = 'Удалить карту';
        del.textContent = '✖';
        del.addEventListener('click', async ()=>{
          if (!confirm('Вы точно хотите удалить это фото карты?')) return;
          const r = await fetch('/api/map/' + encodeURIComponent(it.name), {method:'DELETE'});
          const d = await r.json().catch(()=>({}));
          if (r.ok && d && d.success) { showNotification('Удалено', 'success'); loadMap(); }
          else { showNotification((d&&d.message)||'Ошибка удаления', 'error'); }
        });
        actions.appendChild(del);
        wrap.appendChild(actions);
      }
      container.appendChild(wrap);
    });
  } catch (e) {
    showNotification('Ошибка загрузки карты', 'error');
  }
}

document.getElementById('mapFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);
  try {
    const res = await fetch('/api/map', { method: 'POST', body: formData });
    const data = await res.json();
    if (data && data.success) {
      showNotification('Карта загружена', 'success');
      loadMap();
    } else {
      showNotification(data.message || 'Ошибка загрузки карты', 'error');
    }
  } catch (e) {
    showNotification('Ошибка загрузки карты', 'error');
  } finally {
    e.target.value = '';
  }
});

document.addEventListener('DOMContentLoaded', ()=>{
  // Получаем роль: показываем крестики только админу
  fetch('/api/auth/status').then(r=>r.json()).then(st=>{
    if (st && st.role) {
      window.AUTH_ROLE = st.role;
    } else {
      window.AUTH_ROLE = sessionStorage.getItem('role') || 'guest';
    }
    loadMap();
  }).catch(()=>{
    window.AUTH_ROLE = sessionStorage.getItem('role') || 'guest';
    loadMap();
  });
});
</script>
{% endblock %}


