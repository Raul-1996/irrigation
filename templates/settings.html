{% extends "base.html" %}
{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block page_title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block extra_css %}
<style>
  .settings-page{max-width:560px; margin:0 auto; padding:10px 12px}
  .settings-card{background:#fff; border:1px solid var(--border-color, #e5e7eb); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:14px}
  @media (prefers-color-scheme: dark){ .settings-card{ background:#161a1e; border-color:#2a2f36; box-shadow:0 6px 18px rgba(0,0,0,.35) } }
  .settings-note{margin:4px 0 10px; color:#6b7280; font-size:12px}
  @media (prefers-color-scheme: dark){ .settings-note{ color:#9ca3af } }
  .settings-form{display:grid; gap:8px}
  .settings-row{display:grid; gap:4px}
  .settings-row label{font-size:13px; font-weight:600}
  .settings-input{position:relative}
  .settings-input input[type="password"], .settings-input input[type="text"]{
    width:100%; padding:9px 36px 9px 10px; border-radius:10px;
    border:1px solid var(--border-color, #e5e7eb); background:transparent; color:inherit; font-size:14px; outline:none;
  }
  .settings-input input:focus{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .settings-toggle{
    position:absolute; right:6px; top:50%; transform:translateY(-50%);
    background:transparent; border:0; cursor:pointer; padding:4px 6px; color:#9ca3af; border-radius:8px;
  }
  .settings-toggle:hover{background:rgba(0,0,0,.05)}
  @media (prefers-color-scheme: dark){ .settings-toggle:hover{background:rgba(255,255,255,.06)} }
  .settings-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .settings-btn{appearance:none; border:1px solid transparent; background:#2563eb; color:#fff; border-radius:10px; padding:9px 12px; font-weight:700; cursor:pointer}
  .settings-btn:disabled{opacity:.6; cursor:not-allowed}
  .settings-msg{min-height:1.2em; font-size:12px; margin-top:2px}
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
  <div class="settings-card">
    <p class="settings-note">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
    <form id="sys-form" class="settings-form" autocomplete="off" style="margin-bottom:10px">
      <div class="settings-row">
        <label for="system_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</label>
        <div class="settings-input">
          <input type="text" id="system_name" name="system_name" maxlength="64" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ–º –≠–º–∏–ª–∏–∏" value="{{ system_name or '' }}">
        </div>
      </div>
      <div class="settings-actions">
        <button type="button" id="sys-save" class="settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
      </div>
      <div class="settings-msg" id="sys-msg"></div>
    </form>

    <h3>Telegram –±–æ—Ç</h3>
    <form id="tg-form" class="settings-form" autocomplete="off" style="margin-bottom:10px">
      <div class="settings-row">
        <label for="tg_token">Bot API Token</label>
        <div class="settings-input">
          <input type="password" id="tg_token" name="tg_token" placeholder="123456:ABC-DEF..." value="" autocomplete="new-password">
          <div class="hint" id="tg_token_mask" style="margin-top:4px; color:#666; font-size:12px;"></div>
        </div>
      </div>
      <div class="settings-row">
        <label for="tg_access">–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É</label>
        <div class="settings-input">
          <input type="password" id="tg_access" name="tg_access" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ /start" value="" autocomplete="new-password">
        </div>
      </div>
      <div class="settings-row">
        <label for="tg_webhook">–°–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞</label>
        <div class="settings-input">
          <input type="text" id="tg_webhook" name="tg_webhook" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: a1b2c3d4" value="">
          <div class="hint" style="margin-top:4px; color:#666; font-size:12px;">–≠–Ω–¥–ø–æ–π–Ω—Ç –±—É–¥–µ—Ç /telegram/webhook/&lt;—Å–µ–∫—Ä–µ—Ç&gt;</div>
        </div>
      </div>
      <div class="settings-row">
        <label for="tg_admin">Admin Chat ID (–æ–ø—Ü.)</label>
        <div class="settings-input">
          <input type="text" id="tg_admin" name="tg_admin" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789" value="">
        </div>
      </div>
      <div class="settings-actions" style="display:flex; gap:8px; align-items:center;">
        <button type="button" id="tg-save" class="settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" id="tg-test" class="settings-btn">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞</button>
      </div>
      <div class="settings-msg" id="tg-msg"></div>
    </form>
    <p class="settings-note">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è ‚Äî 4 —Å–∏–º–≤–æ–ª–∞.</p>
    <form id="pwd-form" class="settings-form" autocomplete="off">
      <div class="settings-row">
        <label for="old_password">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
        <div class="settings-input">
          <input type="password" id="old_password" name="old_password" minlength="4" maxlength="32" required autocomplete="current-password">
          <button type="button" class="settings-toggle" data-target="#old_password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å">üëÅÔ∏è</button>
        </div>
      </div>
      <div class="settings-row">
        <label for="new_password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
        <div class="settings-input">
          <input type="password" id="new_password" name="new_password" minlength="4" maxlength="32" required autocomplete="new-password">
          <button type="button" class="settings-toggle" data-target="#new_password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å">üëÅÔ∏è</button>
        </div>
      </div>
      <div class="settings-row">
        <label for="new_password2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
        <div class="settings-input">
          <input type="password" id="new_password2" name="new_password2" minlength="4" maxlength="32" autocomplete="new-password">
          <button type="button" class="settings-toggle" data-target="#new_password2" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å">üëÅÔ∏è</button>
        </div>
        <div class="settings-note">–ü–æ–ª–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–ª–∏–Ω—É (‚â• 4).</div>
      </div>
      <div class="settings-actions">
        <button type="submit" id="submit-btn" class="settings-btn">
          <span class="spinner" style="display:none">‚è≥</span>
          <span class="label">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
        </button>
      </div>
      <div class="settings-msg" id="form-msg"></div>
    </form>
  </div>
</div>
<script>
  document.querySelectorAll('.settings-toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = document.querySelector(btn.dataset.target);
      if (!target) return;
      target.type = target.type === 'password' ? 'text' : 'password';
    });
  });
  document.getElementById('pwd-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const msg = document.getElementById('form-msg');
    const old_password = document.getElementById('old_password').value;
    const new_password = document.getElementById('new_password').value;
    msg.textContent = '';
    if (new_password.length < 4){ msg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤.'; msg.style.color = '#e11d48'; return; }
    btn.disabled = true;
    btn.querySelector('.spinner').style.display = 'inline';
    btn.querySelector('.label').textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
    try{
      const res = await fetch('/api/password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ old_password, new_password })});
      let body = {};
      try{ body = await res.json(); }catch(_){ body = {}; }
      if (res.ok && (body.success === undefined || body.success === true)){
        msg.textContent = '–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω.'; msg.style.color = '#15803d';
        e.target.reset();
      }else{
        msg.textContent = (body.message || body.error || '–û—à–∏–±–∫–∞'); msg.style.color = '#e11d48';
      }
    }catch(_){ msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; msg.style.color = '#e11d48'; }
    finally{
      btn.disabled = false;
      btn.querySelector('.spinner').style.display = 'none';
      btn.querySelector('.label').textContent = '–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
    }
  });
  // Save system name
  document.getElementById('sys-save').addEventListener('click', async ()=>{
    const input = document.getElementById('system_name');
    const msg = document.getElementById('sys-msg');
    msg.textContent = '';
    try{
      const res = await fetch('/api/settings/system-name', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: input.value||'' }) });
      const body = await res.json().catch(()=>({}));
      if (res.ok && body.success){
        msg.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.'; msg.style.color = '#15803d';
        // –û–±–Ω–æ–≤–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const logo = document.querySelector('.logo');
        if (logo){
          let extra = logo.querySelector('div');
          if (!extra){ extra = document.createElement('div'); extra.style.fontSize='0.9rem'; extra.style.opacity='0.85'; extra.style.marginLeft='8px'; extra.style.whiteSpace='nowrap'; logo.appendChild(extra); }
          extra.textContent = input.value ? `‚Äî ${input.value}` : '';
        }
      }else{
        msg.textContent = (body.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'); msg.style.color = '#e11d48';
      }
    }catch(_){ msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; msg.style.color = '#e11d48'; }
  });

  // Load Telegram masked fields
  (async ()=>{
    try{
      const r = await fetch('/api/settings/telegram');
      const j = await r.json();
      if (j && j.telegram_bot_token_masked){
        document.getElementById('tg_token_mask').textContent = `–°–æ—Ö—Ä–∞–Ω—ë–Ω: ${j.telegram_bot_token_masked}`;
      }
      if (j && typeof j.telegram_webhook_secret_path !== 'undefined'){
        document.getElementById('tg_webhook').value = j.telegram_webhook_secret_path || '';
      }
      if (j && typeof j.telegram_admin_chat_id !== 'undefined'){
        document.getElementById('tg_admin').value = j.telegram_admin_chat_id || '';
      }
    }catch(e){}
  })();

  // Save Telegram settings
  document.getElementById('tg-save').addEventListener('click', async ()=>{
    const msg = document.getElementById('tg-msg'); msg.textContent='';
    const payload = {};
    const tok = document.getElementById('tg_token').value.trim();
    const acc = document.getElementById('tg_access').value.trim();
    const wh = document.getElementById('tg_webhook').value.trim();
    const adm = document.getElementById('tg_admin').value.trim();
    if (tok) payload.telegram_bot_token = tok;
    if (acc) payload.telegram_access_password = acc;
    payload.telegram_webhook_secret_path = wh;
    payload.telegram_admin_chat_id = adm;
    const r = await fetch('/api/settings/telegram', {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const j = await r.json();
    msg.style.color = (j && j.success)? '#2e7d32' : '#c62828';
    msg.textContent = (j && j.success)? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ' : (j && j.error) ? j.error : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
    if (tok) document.getElementById('tg_token').value = '';
    if (acc) document.getElementById('tg_access').value = '';
    try{
      const r2 = await fetch('/api/settings/telegram'); const j2 = await r2.json();
      document.getElementById('tg_token_mask').textContent = j2.telegram_bot_token_masked ? `–°–æ—Ö—Ä–∞–Ω—ë–Ω: ${j2.telegram_bot_token_masked}` : '';
    }catch(e){}
  });

  // Test Telegram settings
  document.getElementById('tg-test').addEventListener('click', async ()=>{
    const msg = document.getElementById('tg-msg'); msg.textContent='';
    const r = await fetch('/api/settings/telegram/test', {method:'POST'});
    const j = await r.json();
    msg.style.color = (j && j.success)? '#2e7d32' : '#c62828';
    msg.textContent = (j && j.message) ? j.message : ((j && j.success)? 'OK' : '–û—à–∏–±–∫–∞');
  });
</script>
{% endblock %}


