{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç—É—Å{% endblock %}
{% block page_title %}–°—Ç–∞—Ç—É—Å{% endblock %}

{% block extra_css %}
<style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ */
    body {
        color: #333;
    }
    
    .connection-status {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #f44336;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-weight: bold;
        z-index: 1000;
        display: none;
    }
    
    .connection-status.show {
        display: block;
    }
    
    .legend {
        background: white;
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-size: 0.85rem;
    }
    
    .legend h4 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.4rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: #333;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid #ccc;
        flex-shrink: 0;
    }
    
    .top-bar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        margin-bottom: 1rem; 
    }
    .info-box { 
        background: white; 
        padding: 0.4rem 0.8rem; 
        border-radius: 5px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        font-size: 0.9rem; 
        text-align: center; 
        flex: 1 1 160px; 
        color: #333;
    }
    .info-box strong {
        color: #333;
    }
    .status-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1rem; 
    }
    .card { 
        border-radius: 8px; 
        padding: 0.8rem; 
        color: white; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        text-align: center; 
        font-size: 0.9rem; 
        min-height: 180px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .card.waiting { 
        background: linear-gradient(135deg, #4caf50, #45a049); 
        color: white;
    }
    .card.watering { 
        background: linear-gradient(135deg, #2196f3, #1976d2); 
        color: white;
    }
    /* –ò–º–∏—Ç–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥–∞ –≤–æ–¥—ã: –ø—É–ª—å—Å–∞—Ü–∏—è */
    .card.watering.flow-active { 
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(33,150,243,0.6); }
        70% { box-shadow: 0 0 0 12px rgba(33,150,243,0); }
        100% { box-shadow: 0 0 0 0 rgba(33,150,243,0); }
    }
    .card.error { 
        background: linear-gradient(135deg, #f44336, #d32f2f); 
        color: white;
    }
    .card.postponed { 
        background: linear-gradient(135deg, #9e9e9e, #757575); 
        color: white;
    }
    .group-header { 
        font-size: 1rem; 
        margin-bottom: 0.2rem; 
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .postpone-until { 
        margin: 0.5rem 0; 
        font-style: italic; 
        font-size: 0.85rem; 
        background: rgba(255,255,255,0.2);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        color: white;
        backdrop-filter: blur(5px);
    }
    .btn-group { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        justify-content: center; 
        margin: 0.2rem 0; 
        width: 100%; 
    }
    .btn-group button { 
        flex: 1 1 120px; 
        padding: 0.3rem 0.4rem; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 0.85rem; 
        text-align: center; 
        min-width: 120px; 
        border: 2px solid #fff; 
        transition: all 0.2s;
    }
    .btn-group button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .delay { background: #ffc107; color: #000; border-color: transparent; }
    .cancel-postpone { background: #ff9800; color: #fff; border-color: transparent; }
    .start { background: #4caf50; color: #fff; }
    .stop-group { background: #b71c1c; color: #fff; }
    .continue-group { background: #4caf50; color: #fff; }
    .emergency { 
        background: #d32f2f; 
        color: #fff; 
        padding: 0.6rem 1.2rem; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 0.95rem; 
        margin: 1rem auto; 
        display: block; 
        transition: all 0.2s;
    }
    .emergency:hover {
        background: #b71c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .zones-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 1rem;
    }
    .zones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .zones-header h3 {
        color: #333;
        margin: 0;
    }
    .zones-count {
        background: #2196f3;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        color: #333;
    }
    .zones-table th,
    .zones-table td {
        padding: 0.4rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .zones-table th {
        background: #f5f5f5;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
    }
    .zones-table td {
        color: #333;
        background: white;
    }
    .zones-table tr:hover td {
        background: #f9f9f9;
    }
    .indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .indicator.on { background: #4caf50; }
    .indicator.off { background: #ccc; }
    .zone-start-btn {
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.35rem 0.7rem;
        cursor: pointer;
        font-size: 1.0rem;
    }
    .zone-start-btn:hover {
        background: #45a049;
    }
    .zone-photo {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        border-radius: 5px;
        overflow: hidden;
        background-color: #f0f0f0;
        cursor: pointer;
    }
    .zone-photo img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .zone-photo .no-photo {
        font-size: 1.5rem;
        color: #888;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ */
    @media (max-width: 768px) {
        .hide-mobile { display: none; }
        .btn-group button { 
            min-width: 100px; 
            font-size: 0.8rem; 
            padding: 0.4rem 0.3rem;
        }
        .status-grid {
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }
        .card {
            min-height: 160px;
            padding: 0.6rem;
        }
        .top-bar {
            flex-direction: column;
            gap: 0.3rem;
        }
        .info-box {
            flex: 1 1 auto;
            width: 100%;
        }
        .legend-grid {
            grid-template-columns: 1fr;
            gap: 0.3rem;
        }
        .zones-table {
            font-size: 0.75rem;
        }
        .zones-table th,
        .zones-table td {
            padding: 0.3rem 0.2rem;
        }
        .emergency {
            width: 100%;
            margin: 0.5rem 0;
        }
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
    .photo-modal {
        display: none; /* –ø–æ–∫–∞–∑ –≤–∫–ª—é—á–∞–µ–º —á–µ—Ä–µ–∑ JS –∫–∞–∫ flex */
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .photo-modal-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        max-width: 90%;
        max-height: 90%;
    }

    .photo-modal-actions {
        display: flex;
        justify-content: center;
        margin-top: 0;
    }

    .photo-modal-actions .btn {
        padding: 8px 16px;
        font-size: 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .photo-modal-actions .btn:hover {
        background-color: #f0f0f0;
    }

    .photo-modal-actions .btn:focus {
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º -->
<div id="connection-status" class="connection-status">
    ‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
</div>

<div class="top-bar">
    <div class="info-box">
        <strong>–í—Ä–µ–º—è:</strong> <span id="datetime">‚Äî</span>
    </div>
    <div class="info-box">
        <strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> <span id="temp-value">‚Äî</span>¬∞C
    </div>
    <div class="info-box">
        <strong>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</strong> <span id="hum-value">‚Äî</span>%
    </div>
    <div class="info-box">
        <strong>–î–∞—Ç—á–∏–∫ –¥–æ–∂–¥—è:</strong> <span id="rain-value">‚Äî</span>
        <div style="margin-top:.3rem; display:flex; gap:.3rem; justify-content:center;">
            <button class="btn-secondary" onclick="setRain(false)">–ù–µ—Ç –¥–æ–∂–¥—è</button>
            <button class="btn-secondary" onclick="setRain(true)">–î–æ–∂–¥—å</button>
            <button class="btn-secondary" onclick="setRain(null)">–ê–≤—Ç–æ</button>
        </div>
    </div>
</div>

<div class="status-grid" id="groups-container">
    <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>

<!-- –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è, –ø–æ–¥ –≥—Ä—É–ø–ø–∞–º–∏) -->
<div class="legend">
    <h4>üìã –õ–µ–≥–µ–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤</h4>
    <div class="legend-grid">
        <div class="legend-item">
            <div class="legend-color" style="background: #4caf50;"></div>
            <span>–û–∂–∏–¥–∞–Ω–∏–µ - –≥–æ—Ç–æ–≤ –∫ –ø–æ–ª–∏–≤—É</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196f3;"></div>
            <span>–ü–æ–ª–∏–≤ - –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–∏–≤–∞–µ—Ç—Å—è</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9e9e9e;"></div>
            <span>–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f44336;"></div>
            <span>–û—à–∏–±–∫–∞ - –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π</span>
        </div>
    </div>
</div>

<div style="display:flex; gap:.5rem; justify-content:center; margin-bottom:.5rem;">
    <button id="emergency-btn" class="emergency">–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
    <button id="resume-btn" class="emergency" style="background:#4caf50; display:none;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª–∏–≤</button>
 </div>

<div class="zones-section">
    <div class="zones-header">
        <h3>–í—Å–µ –∑–æ–Ω—ã (<span id="zones-count">0</span>)</h3>
    </div>
    <table class="zones-table">
        <thead>
            <tr>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>‚Ññ</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¢–∏–ø</th>
                <th>–í—Ä–µ–º—è</th>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th class="hide-mobile">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</th>
                <th class="hide-mobile">–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤</th>
                <th class="hide-mobile">–§–æ—Ç–æ</th>
            </tr>
        </thead>
        <tbody id="zones-table-body">
            <!-- –ó–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
        <img id="photoModalImg" src="" alt="–§–æ—Ç–æ –∑–æ–Ω—ã">
        <div class="photo-modal-actions">
            <button class="btn btn-primary" onclick="closePhotoModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞
    let statusData = null;
    let zonesData = [];
    let connectionError = false;
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function updateDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU');
        const timeStr = now.toLocaleTimeString('ru-RU');
        document.getElementById('datetime').textContent = `${dateStr} ${timeStr}`;
    }
    
    async function loadStatusData() {
        try {
            statusData = await api.get('/api/status');
            updateStatusDisplay();
            hideConnectionError();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            showConnectionError();
        }
    }
    
    async function loadZonesData() {
        try {
            zonesData = await api.get('/api/zones');
            await updateZonesTable();
            hideConnectionError();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω:', error);
            showConnectionError();
        }
    }
    
    function showConnectionError() {
        if (!connectionError) {
            connectionError = true;
            document.getElementById('connection-status').classList.add('show');
        }
    }
    
    function hideConnectionError() {
        if (connectionError) {
            connectionError = false;
            document.getElementById('connection-status').classList.remove('show');
        }
    }
    
    function formatSeconds(total) {
        const sec = Math.max(0, Math.floor(total));
        const mm = String(Math.floor(sec / 60)).padStart(2, '0');
        const ss = String(sec % 60).padStart(2, '0');
        return `${mm}:${ss}`;
    }

    function getStatusText(group) {
        if (group.status === 'watering' && group.current_zone) {
            const prevBtn = `<button class=\"zone-start-btn\" title=\"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –∑–æ–Ω–∞\" onclick=\"groupPrev(${group.id})\">‚Äπ</button>`;
            const nextBtn = `<button class=\"zone-start-btn\" title=\"–°–ª–µ–¥—É—é—â–∞—è –∑–æ–Ω–∞\" onclick=\"groupNext(${group.id})\">‚Ä∫</button>`;
            return `${prevBtn} –ü–æ–ª–∏–≤ ‚Äî –ó–æ–Ω–∞ ${group.current_zone} ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å <span class="group-timer" id="group-timer-${group.id}" data-group-id="${group.id}" data-zone-id="${group.current_zone}" data-remaining-seconds="">--:--</span> ${nextBtn}`;
        }
        switch (group.status) {
            case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø–æ–ª–∏–≤–∞';
            case 'error': return '–ê–≤–∞—Ä–∏—è ‚Äî –û—à–∏–±–∫–∞ —Å—á—ë—Ç—á–∏–∫–∞';
            case 'postponed':
                if (group.postpone_reason === 'emergency') return '–ü–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –∏–∑-–∑–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏';
                if (group.postpone_reason === 'manual') return '–ü–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                return '–ü–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –∏–∑-–∑–∞ –¥–æ–∂–¥—è';
            default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
        }
    }

    async function initGroupTimer(group) {
        const span = document.getElementById(`group-timer-${group.id}`);
        if (!span) return;
        try {
            const res = await fetch(`/api/zones/${group.current_zone}/watering-time`);
            const data = await res.json();
            if (data && data.success && data.is_watering) {
                span.dataset.remainingSeconds = String(data.remaining_seconds ?? (data.remaining_time * 60));
                span.textContent = formatSeconds(Number(span.dataset.remainingSeconds));
            } else {
                span.dataset.remainingSeconds = '';
                span.textContent = '--:--';
            }
        } catch (e) {
            span.textContent = '--:--';
        }
    }
    
    async function updateStatusDisplay() {
        if (!statusData) return;
        updateDateTime();
        document.getElementById('temp-value').textContent = statusData.temperature;
        document.getElementById('hum-value').textContent = statusData.humidity;
        document.getElementById('rain-value').textContent = statusData.rain_sensor;
        const container = document.getElementById('groups-container');
        container.innerHTML = '';
        const resumeBtn = document.getElementById('resume-btn');
        if (statusData.emergency_stop) { resumeBtn.style.display = 'inline-block'; } else { resumeBtn.style.display = 'none'; }
        for (const group of statusData.groups) {
            const card = document.createElement('div');
            const flowActive = group.status === 'watering' && Math.random() > 0.3;
            card.className = `card ${group.status} ${flowActive ? 'flow-active' : ''}`;
            const statusText = getStatusText(group);
            const postponeText = group.status === 'postponed' && group.postpone_until ? `–ù–µ –±—É–¥–µ—Ç –ø–æ–ª–∏–≤–∞—Ç—å—Å—è –¥–æ: ${group.postpone_until}` : '‚Äî';
            const groupButtons = `
                <div class="btn-group">
                    <button class="delay" onclick="delayGroup(${group.id}, 1)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 1 –¥–µ–Ω—å</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 2)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 2 –¥–Ω—è</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 3)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 3 –¥–Ω—è</button>
                    ${group.status === 'postponed' && group.postpone_until && !statusData.emergency_stop ? `<button class="cancel-postpone" onclick="cancelPostpone(${group.id})">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</button>` : ''}
                </div>
                <div class="btn-group">
                    <button class="continue-group" onclick="startGroupFromFirst(${group.id})">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                    <button class="stop-group" onclick="stopGroup(${group.id})">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                </div>`;
            card.innerHTML = `
                <div class="group-header">${group.name}</div>
                <div id="group-status-${group.id}">${statusText}</div>
                <div class="postpone-until">${postponeText}</div>
                ${groupButtons}
            `;
            card.id = `group-card-${group.id}`;
            container.appendChild(card);
            if (group.status === 'watering' && group.current_zone) {
                initGroupTimer(group);
            }
        }
    }

    function tickCountdowns() {
        const spans = document.querySelectorAll('.group-timer');
        spans.forEach(span => {
            const val = span.dataset.remainingSeconds;
            if (!val) return;
            let sec = Number(val);
            if (Number.isNaN(sec) || sec <= 0) {
                span.textContent = '00:00';
                span.dataset.remainingSeconds = '';
                // –ü–æ–ø—Ä–æ—Å–∏–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø—ã –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –µ—ë –∫–∞—Ä—Ç–æ—á–∫—É –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const gid = span.dataset.groupId;
                if (gid) refreshSingleGroup(parseInt(gid, 10));
                return;
            }
            sec = sec - 1;
            span.dataset.remainingSeconds = String(sec);
            span.textContent = formatSeconds(sec);
        });
    }

    async function refreshSingleGroup(groupId) {
        try {
            const resp = await fetch(`/api/status?ts=${Date.now()}`, {cache: 'no-store'});
            const data = await resp.json();
            if (!data || !data.groups) return;
            const group = (data.groups || []).find(g => String(g.id) === String(groupId));
            if (!group) return;
            const card = document.getElementById(`group-card-${group.id}`);
            if (!card) return;
            // –û–±–Ω–æ–≤–∏–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∏ —Ç–∞–π–º–µ—Ä
            const statusHtml = getStatusText(group);
            const statusDiv = document.getElementById(`group-status-${group.id}`);
            if (statusDiv) {
                statusDiv.innerHTML = statusHtml;
            }
            if (group.status === 'watering' && group.current_zone) {
                initGroupTimer(group);
            }
            // –û–±–Ω–æ–≤–∏–º —Å—Ç–∏–ª–µ–≤–æ–π –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏ (—Ü–≤–µ—Ç, –ø—É–ª—å—Å–∞—Ü–∏—è –∏ —Ç.–ø.)
            const flowActive = group.status === 'watering' && Math.random() > 0.3;
            card.className = `card ${group.status} ${flowActive ? 'flow-active' : ''}`;
        } catch (e) {}
    }

    // –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è MQTT —á–µ—Ä–µ–∑ SSE –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function setupSseZones() {
        try {
            const es = new EventSource('/api/mqtt/zones-sse');
            es.onmessage = function(ev) {
                try {
                    if (!ev || !ev.data) return;
                    const msg = JSON.parse(ev.data);
                    const zid = parseInt(msg.zone_id, 10);
                    const payload = String(msg.payload || '').trim();
                    const newState = (payload === '1' || payload === 'on' || payload === 'ON' || payload === 'true') ? 'on' : 'off';
                    handleZoneUpdateFromSse(zid, newState);
                } catch (e) {}
            };
            es.onerror = function() { /* keep connection attempts */ };
        } catch (e) {}
    }

    function handleZoneUpdateFromSse(zoneId, newState) {
        try {
            // –û–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ zonesData, —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –∑–æ–Ω –±—ã–ª–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π
            const z = zonesData.find(x => Number(x.id) === Number(zoneId));
            if (z) z.state = newState;
            // –ù–∞–π–¥—ë–º –≥—Ä—É–ø–ø—É –∏ –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –µ—ë –∫–∞—Ä—Ç–æ—á–∫—É
            const groupId = z ? z.group_id : null;
            if (groupId) {
                refreshSingleGroup(groupId);
            } else {
                // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç–∞—Ç—É—Å —Ü–µ–ª–∏–∫–æ–º –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                loadStatusData();
            }
        } catch (e) {}
    }

    async function setRain(on) {
        try {
            const res = await fetch('/api/rain-toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ on })
            });
            const data = await res.json();
            if (data && data.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –¥–æ–∂–¥—è –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadStatusData();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–∂–¥—è', 'error');
            }
        } catch (e) {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–∂–¥—è', 'error');
        }
    }
    
    async function updateZonesTable() {
        const tbody = document.getElementById('zones-table-body');
        const countSpan = document.getElementById('zones-count');
        
        tbody.innerHTML = '';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–æ–Ω—ã, –∏—Å–∫–ª—é—á–∞—è –≥—Ä—É–ø–ø—É 999 (–ë–ï–ó –ü–û–õ–ò–í–ê)
        const filteredZones = zonesData.filter(zone => zone.group_id !== 999);
        
        countSpan.textContent = filteredZones.length;
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —á–∏—Å–µ–ª
        const groups = await api.get('/api/groups');
        const groupNameById = {};
        groups.forEach(g => { groupNameById[g.id] = g.name; });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞ –¥–ª—è –≤—Å–µ—Ö –∑–æ–Ω
        const nextWateringPromises = filteredZones.map(async (zone) => {
            try {
                const response = await fetch(`/api/zones/${zone.id}/next-watering`);
                const data = await response.json();
                return { zone_id: zone.id, next_watering: data.next_watering, next_datetime: data.next_datetime };
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª–∏–≤–∞ –¥–ª—è –∑–æ–Ω—ã ${zone.id}:`, error);
                return { zone_id: zone.id, next_watering: '–û—à–∏–±–∫–∞' };
            }
        });
        
        const nextWateringData = await Promise.all(nextWateringPromises);
        const nextWateringMap = {};
        nextWateringData.forEach(item => {
            nextWateringMap[item.zone_id] = item.next_watering;
        });
        
        filteredZones.forEach(zone => {
            let nextWatering = nextWateringMap[zone.id] || '–û—à–∏–±–∫–∞';
            // –ü–æ–¥–º–µ–Ω–∞ –Ω–∞ –¥–∞—Ç—ã/—Å–æ–æ–±—â–µ–Ω–∏—è
            if (statusData.emergency_stop) {
                nextWatering = '–î–æ –æ—Ç–º–µ–Ω—ã –∞–≤–∞—Ä–∏–∏';
            } else if (zone.postpone_until) {
                // –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–ª–æ–∂–∫–∞ –Ω–∞ –∑–æ–Ω–µ
                nextWatering = zone.postpone_until.replace(' ', ' ');
            } else {
                const nextDT = (nextWateringData.find(x => x.zone_id === zone.id) || {}).next_datetime;
                if (nextDT) {
                    // –ü–∏—à–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                    nextWatering = nextDT.replace('T',' ').slice(0,16);
                }
            }
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td><span class="indicator ${zone.state}"></span></td>
                <td>${zone.id}</td>
                <td><button class="zone-start-btn" onclick="${statusData.emergency_stop ? `showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')` : `startOrStopZone(${zone.id}, '${zone.state}')`}">${zone.state==='on' ? '‚èπ' : '‚ñ∂'}</button></td>
                <td>${zone.name}</td>
                <td>${zone.icon}</td>
                <td>${zone.duration} –º–∏–Ω</td>
                <td>${groupNameById[zone.group_id] || zone.group_id}</td>
                <td class="hide-mobile">30.04 ${String(zone.id % 24).padStart(2, '0')}:00</td>
                <td>${nextWatering}</td>
                <td>
                    <div class="zone-photo">
                        ${zone.photo_path ? 
                            `<img src="/api/zones/${zone.id}/photo" alt="–§–æ—Ç–æ –∑–æ–Ω—ã ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">` :
                            `<div class="no-photo" title="–ù–µ—Ç —Ñ–æ—Ç–æ">üì∑</div>`
                        }
                    </div>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    async function delayGroup(groupId, days) {
        try {
            const response = await api.post('/api/postpone', {
                group_id: groupId,
                days: days,
                action: 'postpone'
            });
            
            if (response.success) {
                showNotification(response.message, 'success');
                loadStatusData(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ª–æ–∂–∫–µ –ø–æ–ª–∏–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ª–æ–∂–∫–µ –ø–æ–ª–∏–≤–∞', 'error');
        }
    }
    
    async function cancelPostpone(groupId) {
        try {
            const response = await api.post('/api/postpone', {
                group_id: groupId,
                action: 'cancel'
            });
            
            if (response.success) {
                showNotification(response.message, 'success');
                loadStatusData(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞', 'error');
        }
    }
    
    async function startGroupFromFirst(groupId) {
        try {
            const res = await fetch(`/api/groups/${groupId}/start-from-first`, { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª–∏–≤–∞ –≥—Ä—É–ø–ø—ã', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–ª–∏–≤–∞ –≥—Ä—É–ø–ø—ã', 'error');
        }
    }
    
    async function stopGroup(groupId) {
        if (!confirm(`–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã ${groupId}?`)) return;
        
        try {
            const res = await fetch(`/api/groups/${groupId}/stop`, { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥—Ä—É–ø–ø—ã', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≥—Ä—É–ø–ø—ã', 'error');
        }
    }

    async function groupNext(groupId){
        try{
            const res = await fetch(`/api/groups/${groupId}/next`, {method:'POST'});
            const data = await res.json();
            if (data && data.success){
                showNotification(data.message, 'info');
                await refreshSingleGroup(groupId);
            } else {
                showNotification(data && data.message ? data.message : '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é', 'warning');
            }
        }catch(e){ showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
    }
    async function groupPrev(groupId){
        try{
            const res = await fetch(`/api/groups/${groupId}/prev`, {method:'POST'});
            const data = await res.json();
            if (data && data.success){
                showNotification(data.message, 'info');
                await refreshSingleGroup(groupId);
            } else {
                showNotification(data && data.message ? data.message : '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é', 'warning');
            }
        }catch(e){ showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
    }
    
    async function startOrStopZone(zoneId, currentState) {
        try {
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É –∑–æ–Ω—ã
            const zone = zonesData.find(z => z.id === zoneId);
            if (!zone) return;
            const url = currentState === 'on' ? `/api/zones/${zoneId}/mqtt/stop` : `/api/zones/${zoneId}/mqtt/start`;
            const res = await fetch(url, { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–æ–Ω—ã', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–æ–Ω–æ–π', 'error');
        }
    }
    
    async function emergencyStop() {
        if (!confirm('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–æ–Ω?')) return;
        
        try {
            const res = await fetch('/api/emergency-stop', { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'warning');
                await loadStatusData();
                await loadZonesData();
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–≤–Ω–æ
                document.getElementById('resume-btn').style.display = 'inline-block';
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ', 'error');
        }
    }

    async function resumeSchedule() {
        try {
            const res = await fetch('/api/emergency-resume', { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('resume-btn').style.display = 'none';
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≤–∞', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≤–∞', 'error');
        }
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    function showPhotoModal(photoUrl) {
        const img = document.getElementById('photoModalImg');
        img.src = photoUrl;
        const modal = document.getElementById('photoModal');
        modal.style.display = 'flex'; // —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ flex
    }

    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å—Ä–∞–∑—É
        updateDateTime();
        
        loadStatusData();
        loadZonesData();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateDateTime, 1000);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            loadStatusData();
            loadZonesData();
        }, 30000);
        setInterval(tickCountdowns, 1000);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        document.getElementById('emergency-btn').addEventListener('click', emergencyStop);
        document.getElementById('resume-btn').addEventListener('click', resumeSchedule);
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å—ã –∑–æ–Ω —á–µ—Ä–µ–∑ SSE
        try {
            const es = new EventSource('/api/mqtt/zones-sse');
            es.onmessage = (ev)=>{
                try{
                    const data = JSON.parse(ev.data);
                    const idx = zonesData.findIndex(z=>z.id===data.zone_id);
                    if (idx>=0){
                        zonesData[idx].state = data.state;
                        // –û–±–Ω–æ–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø—ã, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ "–ü–æ–ª–∏–≤ ‚Äî –ó–æ–Ω–∞ X" —Å–º–µ–Ω–∏–ª–∞—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                        const gid = zonesData[idx].group_id;
                        if (gid) { refreshSingleGroup(gid); }
                        const tbody = document.getElementById('zones-table-body');
                        if (tbody){
                            const rows = tbody.querySelectorAll('tr');
                            rows.forEach(row=>{
                                const cells = row.querySelectorAll('td');
                                if (cells.length>1 && Number(cells[1].textContent.trim())===data.zone_id){
                                    const ind = row.querySelector('.indicator');
                                    if (ind){ ind.classList.remove('on','off'); ind.classList.add(data.state); }
                                    const btn = row.querySelector('.zone-start-btn');
                                    if (btn){ btn.textContent = data.state==='on'?'‚èπ':'‚ñ∂'; }
                                }
                            });
                        }
                    }
                }catch(e){}
            };
        } catch (e) {}
    });
</script>
{% endblock %}
