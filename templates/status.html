{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç—É—Å{% endblock %}
{% block page_title %}–°—Ç–∞—Ç—É—Å{% endblock %}

{% block extra_css %}
<style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ */
    body {
        color: #333;
    }
    
    .connection-status {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #f44336;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-weight: bold;
        z-index: 1000;
        display: none;
    }
    
    .connection-status.show {
        display: block;
    }
    .connection-status.warn { background: #ff9800; }
    
    .legend {
        background: white;
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-size: 0.85rem;
    }
    
    .legend h4 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.4rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: #333;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid #ccc;
        flex-shrink: 0;
    }
    
    .top-bar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        margin-bottom: 1rem; 
    }
    .info-box { 
        background: white; 
        padding: 0.4rem 0.8rem; 
        border-radius: 5px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        font-size: 0.9rem; 
        text-align: center; 
        flex: 1 1 160px; 
        color: #333;
    }
    .info-box strong {
        color: #333;
    }
    .status-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1rem; 
    }
    .card { 
        border-radius: 8px; 
        padding: 0.8rem; 
        color: white; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        text-align: center; 
        font-size: 0.9rem; 
        min-height: 180px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .card.waiting { 
        background: linear-gradient(135deg, #4caf50, #45a049); 
        color: white;
    }
    .card.watering { 
        background: linear-gradient(135deg, #2196f3, #1976d2); 
        color: white;
    }
    /* –ò–º–∏—Ç–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥–∞ –≤–æ–¥—ã: –ø—É–ª—å—Å–∞—Ü–∏—è */
    .card.watering.flow-active { 
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(33,150,243,0.6); }
        70% { box-shadow: 0 0 0 12px rgba(33,150,243,0); }
        100% { box-shadow: 0 0 0 0 rgba(33,150,243,0); }
    }
    .card.error { 
        background: linear-gradient(135deg, #f44336, #d32f2f); 
        color: white;
    }
    .card.postponed { 
        background: linear-gradient(135deg, #9e9e9e, #757575); 
        color: white;
    }
    .group-header { 
        font-size: 1rem; 
        margin-bottom: 0.2rem; 
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .postpone-until { 
        margin: 0.5rem 0; 
        font-style: italic; 
        font-size: 0.85rem; 
        background: rgba(255,255,255,0.2);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        color: white;
        backdrop-filter: blur(5px);
    }
    .btn-group { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        justify-content: center; 
        margin: 0.2rem 0; 
        width: 100%; 
    }
    .btn-group button { 
        flex: 1 1 120px; 
        padding: 0.3rem 0.4rem; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 0.85rem; 
        text-align: center; 
        min-width: 120px; 
        border: 2px solid #fff; 
        transition: all 0.2s;
    }
    .btn-group button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .delay { background: #ffc107; color: #000; border-color: transparent; }
    .cancel-postpone { background: #ff9800; color: #fff; border-color: transparent; }
    .start { background: #4caf50; color: #fff; }
    .stop-group { background: #b71c1c; color: #fff; }
    .continue-group { background: #4caf50; color: #fff; }
    .emergency { 
        background: #d32f2f; 
        color: #fff; 
        padding: 0.6rem 1.2rem; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 0.95rem; 
        margin: 1rem auto; 
        display: block; 
        transition: all 0.2s;
    }
    .emergency:hover {
        background: #b71c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .zones-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 1rem;
    }
    /* –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤" –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    .col-last-watering { display: none !important; }
    .zones-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .zones-header h3 {
        color: #333;
        margin: 0;
    }
    .zones-count {
        background: #2196f3;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    .zones-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        color: #333;
    }
    .zones-table th,
    .zones-table td {
        padding: 0.4rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .zones-table th {
        background: #f5f5f5;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
    }
    .zones-table td {
        color: #333;
        background: white;
    }
    .zones-table tr:hover td {
        background: #f9f9f9;
    }
    .indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .indicator.on { background: #4caf50; }
    .indicator.off { background: #ccc; }
    .zone-start-btn {
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 0.2rem 0.4rem;
        cursor: pointer;
        font-size: 0.8rem;
    }
    .zone-start-btn:hover {
        background: #45a049;
    }
    .zone-photo {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        border-radius: 5px;
        overflow: hidden;
        background-color: #f0f0f0;
        cursor: pointer;
    }
    .zone-photo img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .zone-photo .no-photo {
        font-size: 1.5rem;
        color: #888;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ */
    @media (max-width: 768px) {
        .hide-mobile { display: none; }
        .btn-group button { 
            min-width: 100px; 
            font-size: 0.8rem; 
            padding: 0.4rem 0.3rem;
        }
        .status-grid { grid-template-columns: 1fr; gap: 0.8rem; }
        .card { min-height: 160px; padding: 0.6rem; }
        .top-bar { flex-direction: column; gap: 0.3rem; }
        .info-box { flex: 1 1 auto; width: 100%; }
        .legend-grid { grid-template-columns: 1fr; gap: 0.3rem; }
        .zones-section { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .zones-table { font-size: 0.75rem; min-width: 640px; }
        .zones-table th, .zones-table td { padding: 0.3rem 0.2rem; }
        .emergency { width: 100%; margin: 0.5rem 0; }
        /* –ü–æ–¥–ø–∏—Å–∏ –≤ —è—á–µ–π–∫–∞—Ö –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ (—É–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å—å —É "–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤") */
        .zones-table td.col-photo::before { content: attr(data-label) ": "; font-weight: 600; color: #666; margin-right: 4px; }
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
    .photo-modal {
        display: none; /* –ø–æ–∫–∞–∑ –≤–∫–ª—é—á–∞–µ–º —á–µ—Ä–µ–∑ JS –∫–∞–∫ flex */
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .photo-modal-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        max-width: min(90vw, 720px);
        max-height: 90vh;
    }
    /* –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–ø–∏—Å—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –≤ —ç–∫—Ä–∞–Ω —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ */
    .photo-modal img {
        display: block;
        max-width: 95vw;
        max-height: 85vh;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .photo-modal-actions {
        display: flex;
        justify-content: center;
        margin-top: 0;
    }

    .photo-modal-actions .btn {
        padding: 8px 16px;
        font-size: 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .photo-modal-actions .btn:hover {
        background-color: #f0f0f0;
    }

    .photo-modal-actions .btn:focus {
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π -->
<div id="connection-status" class="connection-status">‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>
<div id="mqtt-no-servers" class="connection-status warn">‚ö†Ô∏è –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ MQTT —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</div>
<div id="mqtt-no-connection" class="connection-status warn">‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å MQTT —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>

<div class="top-bar">
    <div class="info-box">
        <strong>–í—Ä–µ–º—è:</strong> <span id="datetime">‚Äî</span>
    </div>
    <div class="info-box" id="temp-box" style="display:none;">
        <strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> <span id="temp-value">‚Äî</span>¬∞C
    </div>
    <div class="info-box" id="hum-box" style="display:none;">
        <strong>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</strong> <span id="hum-value">‚Äî</span>%
    </div>
    <div class="info-box" id="rain-box" style="display:none;">
        <strong>–î–∞—Ç—á–∏–∫ –¥–æ–∂–¥—è:</strong> <span id="rain-value">‚Äî</span>
    </div>
</div>

<div class="status-grid" id="groups-container">
    <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>

<!-- –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è, –ø–æ–¥ –≥—Ä—É–ø–ø–∞–º–∏) -->
<div class="legend">
    <h4>üìã –õ–µ–≥–µ–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤</h4>
    <div class="legend-grid">
        <div class="legend-item">
            <div class="legend-color" style="background: #4caf50;"></div>
            <span>–û–∂–∏–¥–∞–Ω–∏–µ - –≥–æ—Ç–æ–≤ –∫ –ø–æ–ª–∏–≤—É</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196f3;"></div>
            <span>–ü–æ–ª–∏–≤ - –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–∏–≤–∞–µ—Ç—Å—è</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9e9e9e;"></div>
            <span>–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f44336;"></div>
            <span>–û—à–∏–±–∫–∞ - –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π</span>
        </div>
    </div>
</div>

<div style="display:flex; gap:.5rem; justify-content:center; margin-bottom:.5rem;">
    <button id="emergency-btn" class="emergency">–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
    <button id="resume-btn" class="emergency" style="background:#4caf50; display:none;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª–∏–≤</button>
 </div>

<div class="zones-section">
    <div class="zones-header">
        <h3>–í—Å–µ –∑–æ–Ω—ã (<span id="zones-count">0</span>)</h3>
    </div>
    <table class="zones-table">
        <thead>
            <tr>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>‚Ññ</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¢–∏–ø</th>
                <th>–í—Ä–µ–º—è</th>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th class="hide-mobile col-last-watering">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</th>
                <th>–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤</th>
                <th>–§–æ—Ç–æ</th>
            </tr>
        </thead>
        <tbody id="zones-table-body">
            <!-- –ó–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
        <img id="photoModalImg" src="" alt="–§–æ—Ç–æ –∑–æ–Ω—ã">
        <div class="photo-modal-actions">
            <button class="btn btn-primary" onclick="closePhotoModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // UI timing helpers
    (function(){
      function nowMs(){ return performance && performance.now ? performance.now() : Date.now(); }
      function logUiTiming(kind, detail, ms){
        try{
          console.log(`[UI Timing] ${kind} ${detail}: ${Math.round(ms)}ms`);
        }catch(e){}
      }
      // Wrap fetch to time control actions
      const _fetch = window.fetch;
      window.fetch = async function(input, init){
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const isControl = /\/api\/(zones\/.+\/(mqtt\/)?(start|stop)|groups\/\d+\/(start-from-first|stop)|emergency-(stop|resume)|postpone)/.test(url);
        const t0 = nowMs();
        const resp = await _fetch(input, init);
        const t1 = nowMs();
        if (isControl){ logUiTiming('HTTP', url, t1 - t0); }
        return resp;
      };
      // Time button clicks to response end
      function wireBtnTiming(){
        const btnSelectors = [
          '.zone-start-btn', '#emergency-btn', '#resume-btn',
        ];
        btnSelectors.forEach(sel=>{
          document.querySelectorAll(sel).forEach(btn=>{
            if (btn.__timed) return; btn.__timed = true;
            btn.addEventListener('click', ()=>{ btn.__t0 = nowMs(); }, {capture:true});
          });
        });
        // Generic listener to measure end of network roundtrip via DOM updates
        document.addEventListener('zones-rendered', ()=>{
          try{
            const tNow = nowMs();
            document.querySelectorAll('.zone-start-btn').forEach(b=>{
              if (b.__t0){ logUiTiming('UI', 'zone-toggle->render', tNow - b.__t0); b.__t0 = null; }
            });
          }catch(e){}
        });
      }
      document.addEventListener('DOMContentLoaded', wireBtnTiming);
    })();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞
    let statusData = null;
    let zonesData = [];
    let connectionError = false;
    let mqttNoServers = false;
    let mqttNoConnection = false;
    let envProbeTimer = null;
    let envProbeAttempts = 0;
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    async function updateDateTime() {
        try {
            const r = await fetch('/api/server-time?ts=' + Date.now(), { cache: 'no-store' });
            const j = await r.json();
            if (j && j.now_iso) {
                document.getElementById('datetime').textContent = j.now_iso.replace('T',' ');
                return;
            }
        } catch (e) {}
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const dt = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        document.getElementById('datetime').textContent = dt;
    }
    
    async function loadStatusData() {
        try {
            statusData = await api.get('/api/status');
            updateStatusDisplay();
            hideConnectionError();
            updateMqttWarnings();
            // –°–æ–≥–ª–∞—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–æ–Ω —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –≥—Ä—É–ø–ø (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            try { reconcileZoneRowsWithGroupStatus(); } catch(e) {}
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            showConnectionError();
        }
    }
    
    async function loadZonesData() {
        try {
            // 1) –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä –∑–æ–Ω –ø–æ /api/zones (–Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ fetch, –±–µ–∑ –æ–±—ë—Ä—Ç–∫–∏)
            let zonesRespJson = [];
            try {
                const zr = await fetch('/api/zones?ts=' + Date.now(), { cache: 'no-store' });
                zonesRespJson = await zr.json();
            } catch (e) {
                zonesRespJson = [];
            }
            zonesData = Array.isArray(zonesRespJson) ? zonesRespJson : [];
            const tbody = document.getElementById('zones-table-body');
            const existingRows = {};
            tbody.querySelectorAll('tr').forEach(row=>{
                const idCell = row.querySelector('td:nth-child(2)');
                if (idCell) existingRows[idCell.textContent.trim()] = row;
            });
            const filteredZones = (zonesData || []).filter(z=>z.group_id !== 999);
            const frag = document.createDocumentFragment();
            filteredZones.forEach(zone=>{
                const rowId = String(zone.id);
                const row = existingRows[rowId];
                if (row){
                    // —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è –ø–æ–ª—è
                    const ind = row.querySelector('.indicator');
                    if (ind){ ind.classList.remove('on','off'); ind.classList.add(zone.state); }
                    const btn = row.querySelector('.zone-start-btn');
                    if (btn){
                        btn.textContent = zone.state==='on'?'‚èπ':'‚ñ∂';
                        const emergency = !!(statusData && statusData.emergency_stop);
                        const action = emergency ? "showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')" : ("startOrStopZone(" + zone.id + ", '" + zone.state + "')");
                        btn.setAttribute('onclick', action);
                    }
                    if (!row.getAttribute('data-zone-id')) {
                        try { row.setAttribute('data-zone-id', String(zone.id)); } catch(e) {}
                    }
                } else {
                    // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å placeholders –¥–ª—è –≥—Ä—É–ø–ø—ã –∏ next
                    const tr = document.createElement('tr');
                    const emergency = !!(statusData && statusData.emergency_stop);
                    const action = emergency ? "showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')" : ("startOrStopZone(" + zone.id + ", '" + zone.state + "')");
                    tr.innerHTML = `
                        <td><span class="indicator ${zone.state}"></span></td>
                        <td>${zone.id}</td>
                        <td><button class="zone-start-btn" onclick="${action}">${zone.state==='on' ? '‚èπ' : '‚ñ∂'}</button></td>
                        <td>${zone.name}</td>
                        <td>${zone.icon}</td>
                        <td>${zone.duration} –º–∏–Ω</td>
                        <td data-group-id="${zone.group_id}">${zone.group_id}</td>
                        <td class="hide-mobile col-last-watering">‚Äî</td>
                        <td class="col-next" data-label="–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤">‚Äî</td>
                        <td class="col-photo" data-label="–§–æ—Ç–æ">
                            <div class="zone-photo">
                                ${zone.photo_path ? 
                                    `<img src="/api/zones/${zone.id}/photo" alt="–§–æ—Ç–æ –∑–æ–Ω—ã ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">` :
                                    `<div class="no-photo" title="–ù–µ—Ç —Ñ–æ—Ç–æ">üì∑</div>`
                                }
                            </div>
                        </td>`;
                    try { tr.setAttribute('data-zone-id', String(zone.id)); } catch(e) {}
                    frag.appendChild(tr);
                }
            });
            if (frag.childNodes.length) tbody.appendChild(frag);
            document.getElementById('zones-count').textContent = filteredZones.length;
            hideConnectionError();
            // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º –≥—Ä—É–ø–ø
            try { reconcileZoneRowsWithGroupStatus(); } catch(e) {}
            // 2) –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏–º–µ–Ω–∞ –≥—Ä—É–ø–ø –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            (async()=>{
                try{
                    const groups = await api.get('/api/groups');
                    const nameById = {}; (groups||[]).forEach(g=>{ nameById[g.id]=g.name; });
                    tbody.querySelectorAll('tr').forEach(row=>{
                        const cell = row.querySelector('td:nth-child(7)');
                        if (!cell) return;
                        const gidAttr = cell.getAttribute('data-group-id');
                        const gid = gidAttr ? Number(gidAttr) : Number(cell.textContent.trim());
                        if (nameById[gid]) cell.textContent = nameById[gid];
                    });
                }catch(e){}
            })();
            // 3) –ü–æ–¥–≥—Ä—É–∂–∞–µ–º next-watering –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            (async()=>{
                try{
                    const ids = filteredZones.map(z=>z.id);
                    if (!ids.length) return;
                    const resp = await fetch('/api/zones/next-watering-bulk',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({zone_ids: ids})});
                    if (!resp.ok) return;
                    const bulk = await resp.json();
                    const nextMap = {}; (bulk.items||[]).forEach(it=>{ nextMap[it.zone_id]= it.next_datetime || (it.next_watering==='–ù–∏–∫–æ–≥–¥–∞'?'–ù–∏–∫–æ–≥–¥–∞': null); });
                    tbody.querySelectorAll('tr').forEach(row=>{
                        const idCell = row.querySelector('td:nth-child(2)');
                        const nextCell = row.querySelector('td:nth-child(9)');
                        if (!idCell || !nextCell) return;
                        const zid = Number(idCell.textContent.trim());
                        if (!(zid in nextMap)) return;
                        const v = nextMap[zid];
                        let txt = '‚Äî';
                        if (statusData && statusData.emergency_stop) txt = '–î–æ –æ—Ç–º–µ–Ω—ã –∞–≤–∞—Ä–∏–∏';
                        else if (v==='–ù–∏–∫–æ–≥–¥–∞') txt = '–ù–∏–∫–æ–≥–¥–∞';
                        else if (v) txt = String(v).replace('T',' ').slice(0,19);
                        nextCell.textContent = txt;
                    });
                }catch(e){}
            })();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω:', error);
            showConnectionError();
        }
    }

    // –ë—ã—Å—Ç—Ä–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –∑–æ–Ω —Å —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º –≥—Ä—É–ø–ø –∏–∑ statusData
    function reconcileZoneRowsWithGroupStatus() {
        try {
            if (!statusData || !statusData.groups || !statusData.groups.length) return;
            const wateringByGroup = {};
            (statusData.groups || []).forEach(g => {
                if (g && g.status === 'watering' && g.current_zone) {
                    wateringByGroup[String(g.id)] = Number(g.current_zone);
                }
            });
            const tbody = document.getElementById('zones-table-body');
            if (!tbody) return;
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                try {
                    const idCell = row.querySelector('td:nth-child(2)');
                    const grpCell = row.querySelector('td:nth-child(7)');
                    if (!idCell || !grpCell) return;
                    const zid = Number(idCell.textContent.trim());
                    const gidAttr = grpCell.getAttribute('data-group-id');
                    const gid = gidAttr ? String(Number(gidAttr)) : String(grpCell.textContent.trim());
                    const runningZoneId = wateringByGroup[gid];
                    if (typeof runningZoneId === 'undefined') return;
                    const isOn = (zid === runningZoneId);
                    const ind = row.querySelector('.indicator');
                    if (ind) { ind.classList.remove('on','off'); ind.classList.add(isOn ? 'on' : 'off'); }
                    const btn = row.querySelector('.zone-start-btn');
                    if (btn) {
                        btn.textContent = isOn ? '‚èπ' : '‚ñ∂';
                        const emergency = !!(statusData && statusData.emergency_stop);
                        const action = emergency ? "showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')" : ("startOrStopZone(" + zid + ", '" + (isOn ? 'on' : 'off') + "')");
                        btn.setAttribute('onclick', action);
                    }
                } catch(e) {}
            });
        } catch (e) {}
    }
    
    function showConnectionError() {
        if (!connectionError) {
            connectionError = true;
            document.getElementById('connection-status').classList.add('show');
        }
    }
    
    function hideConnectionError() {
        if (connectionError) {
            connectionError = false;
            document.getElementById('connection-status').classList.remove('show');
        }
    }

    function updateMqttWarnings() {
        try {
            const noServers = !statusData || !Number(statusData.mqtt_servers_count || 0);
            const notConnected = !noServers && (statusData && statusData.mqtt_connected === false);
            const elNoServers = document.getElementById('mqtt-no-servers');
            const elNoConn = document.getElementById('mqtt-no-connection');
            if (noServers && !mqttNoServers) { mqttNoServers = true; elNoServers.classList.add('show'); }
            if (!noServers && mqttNoServers) { mqttNoServers = false; elNoServers.classList.remove('show'); }
            if (notConnected && !mqttNoConnection) { mqttNoConnection = true; elNoConn.classList.add('show'); }
            if (!notConnected && mqttNoConnection) { mqttNoConnection = false; elNoConn.classList.remove('show'); }
        } catch (e) {}
    }
    
    function formatSeconds(total) {
        const sec = Math.max(0, Math.floor(total));
        const mm = String(Math.floor(sec / 60)).padStart(2, '0');
        const ss = String(sec % 60).padStart(2, '0');
        return `${mm}:${ss}`;
    }

    function getStatusText(group) {
        if (group.status === 'watering' && group.current_zone) {
            const src = String(group.current_zone_source || '').toLowerCase();
            // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–≤–∞ —Å—Ç–∞—Ç—É—Å–∞: –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –ª–∏–±–æ –≤—Ä—É—á–Ω—É—é (–≤–∫–ª—é—á–∞—è —É–¥–∞–ª–µ–Ω–Ω–æ)
            if (src === 'schedule') return '–ü–æ–ª–∏–≤ - –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–∏–≤–∞–µ—Ç—Å—è(–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)';
            return '–ü–æ–ª–∏–≤ - –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–∏–≤–∞–µ—Ç—Å—è(–∑–∞–ø—É—â–µ–Ω–æ –≤—Ä—É—á–Ω—É—é)';
        }
        switch (group.status) {
            case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ - –≥–æ—Ç–æ–≤ –∫ –ø–æ–ª–∏–≤—É';
            case 'error': return '–û—à–∏–±–∫–∞ - –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π';
            case 'postponed': {
                const r = (group.postpone_reason || '').toString();
                if (r === 'rain') return '–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –∏–∑ –∑–∞ –¥–æ–∂–¥—è';
                if (r === 'manual') return '–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                if (r === 'emergency') return '–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω –∏–∑ –∑–∞ –∞–≤–∞—Ä–∏–∏';
                return '–û—Ç–ª–æ–∂–µ–Ω–æ - –ø–æ–ª–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω';
            }
            default: return '–û–∂–∏–¥–∞–Ω–∏–µ - –≥–æ—Ç–æ–≤ –∫ –ø–æ–ª–∏–≤—É';
        }
    }

    async function initGroupTimer(group) {
        const span = document.getElementById(`group-timer-${group.id}`);
        if (!span) return;
        try {
            const res = await fetch(`/api/zones/${group.current_zone}/watering-time?ts=${Date.now()}`, { cache: 'no-store' });
            const data = await res.json();
            if (data && data.success && data.is_watering) {
                span.dataset.remainingSeconds = String(data.remaining_seconds ?? (data.remaining_time * 60));
                span.textContent = formatSeconds(Number(span.dataset.remainingSeconds));
            } else {
                span.dataset.remainingSeconds = '';
                span.textContent = '--:--';
            }
        } catch (e) {
            span.textContent = '--:--';
        }
    }
    
    async function updateStatusDisplay() {
        if (!statusData) return;
        updateDateTime();
        // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–≤–ª–∞–∂–Ω–æ—Å—Ç—å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞—Ç—á–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã
        const tb = document.getElementById('temp-box');
        const hb = document.getElementById('hum-box');
        const tv = document.getElementById('temp-value');
        const hv = document.getElementById('hum-value');
        if (statusData.temperature === null || typeof statusData.temperature === 'undefined') {
            tb.style.display = 'none';
        } else {
            tb.style.display = 'inline-block';
            tv.textContent = (statusData.temperature === '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') ? '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' : String(statusData.temperature);
        }
        if (statusData.humidity === null || typeof statusData.humidity === 'undefined') {
            hb.style.display = 'none';
        } else {
            hb.style.display = 'inline-block';
            hv.textContent = (statusData.humidity === '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') ? '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' : String(statusData.humidity);
        }
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞ –¥–æ–∂–¥—è: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω
        (function(){
            const rb = document.getElementById('rain-box');
            const rv = document.getElementById('rain-value');
            const enabled = !!(statusData && statusData.rain_enabled);
            if (!enabled) {
                rb.style.display = 'none';
                return;
            }
            rb.style.display = 'inline-block';
            const s = String(statusData.rain_sensor || '').toLowerCase();
            rv.textContent = (s.indexOf('–∏–¥—ë—Ç –¥–æ–∂–¥') !== -1 || s.indexOf('–∏–¥–µ—Ç –¥–æ–∂–¥') !== -1) ? '–¥–æ–∂–¥—å –∏–¥–µ—Ç' : '–Ω–µ—Ç –¥–æ–∂–¥—è';
        })();

        // –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–±–Ω–∏–∫: –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö", –æ–ø—Ä–∞—à–∏–≤–∞–µ–º /api/env —á–∞—â–µ (–¥–æ 10 –ø–æ–ø—ã—Ç–æ–∫)
        if ((tv.textContent === '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' || hv.textContent === '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') && !envProbeTimer) {
            envProbeAttempts = 0;
            envProbeTimer = setInterval(async () => {
                try {
                    envProbeAttempts += 1;
                    const resp = await fetch(`/api/env?ts=${Date.now()}`, { cache: 'no-store' });
                    const js = await resp.json();
                    const val = js && js.values ? js.values : {};
                    if (typeof val.temp !== 'undefined' && val.temp !== null) {
                        tb.style.display = 'inline-block';
                        tv.textContent = String(val.temp);
                    }
                    if (typeof val.hum !== 'undefined' && val.hum !== null) {
                        hb.style.display = 'inline-block';
                        hv.textContent = String(val.hum);
                    }
                    if (tv.textContent !== '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' && hv.textContent !== '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö') {
                        clearInterval(envProbeTimer); envProbeTimer = null;
                    }
                    if (envProbeAttempts >= 10) { clearInterval(envProbeTimer); envProbeTimer = null; }
                } catch (e) {
                    if (envProbeAttempts >= 10) { clearInterval(envProbeTimer); envProbeTimer = null; }
                }
            }, 1000);
        }
        const container = document.getElementById('groups-container');
        container.innerHTML = '';
        const resumeBtn = document.getElementById('resume-btn');
        if (statusData.emergency_stop) { resumeBtn.style.display = 'inline-block'; } else { resumeBtn.style.display = 'none'; }
        for (const group of statusData.groups) {
            const card = document.createElement('div');
            const flowActive = group.status === 'watering' && Math.random() > 0.3;
            card.className = `card ${group.status} ${flowActive ? 'flow-active' : ''}`;
            const statusText = getStatusText(group);
            // –î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –ø—Ä–∏ –ø–æ–ª–∏–≤–µ ‚Äî –∑–æ–Ω–∞ –∏ —Ç–∞–π–º–µ—Ä; –ø—Ä–∏ –æ—Ç–ª–æ–∂–∫–µ ‚Äî –¥–∞—Ç–∞/–≤—Ä–µ–º—è; –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏; –∏–Ω–∞—á–µ ‚Äî '‚Äî'
            let extraText = '‚Äî';
            if (group.status === 'watering' && group.current_zone) {
                extraText = `–ó–æ–Ω–∞ ${group.current_zone}: –æ—Å—Ç–∞–ª–æ—Å—å <span class="group-timer" id="group-timer-${group.id}" data-group-id="${group.id}" data-zone-id="${group.current_zone}" data-remaining-seconds="">--:--</span>`;
            } else if (group.status === 'postponed' && group.postpone_until) {
                const pu = String(group.postpone_until);
                const reason = String(group.postpone_reason || '').toLowerCase();
                if (reason === 'emergency' || pu.trim().toLowerCase().startsWith('–¥–æ ')) {
                    extraText = pu;
                } else {
                    extraText = `–î–æ ${pu}`;
                }
            } else if (group.status === 'error' && group.error_message) {
                extraText = String(group.error_message);
            }
            const groupButtons = `
                <div class="btn-group">
                    <button class="delay" onclick="delayGroup(${group.id}, 1)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 1 –¥–µ–Ω—å</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 2)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 2 –¥–Ω—è</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 3)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 3 –¥–Ω—è</button>
                    ${group.status === 'postponed' && group.postpone_until && !statusData.emergency_stop ? `<button class="cancel-postpone" onclick="cancelPostpone(${group.id})">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</button>` : ''}
                </div>
                <div class="btn-group">
                    <button class="continue-group" onclick="startGroupFromFirst(${group.id})">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                    <button class="stop-group" onclick="stopGroup(${group.id})">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                </div>`;
            card.innerHTML = `
                <div class="group-header">${group.name}</div>
                <div id="group-status-${group.id}">${statusText}</div>
                <div class="postpone-until">${extraText}</div>
                ${groupButtons}
            `;
            card.id = `group-card-${group.id}`;
            container.appendChild(card);
            if (group.status === 'watering' && group.current_zone) {
                initGroupTimer(group);
            }
        }
    }

    function tickCountdowns() {
        const spans = document.querySelectorAll('.group-timer');
        spans.forEach(span => {
            const val = span.dataset.remainingSeconds;
            if (!val) return;
            let sec = Number(val);
            if (Number.isNaN(sec) || sec <= 0) {
                span.textContent = '00:00';
                span.dataset.remainingSeconds = '';
                // –ü–æ–ø—Ä–æ—Å–∏–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø—ã –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –µ—ë –∫–∞—Ä—Ç–æ—á–∫—É –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const gid = span.dataset.groupId;
                if (gid) refreshSingleGroup(parseInt(gid, 10));
                return;
            }
            sec = sec - 1;
            span.dataset.remainingSeconds = String(sec);
            span.textContent = formatSeconds(sec);
        });
    }

    async function refreshSingleGroup(groupId) {
        try {
            const resp = await fetch(`/api/status?ts=${Date.now()}`, {cache: 'no-store'});
            const data = await resp.json();
            if (!data || !data.groups) return;
            // –û–±–Ω–æ–≤–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å–∞, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏/—É—Å–ª–æ–≤–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
            statusData = data;
            const group = (data.groups || []).find(g => String(g.id) === String(groupId));
            if (!group) return;
            const card = document.getElementById(`group-card-${group.id}`);
            if (!card) return;
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–±–µ—Ä–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º
            const flowActive = group.status === 'watering' && Math.random() > 0.3;
            card.className = `card ${group.status} ${flowActive ? 'flow-active' : ''}`;
            const statusText = getStatusText(group);
            let extraText2 = '‚Äî';
            if (group.status === 'watering' && group.current_zone) {
                extraText2 = `–ó–æ–Ω–∞ ${group.current_zone}: –æ—Å—Ç–∞–ª–æ—Å—å <span class="group-timer" id="group-timer-${group.id}" data-group-id="${group.id}" data-zone-id="${group.current_zone}" data-remaining-seconds="">--:--</span>`;
            } else if (group.status === 'postponed' && group.postpone_until) {
                const pu2 = String(group.postpone_until);
                const reason2 = String(group.postpone_reason || '').toLowerCase();
                if (reason2 === 'emergency' || pu2.trim().toLowerCase().startsWith('–¥–æ ')) {
                    extraText2 = pu2;
                } else {
                    extraText2 = `–î–æ ${pu2}`;
                }
            } else if (group.status === 'error' && group.error_message) {
                extraText2 = String(group.error_message);
            }
            const groupButtons = `
                <div class="btn-group">
                    <button class="delay" onclick="delayGroup(${group.id}, 1)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 1 –¥–µ–Ω—å</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 2)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 2 –¥–Ω—è</button>
                    <button class="delay" onclick="delayGroup(${group.id}, 3)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –Ω–∞ 3 –¥–Ω—è</button>
                    ${group.status === 'postponed' && group.postpone_until && !statusData.emergency_stop ? `<button class="cancel-postpone" onclick="cancelPostpone(${group.id})">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</button>` : ''}
                </div>
                <div class="btn-group">
                    <button class="continue-group" onclick="startGroupFromFirst(${group.id})">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                    <button class="stop-group" onclick="stopGroup(${group.id})">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã</button>
                </div>`;
            card.innerHTML = `
                <div class="group-header">${group.name}</div>
                <div id="group-status-${group.id}">${statusText}</div>
                <div class="postpone-until">${extraText2}</div>
                ${groupButtons}
            `;
            if (group.status === 'watering' && group.current_zone) {
                initGroupTimer(group);
            }
        } catch (e) {}
    }

    // –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è MQTT —á–µ—Ä–µ–∑ SSE –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∏–∂–µ –≤ DOMContentLoaded)

    function handleZoneUpdateFromSse(zoneId, newState) {
        try {
            // –û–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ zonesData, —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –∑–æ–Ω –±—ã–ª–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π
            const z = zonesData.find(x => Number(x.id) === Number(zoneId));
            if (z) z.state = newState;
            // –ù–∞–π–¥—ë–º –≥—Ä—É–ø–ø—É –∏ –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –µ—ë –∫–∞—Ä—Ç–æ—á–∫—É
            const groupId = z ? z.group_id : null;
            if (groupId) {
                refreshSingleGroup(groupId);
            } else {
                // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç–∞—Ç—É—Å —Ü–µ–ª–∏–∫–æ–º –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                loadStatusData();
            }
        } catch (e) {}
    }
    
    async function updateZonesTable() {
        const tbody = document.getElementById('zones-table-body');
        const countSpan = document.getElementById('zones-count');
        
        tbody.innerHTML = '';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–æ–Ω—ã, –∏—Å–∫–ª—é—á–∞—è –≥—Ä—É–ø–ø—É 999 (–ë–ï–ó –ü–û–õ–ò–í–ê)
        const filteredZones = zonesData.filter(zone => zone.group_id !== 999);
        
        countSpan.textContent = filteredZones.length;
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —á–∏—Å–µ–ª
        const groups = await api.get('/api/groups');
        const groupNameById = {};
        groups.forEach(g => { groupNameById[g.id] = g.name; });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤ –æ–¥–Ω–∏–º –±–∞—Ç—á–µ–º (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ WB)
        let nextWateringData = [];
        try {
            const response = await fetch('/api/zones/next-watering-bulk', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ zone_ids: filteredZones.map(z=>z.id) })
            });
            const bulk = await response.json();
            nextWateringData = (bulk && bulk.items) ? bulk.items : [];
        } catch (e) {
            nextWateringData = [];
        }
        
        const frag = document.createDocumentFragment();
        filteredZones.forEach(zone => {
            let nextWatering = '‚Äî';
            if (statusData.emergency_stop) {
                nextWatering = '–î–æ –æ—Ç–º–µ–Ω—ã –∞–≤–∞—Ä–∏–∏';
            } else {
                const item = nextWateringData.find(x => x.zone_id === zone.id) || {};
                const nextDT = item.next_datetime;
                if (nextDT) {
                    nextWatering = String(nextDT).replace('T',' ').slice(0,19);
                } else if (item.next_watering === '–ù–∏–∫–æ–≥–¥–∞') {
                    nextWatering = '–ù–∏–∫–æ–≥–¥–∞';
                }
            }
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td><span class="indicator ${zone.state}"></span></td>
                <td>${zone.id}</td>
                <td><button class="zone-start-btn" onclick="${statusData.emergency_stop ? `showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')` : `startOrStopZone(${zone.id}, '${zone.state}')`}">${zone.state==='on' ? '‚èπ' : '‚ñ∂'}</button></td>
                <td>${zone.name}</td>
                <td>${zone.icon}</td>
                <td>${zone.duration} –º–∏–Ω</td>
                <td>${groupNameById[zone.group_id] || zone.group_id}</td>
                <td class="hide-mobile col-last-watering">‚Äî</td>
                <td class="col-next" data-label="–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤">${nextWatering}</td>
                <td class="col-photo" data-label="–§–æ—Ç–æ">
                    <div class="zone-photo">
                        ${zone.photo_path ? 
                            `<img src="/api/zones/${zone.id}/photo" alt="–§–æ—Ç–æ –∑–æ–Ω—ã ${zone.id}" onclick="showPhotoModal('/api/zones/${zone.id}/photo')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">` :
                            `<div class="no-photo" title="–ù–µ—Ç —Ñ–æ—Ç–æ">üì∑</div>`
                        }
                    </div>
                </td>
            `;
            
            frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        // Signal render complete for perf
        try{ window.dispatchEvent(new CustomEvent('zones-rendered')); }catch(e){}
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    async function delayGroup(groupId, days) {
        try {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≥—Ä—É–ø–ø—ã –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            const card = document.getElementById(`group-card-${groupId}`);
            if (card) {
                const buttons = card.querySelectorAll('button');
                buttons.forEach(b=>b.disabled=true);
            }
            const response = await api.post('/api/postpone', {
                group_id: groupId,
                days: days,
                action: 'postpone'
            });
            
            if (response.success) {
                showNotification(response.message, 'success');
                // –¢–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≥—Ä—É–ø–ø—ã –∏ —Å—Ç—Ä–æ–∫–∏ –∑–æ–Ω —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                await refreshSingleGroup(groupId);
                await refreshZonesRowsForGroup(groupId);
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ª–æ–∂–∫–µ –ø–æ–ª–∏–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ª–æ–∂–∫–µ –ø–æ–ª–∏–≤–∞', 'error');
        } finally {
            const card = document.getElementById(`group-card-${groupId}`);
            if (card) {
                const buttons = card.querySelectorAll('button');
                buttons.forEach(b=>b.disabled=false);
            }
        }
    }
    
    async function cancelPostpone(groupId) {
        try {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≥—Ä—É–ø–ø—ã –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            const card = document.getElementById(`group-card-${groupId}`);
            if (card) {
                const buttons = card.querySelectorAll('button');
                buttons.forEach(b=>b.disabled=true);
            }
            const response = await api.post('/api/postpone', {
                group_id: groupId,
                action: 'cancel'
            });
            
            if (response.success) {
                showNotification(response.message, 'success');
                // –¢–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≥—Ä—É–ø–ø—ã –∏ —Å—Ç—Ä–æ–∫–∏ –∑–æ–Ω —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                await refreshSingleGroup(groupId);
                await refreshZonesRowsForGroup(groupId);
            } else {
                showNotification(response.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞', 'error');
        } finally {
            const card = document.getElementById(`group-card-${groupId}`);
            if (card) {
                const buttons = card.querySelectorAll('button');
                buttons.forEach(b=>b.disabled=false);
            }
        }
    }
    
    async function startGroupFromFirst(groupId) {
        try {
            const grp = (statusData && statusData.groups ? statusData.groups : []).find(g => String(g.id) === String(groupId));
            const gname = grp && grp.name ? grp.name : groupId;
            const res = await fetch(`/api/groups/${groupId}/start-from-first`, { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(`–ì—Ä—É–ø–ø–∞ "${gname}": ${data.message || '–∑–∞–ø—É—â–µ–Ω–∞'}`, 'success');
                await loadStatusData();
                await loadZonesData();
            } else {
                showNotification(data.message || `–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≥—Ä—É–ø–ø—ã "${gname}"`, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–ª–∏–≤–∞ –≥—Ä—É–ø–ø—ã', 'error');
        }
    }
    
    async function stopGroup(groupId) {
        try {
            const grp = (statusData && statusData.groups ? statusData.groups : []).find(g => String(g.id) === String(groupId));
            const gname = grp && grp.name ? grp.name : groupId;
            if (!confirm(`–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã "${gname}"?`)) return;
        } catch (e) {
            if (!confirm(`–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≤ –≥—Ä—É–ø–ø—ã ${groupId}?`)) return;
        }
        
        try {
            const res = await fetch(`/api/groups/${groupId}/stop`, { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥—Ä—É–ø–ø—ã', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≥—Ä—É–ø–ø—ã', 'error');
        }
    }
    
    async function startOrStopZone(zoneId, currentState) {
        try {
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É –∑–æ–Ω—ã
            const idx = zonesData.findIndex(z => z.id === zoneId);
            if (idx < 0) return;
            const zone = zonesData[idx];
            const groupId = zone.group_id;
            const wantOn = currentState !== 'on';
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI: –ø–µ—Ä–µ–∫–ª—é—á–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ä–∞–∑—É
            zonesData[idx].state = wantOn ? 'on' : 'off';
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–æ–∫—É –∑–æ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –∫–Ω–æ–ø–∫–∞)
            try {
                const tbody = document.getElementById('zones-table-body');
                if (tbody) {
                    let row = tbody.querySelector(`tr[data-zone-id="${zoneId}"]`);
                    if (!row) {
                        const rows = tbody.querySelectorAll('tr');
                        rows.forEach(r => {
                            const cells = r.querySelectorAll('td');
                            if (cells.length > 1 && Number(cells[1].textContent.trim()) === zoneId) {
                                row = r;
                            }
                        });
                    }
                    if (row) {
                        const ind = row.querySelector('.indicator');
                        if (ind) { ind.classList.remove('on','off'); ind.classList.add(wantOn ? 'on' : 'off'); }
                        const btn = row.querySelector('.zone-start-btn');
                        if (btn) {
                            btn.textContent = wantOn ? '‚èπ' : '‚ñ∂';
                            const emergency = !!(statusData && statusData.emergency_stop);
                            const action = emergency ? "showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')" : ("startOrStopZone(" + zoneId + ", '" + (wantOn ? 'on' : 'off') + "')");
                            btn.setAttribute('onclick', action);
                        }
                    }
                }
            } catch (e) {}
            if (groupId) {
                // –û–±–Ω–æ–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –≥—Ä—É–ø–ø—ã –∏ —Å—Ç—Ä–æ–∫–∏ –∑–æ–Ω —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                refreshSingleGroup(groupId);
                refreshZonesRowsForGroup(groupId);
            }
            const url = wantOn ? `/api/zones/${zoneId}/mqtt/start` : `/api/zones/${zoneId}/mqtt/stop`;
            const res = await fetch(url, { method: 'POST' });
            let data = null;
            try { data = await res.json(); } catch(e) { data = null; }
            if (res.ok && data && data.success) {
                showNotification(data.message || (wantOn?'–ó–æ–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞':'–ó–æ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'), 'success');
                // –ü–æ–¥—Ç—è–Ω–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                await refreshAllUI();
            } else {
                const msg = (data && data.message) ? data.message : (wantOn?'–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–æ–Ω—ã':'–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–æ–Ω—ã');
                showNotification(msg, 'error');
                // –û—Ç–∫–∞—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                zonesData[idx].state = currentState;
                await refreshAllUI();
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–æ–Ω–æ–π', 'error');
        }
    }
    
    async function emergencyStop() {
        if (!confirm('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–æ–Ω?')) return;
        
        try {
            const res = await fetch('/api/emergency-stop', { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'warning');
                await loadStatusData();
                await loadZonesData();
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–≤–Ω–æ
                document.getElementById('resume-btn').style.display = 'inline-block';
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ', 'error');
        }
    }

    async function resumeSchedule() {
        try {
            const res = await fetch('/api/emergency-resume', { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showNotification(data.message, 'success');
                await loadStatusData();
                await loadZonesData();
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('resume-btn').style.display = 'none';
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≤–∞', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≤–∞', 'error');
        }
    }

    async function refreshAllUI() {
        try {
            await loadStatusData();
            await loadZonesData();
        } catch (e) {}
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    function showPhotoModal(photoUrl) {
        const img = document.getElementById('photoModalImg');
        img.src = photoUrl;
        const modal = document.getElementById('photoModal');
        modal.style.display = 'flex'; // —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ flex
    }

    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å—Ä–∞–∑—É
        updateDateTime();
        
        loadStatusData();
        loadZonesData();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateDateTime, 1000);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            loadStatusData();
            loadZonesData();
        }, 30000);
        setInterval(tickCountdowns, 1000);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        document.getElementById('emergency-btn').addEventListener('click', emergencyStop);
        document.getElementById('resume-btn').addEventListener('click', resumeSchedule);
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å—ã –∑–æ–Ω —á–µ—Ä–µ–∑ SSE
        try {
            const es = new EventSource('/api/mqtt/zones-sse');
            es.onmessage = (ev)=>{
                try{
                    const data = JSON.parse(ev.data);
                    const idx = zonesData.findIndex(z=>z.id===data.zone_id);
                    if (idx>=0){
                        zonesData[idx].state = data.state;
                        // –û–±–Ω–æ–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø—ã, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ "–ü–æ–ª–∏–≤ ‚Äî –ó–æ–Ω–∞ X" —Å–º–µ–Ω–∏–ª–∞—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                        const gid = zonesData[idx].group_id;
                        if (gid) { refreshSingleGroup(gid); }
                        const tbody = document.getElementById('zones-table-body');
                        if (tbody){
                            let row = tbody.querySelector(`tr[data-zone-id="${data.zone_id}"]`);
                            if (!row) {
                                const rows = tbody.querySelectorAll('tr');
                                rows.forEach(r=>{
                                    const cells = r.querySelectorAll('td');
                                    if (cells.length>1 && Number(cells[1].textContent.trim())===data.zone_id){ row = r; }
                                });
                            }
                            if (row){
                                const ind = row.querySelector('.indicator');
                                if (ind){ ind.classList.remove('on','off'); ind.classList.add(data.state); }
                                const btn = row.querySelector('.zone-start-btn');
                                if (btn){
                                    btn.textContent = data.state==='on'?'‚èπ':'‚ñ∂';
                                    const emergency = !!(statusData && statusData.emergency_stop);
                                    const action = emergency ? "showNotification('–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.', 'warning')" : ("startOrStopZone(" + data.zone_id + ", '" + data.state + "')");
                                    btn.setAttribute('onclick', action);
                                }
                            }
                        }
                    }
                }catch(e){}
            };
        } catch (e) {}
    });

    // –¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –∑–æ–Ω –≥—Ä—É–ø–ø—ã (–±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã)
    async function refreshZonesRowsForGroup(groupId) {
        try {
            const tbody = document.getElementById('zones-table-body');
            if (!tbody) return;
            const zonesForGroup = (zonesData || []).filter(z => String(z.group_id) === String(groupId));
            const promises = zonesForGroup.map(async (zone) => {
                try {
                    const resp = await fetch(`/api/zones/${zone.id}/next-watering`, { cache: 'no-store' });
                    const data = await resp.json();
                    let nextText = '‚Äî';
                    if (data && data.next_datetime) {
                        nextText = String(data.next_datetime).replace('T',' ').slice(0,19);
                    } else if (data && data.next_watering === '–ù–∏–∫–æ–≥–¥–∞') {
                        nextText = '–ù–∏–∫–æ–≥–¥–∞';
                    }
                    // –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É –∑–æ–Ω—ã –ø–æ –µ—ë ‚Ññ (–≤—Ç–æ—Ä–∞—è –∫–æ–ª–æ–Ω–∫–∞)
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 9) {
                            const idCell = cells[1];
                            if (idCell && String(idCell.textContent.trim()) === String(zone.id)) {
                                // –ö–æ–ª–æ–Ω–∫–∞ "–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤" ‚Äî –¥–µ–≤—è—Ç–∞—è (index 8)
                                const nextCell = cells[8];
                                if (nextCell) nextCell.textContent = nextText;
                            }
                        }
                    });
                } catch (e) { /* ignore single zone error */ }
            });
            await Promise.all(promises);
        } catch (e) { /* ignore group update error */ }
    }
</script>
{% endblock %}
