### MQTT Relay Emulator (wb-mr6cv3)

Эмулятор «реле» для отработки интеграции автополива с Wiren Board.

- Эмулирует 5 устройств `wb-mr6cv3_101..105` с каналами `K1..K6`
- Подтверждает состояние в тот же топик, что получил команду ('1'/'0')
- Веб‑интерфейс с лампами (зелёная/красная) и кнопками Вкл/Выкл
- Лог‑панель на странице
- Фолбэк: если нет MQTT брокера, команды из UI сразу применяются локально

#### Топики
/devices/wb-mr6cv3_101/controls/K1..K6 … /devices/wb-mr6cv3_105/controls/K1..K6

#### Переменные окружения
- TEST_MQTT_HOST (default 127.0.0.1)
- TEST_MQTT_PORT (default 1883)
- EMULATOR_HTTP_PORT (default 5055)
- EMULATOR_DEVICE_IDS (default 101,102,103,104,105)
- EMULATOR_CHANNELS (default 6)
- EMULATOR_ECHO_DELAY_SECONDS (default 0.05)

#### Запуск
1) Запустите брокер MQTT (любой из вариантов):
- Docker: запустите Docker Desktop; скрипт сам поднимет контейнер eclipse-mosquitto:2
- Локально: установите mosquitto и запустите через скрипт
- Внешний брокер (WB): экспортируйте TEST_MQTT_HOST=<ip>

2) Скрипт старта:
```bash
./tool/MQTT_emulator/start.sh
```

UI: http://localhost:5055

#### Как это работает
- UI (Flask) → POST /api/toggle → публикует '1'/'0' в топик зоны
- «Устройство» (MQTT‑клиент) подписано на все топики и при получении команды подтверждает тем же значением
- UI опрашивает /api/state и показывает фактическое состояние; логи принимает с /api/logs
- Если брокер недоступен, включается офлайн‑режим: состояние применяется локально (без MQTT)

#### Брокер через Docker
Минимальный конфиг mosquitto:
- listener 1883 0.0.0.0
- allow_anonymous true
- persistence false

#### Примечания
- QoS=0, retain=False. Эмулятор опционально эмулирует задержку включения.
- Один топик может соответствовать нескольким зонам — в этом случае подтверждение по топику применится ко всем связанным зонам.
